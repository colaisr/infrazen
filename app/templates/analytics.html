{% extends "base.html" %}

{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ - InfraZen{% endblock %}

{% block page_title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤{% endblock %}
{% block page_subtitle %}–î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –æ–±–ª–∞—á–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤{% endblock %}

{% block header_actions %}
<button class="btn btn-primary analytics-export-btn">
    <i class="fa-solid fa-download"></i>
    –≠–∫—Å–ø–æ—Ä—Ç –æ—Ç—á–µ—Ç–∞
</button>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/analytics.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/features/analytics-charts.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/analytics-cards.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/chat-drawer.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/components/chat-messages.css') }}">
<style>
/* Force light theme for analytics page - override any dark mode */
.analytics-page {
    background-color: #ffffff !important;
    color: #1f2937 !important;
}

.analytics-page * {
    background-color: inherit !important;
    color: inherit !important;
}

/* Fix KPI card values to prevent line breaks */
.analytics-kpi-value {
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    font-size: 1.5rem !important;
    font-weight: 700 !important;
    line-height: 1.2 !important;
}

.analytics-kpi-subtitle {
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    font-size: 0.875rem !important;
    color: #6b7280 !important;
    margin-top: 0.5rem !important;
}

/* Override any inherited dark theme styles */
body {
    background-color: #ffffff !important;
    color: #1f2937 !important;
}

/* Ensure all cards and containers are light */
.analytics-kpi-card,
.analytics-chart-container,
.analytics-provider-chart {
    background-color: #ffffff !important;
    color: #1f2937 !important;
    border-color: #e5e7eb !important;
}

/* Force light theme for all text elements */
.analytics-title,
.analytics-kpi-value,
.analytics-chart-title {
    color: #1f2937 !important;
}

.analytics-subtitle,
.analytics-kpi-subtitle,
.analytics-chart-subtitle {
    color: #6b7280 !important;
}

.analytics-chat-trigger {
    display: flex;
    justify-content: flex-end;
    margin-bottom: 1rem;
}

.analytics-chat-chip {
    border: none;
    background: #eef2ff;
    color: #1f2937;
    padding: 0.5rem 1.1rem;
    border-radius: 999px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    box-shadow: 0 4px 12px rgba(79, 70, 229, 0.12);
    transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
}

.analytics-chat-chip:hover {
    background: #e0e7ff;
    transform: translateY(-1px);
    box-shadow: 0 6px 16px rgba(79, 70, 229, 0.16);
}

.analytics-chat-chip:focus {
    outline: 2px solid #4338ca;
    outline-offset: 2px;
}
</style>
{% endblock %}

{% block content %}
<div class="analytics-page">
    <script>
    window.INFRAZEN_DATA = window.INFRAZEN_DATA || {};
    window.INFRAZEN_DATA.agentServiceUrl = '{{ agent_service_url }}';
    window.INFRAZEN_DATA.enableAgentChat = {{ 'true' if enable_ai_recommendations else 'false' }};
    </script>

    <!-- Executive Summary - 4 KPI Cards -->
    <div class="analytics-summary">
        <div class="analytics-chat-trigger">
            <button type="button" id="analyticsChatTrigger" class="analytics-chat-chip">
                <span>üí¨</span>
                <span>–û–±—Å—É–¥–∏—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</span>
            </button>
        </div>
        <div class="analytics-kpi-grid">
            <div class="analytics-kpi-card">
                <div class="analytics-kpi-header">
                    <h3 class="analytics-kpi-title">–û–±—â–∏–µ —Ä–∞—Å—Ö–æ–¥—ã</h3>
                    <div class="analytics-kpi-trend analytics-trend-up">
                        <i class="fa-solid fa-arrow-up"></i>
                        <span>+5.2%</span>
                    </div>
                </div>
                <div class="analytics-kpi-value">
                    {% if latest_complete_sync %}
                        {{ "{:,.2f}".format(latest_complete_sync.total_monthly_cost) }} ‚ÇΩ/–º–µ—Å—è—Ü
                    {% else %}
                        0.00 ‚ÇΩ/–º–µ—Å—è—Ü
                    {% endif %}
                </div>
                <div class="analytics-kpi-subtitle">
                    {% if latest_complete_sync %}
                        {{ "{:,.2f}".format(latest_complete_sync.total_daily_cost) }} ‚ÇΩ/–¥–µ–Ω—å
                    {% else %}
                        0.00 ‚ÇΩ/–¥–µ–Ω—å
                    {% endif %}
                </div>
            </div>

            <div class="analytics-kpi-card">
                <div class="analytics-kpi-header">
                    <h3 class="analytics-kpi-title">–ê–∫—Ç–∏–≤–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã</h3>
                    <div class="analytics-kpi-trend analytics-trend-stable">
                        <i class="fa-solid fa-minus"></i>
                        <span>0%</span>
                    </div>
                </div>
                <div class="analytics-kpi-value">{{ active_resources_count }}</div>
                <div class="analytics-kpi-subtitle">—Ä–µ—Å—É—Ä—Å–æ–≤</div>
            </div>

            <div class="analytics-kpi-card">
                <div class="analytics-kpi-header">
                    <h3 class="analytics-kpi-title">–ü—Ä–æ–≤–∞–π–¥–µ—Ä—ã</h3>
                    <div class="analytics-kpi-trend analytics-trend-up">
                        <i class="fa-solid fa-arrow-up"></i>
                        <span>100%</span>
                    </div>
                </div>
                <div class="analytics-kpi-value">
                    {% if latest_complete_sync %}
                        {{ latest_complete_sync.successful_providers }}/{{ latest_complete_sync.total_providers_synced }}
                    {% else %}
                        0/0
                    {% endif %}
                </div>
                <div class="analytics-kpi-subtitle">—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ</div>
            </div>

            <div class="analytics-kpi-card">
                <div class="analytics-kpi-header">
                    <h3 class="analytics-kpi-title">–≠–∫–æ–Ω–æ–º–∏—è</h3>
                    <div class="analytics-kpi-trend analytics-trend-up">
                        <i class="fa-solid fa-arrow-up"></i>
                        <span>+0‚ÇΩ</span>
                    </div>
                </div>
                <div class="analytics-kpi-value">
                    {% set total_savings = implemented_recommendations|sum(attribute='estimated_monthly_savings') %}
                    {{ "%.2f"|format(total_savings) }} ‚ÇΩ/–º–µ—Å—è—Ü
                </div>
                <div class="analytics-kpi-subtitle">–æ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</div>
            </div>
        </div>
    </div>

    <!-- Main Spending Analysis Chart (Full Width) -->
    <div class="analytics-main-chart-section">
        <div class="analytics-chart-container analytics-main-chart">
            <div class="analytics-chart-header">
                <h2 class="analytics-chart-title">üìà –¢—Ä–µ–Ω–¥—ã —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø–æ –ø–æ–ª–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h2>
                <div class="analytics-chart-controls">
                    <div class="analytics-time-range">
                        <select class="analytics-time-selector">
                            <option value="7">7 –¥–Ω–µ–π</option>
                            <option value="30" selected>30 –¥–Ω–µ–π</option>
                            <option value="90">90 –¥–Ω–µ–π</option>
                            <option value="custom">–ù–∞—Å—Ç—Ä–æ–π–∫–∞</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="analytics-chart-content">
                <canvas id="mainSpendingChart" width="800" height="400"></canvas>
            </div>
        </div>
    </div>

    <!-- Secondary Analysis (2-Column Grid) -->
    <div class="analytics-secondary-section">
        <!-- Service Analysis & Provider Breakdown (2-Column) -->
        <div class="analytics-secondary-grid">
            <div class="analytics-chart-container">
                <div class="analytics-chart-header">
                    <h3 class="analytics-chart-title">–ê–Ω–∞–ª–∏–∑ —Å–µ—Ä–≤–∏—Å–æ–≤</h3>
                    <p class="analytics-chart-subtitle">–¢–µ–∫—É—â–∏–π —Å–Ω–∏–º–æ–∫</p>
                </div>
                <div class="analytics-chart-content">
                    <canvas id="serviceAnalysisChart" width="400" height="300"></canvas>
                </div>
            </div>

            <div class="analytics-chart-container">
                <div class="analytics-chart-header">
                    <h3 class="analytics-chart-title">–†–∞–∑–±–∏–≤–∫–∞ –ø–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º</h3>
                    <p class="analytics-chart-subtitle">–¢–µ–∫—É—â–∏–π —Å–Ω–∏–º–æ–∫</p>
                </div>
                <div class="analytics-chart-content">
                    <canvas id="providerBreakdownChart" width="400" height="300"></canvas>
                </div>
            </div>
        </div>

        <!-- Individual Provider Spending Charts (2-Column Grid) -->
        <div class="analytics-provider-charts-grid">
            {% for provider in providers %}
            <div class="analytics-chart-container analytics-provider-chart">
                <div class="analytics-chart-header">
                    <h3 class="analytics-chart-title">üìà {{ provider.connection_name }}</h3>
                    <div class="analytics-chart-controls">
                        <div class="analytics-time-range">
                            <select class="analytics-time-selector" data-provider="{{ provider.id }}">
                                <option value="7">7 –¥–Ω–µ–π</option>
                                <option value="30" selected>30 –¥–Ω–µ–π</option>
                                <option value="90">90 –¥–Ω–µ–π</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="analytics-chart-content">
                    <canvas id="providerTrendChart{{ provider.id }}" width="400" height="300"></canvas>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Implemented Recommendations (Full Width) -->
        <div class="analytics-chart-container analytics-full-width">
            <div class="analytics-chart-header">
                <h3 class="analytics-chart-title">–í–Ω–µ–¥—Ä–µ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                <div class="analytics-recommendations-summary">
                    <span class="analytics-summary-item">–í—Å–µ–≥–æ –≤–Ω–µ–¥—Ä–µ–Ω–æ: <strong>{{ implemented_recommendations|length }}</strong> —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</span>
                    <span class="analytics-summary-item">–û–±—â–∞—è —ç–∫–æ–Ω–æ–º–∏—è: <strong>{{ "%.2f"|format(implemented_recommendations|sum(attribute='estimated_monthly_savings')) }} ‚ÇΩ/–º–µ—Å—è—Ü</strong></span>
                </div>
            </div>
            <div class="analytics-recommendations-content">
                {% if implemented_recommendations %}
                    <div class="analytics-recommendations-list">
                        {% for rec in implemented_recommendations %}
                        <div class="analytics-recommendations-item">
                            <div class="analytics-recommendation-info">
                                <h4 class="analytics-recommendation-title">{{ rec.title }}</h4>
                                <p class="analytics-recommendation-description">{{ rec.description }}</p>
                                <span class="analytics-recommendation-date">
                                    –í–Ω–µ–¥—Ä–µ–Ω–æ: {{ rec.applied_at.strftime('%d.%m.%Y %H:%M') if rec.applied_at else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}
                                </span>
                            </div>
                            <div class="analytics-recommendation-savings">
                                <i class="fa-solid fa-ruble-sign"></i>
                                {{ "%.2f"|format(rec.estimated_monthly_savings) }} ‚ÇΩ/–º–µ—Å—è—Ü
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="analytics-recommendations-empty">
                        <i class="fa-solid fa-lightbulb analytics-empty-icon"></i>
                        <p class="analytics-empty-text">–ü–æ–∫–∞ –Ω–µ—Ç –≤–Ω–µ–¥—Ä–µ–Ω–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</p>
                        <p class="analytics-empty-subtext">–í–Ω–µ–¥—Ä–∏—Ç–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{{ url_for('static', filename='js/analytics.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat-drawer.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat-ui.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat-mock.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat-websocket.js') }}"></script>
<script src="{{ url_for('static', filename='js/chat-integration.js') }}"></script>
<script src="{{ url_for('static', filename='js/analytics-chat.js') }}"></script>
{% endblock %}
