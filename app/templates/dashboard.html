{% extends "base.html" %}

{% block title %}Дашборд - InfraZen FinOps Platform{% endblock %}

{% block page_title %}Обзор расходов - Мультиоблачная аналитика ваших ресурсов{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block header_actions %}
    <div class="header-actions">
        <select class="btn btn-secondary">
            <option>Последние 30 дней</option>
            <option>Последние 90 дней</option>
            <option>Последний год</option>
        </select>
        <button class="btn btn-secondary"><i class="fa-solid fa-arrows-rotate"></i><span>Обновить</span></button>
        <button class="btn btn-primary"><i class="fa-solid fa-download"></i><span>Экспорт</span></button>
    </div>
{% endblock %}

{% block content %}
<div class="dashboard-content">
    <section class="kpi-grid">
        <article class="kpi-card">
            <div class="kpi-card-header">
                <div>
                    <span class="kpi-label">Общие расходы</span>
                    {% if last_complete_sync and last_complete_sync.sync_status == 'success' %}
                        <div class="kpi-value">{{ "%.0f"|format(last_complete_sync.total_monthly_cost or 0) }} ₽</div>
                    {% else %}
                        <div class="kpi-value">{{ overview.kpis.total_expenses_rub | default(0) }} ₽</div>
                    {% endif %}
                </div>
                <div class="kpi-icon icon-expense"><i class="fa-solid fa-ruble-sign"></i></div>
            </div>
            <div class="kpi-footer">
                {% if last_complete_sync and last_complete_sync.sync_status == 'success' %}
                    <div class="kpi-trend trend-neutral">
                        <i class="fa-solid fa-calendar"></i> 
                        {{ "%.0f"|format((last_complete_sync.total_monthly_cost or 0) * 12) }} ₽/год
                    </div>
                {% elif is_demo_user %}
                    <div class="kpi-trend trend-down"><i class="fa-solid fa-arrow-down"></i> -12.5% за месяц</div>
                {% else %}
                    <div class="kpi-trend trend-neutral"><i class="fa-solid fa-minus"></i> 0% за месяц</div>
                {% endif %}
                <span class="kpi-subtext kpi-subtext-muted">Рублей</span>
            </div>
        </article>

        <article class="kpi-card">
            <div class="kpi-card-header">
                <div>
                    <span class="kpi-label">Потенциальная экономия</span>
                    <div class="kpi-value">{{ overview.kpis.potential_savings_rub | default(0) }} ₽</div>
                </div>
                <div class="kpi-icon icon-savings"><i class="fa-solid fa-piggy-bank"></i></div>
            </div>
            <div class="kpi-footer">
                <span class="kpi-subtext">{{ overview.kpis.savings_percentage | default(0) }}% от общих расходов</span>
            </div>
        </article>

        <article class="kpi-card">
            <div class="kpi-card-header">
                <div>
                    <span class="kpi-label">Активные ресурсы</span>
                    <div class="kpi-value">{{ overview.kpis.active_resources | default(0) }}</div>
                </div>
                <div class="kpi-icon icon-resources"><i class="fa-solid fa-box-open"></i></div>
            </div>
            <div class="kpi-footer">
                <a href="/resources" class="link-button">Управлять</a>
            </div>
        </article>

        <article class="kpi-card">
            <div class="kpi-card-header">
                <div>
                    <span class="kpi-label">Облачных провайдеров</span>
                    <div class="kpi-value">{{ overview.kpis.connected_providers | default(0) }}</div>
                </div>
                <div class="kpi-icon icon-providers"><i class="fa-solid fa-cloud"></i></div>
            </div>
            <div class="kpi-footer">
                <a href="/connections" class="link-button">Управлять</a>
            </div>
        </article>
    </section>

    <section class="dashboard-section">
        <div class="section-header">
            <div>
                <h2 class="section-title">Подключенные облачные провайдеры ({{ overview.providers|length }})</h2>
            </div>
        </div>
        <div class="provider-grid">
            {% for p in overview.providers %}
            <article class="provider-card">
                <header class="provider-header">
                    <span class="provider-badge {{ p.code | lower }}">{{ p.code | upper }}</span>
                    <span class="provider-name">{{ p.name }}</span>
                </header>
                <div class="provider-connection {% if p.status == 'connected' %}status-connected{% else %}status-disconnected{% endif %}">
                    <span class="status-indicator"></span>
                    {% if p.status == 'connected' %}Подключен{% else %}Отключен{% endif %}
                </div>
                <div class="provider-info">
                    <div class="provider-date">
                        <i class="fa-solid fa-calendar-plus"></i>
                        <span>Добавлен: {{ p.added_at }}</span>
                    </div>
                    <div class="provider-sync">
                        <i class="fa-solid fa-arrows-rotate"></i>
                        <span>Синхронизация: {{ p.last_sync or 'Никогда' }}</span>
                    </div>
                </div>
                <div class="provider-actions">
                    <button class="btn btn-outline btn-sm sync-btn" onclick="syncProvider('{{ p.id }}')">
                        <i class="fa-solid fa-arrows-rotate"></i>
                        <span>Синхронизировать</span>
                    </button>
                </div>
            </article>
            {% endfor %}
            <!-- Example card structure retained for reference -->
            <!--
            <article class="provider-card">
                <header class="provider-header">
                    <span class="provider-badge gcp">GCP</span>
                    <span class="provider-name">gcp</span>
                </header>
                <div class="provider-connection status-connected">
                    <span class="status-indicator"></span>
                    Подключен • Ожидает синхронизации
                </div>
                <div class="provider-status">Добавлен: 21.09.2025</div>
                <div class="provider-actions">
                    <button class="icon-button"><i class="fa-solid fa-gear"></i></button>
                    <button class="icon-button icon-danger"><i class="fa-solid fa-trash"></i></button>
                </div>
            </article>
            -->

        </div>
    </section>

    <section class="split-grid">
        <article class="dashboard-section">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Динамика расходов</h2>
                    <p class="section-meta">Анализ затрат за выбранный период</p>
                </div>
                <div class="filter-controls">
                    <button class="filter-pill active" data-days="30">30д</button>
                    <button class="filter-pill" data-days="90">90д</button>
                    <button class="filter-pill" data-days="365">1г</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="expenseDynamicsChart" width="400" height="200"></canvas>
            </div>
            <div class="summary-metrics">
                <div>
                    <div class="summary-label">ПРОШЛЫЙ МЕСЯЦ</div>
                    <div class="summary-value">₽{{ "%.0f"|format(expense_dynamics.last_month_cost) }}</div>
                </div>
                <div>
                    <div class="summary-label">ТЕКУЩИЙ МЕСЯЦ</div>
                    <div class="summary-value text-success">₽{{ "%.0f"|format(expense_dynamics.current_month_cost) }}</div>
                </div>
                <div>
                    <div class="summary-label">ЭКОНОМИЯ</div>
                    <div class="summary-value text-primary-blue">₽{{ "%.0f"|format(expense_dynamics.savings) }}</div>
                </div>
            </div>
        </article>

        <article class="dashboard-section">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Использование ресурсов</h2>
                    <p class="section-meta">Нагрузка и доступные мощности</p>
                </div>
                <a class="icon-button" href="#"><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
            </div>
            <div class="usage-list">
                <div class="usage-item">
                    <div class="usage-top">
                        <span>Процессоры (CPU)</span>
                        <span class="usage-percent">{{ overview.usage.cpu.percent }}%</span>
                    </div>
                    <div class="usage-bar">
                        <div class="usage-bar-fill" style="width: {{ overview.usage.cpu.percent }}%"></div>
                    </div>
                    <div class="usage-meta">
                        <span>Используется: {{ overview.usage.cpu.used_vcpu }} vCPU</span>
                        <span>Доступно: {{ overview.usage.cpu.available_vcpu }} vCPU</span>
                    </div>
                </div>
                <div class="usage-item">
                    <div class="usage-top">
                        <span>Память (RAM)</span>
                        <span class="usage-percent">{{ overview.usage.ram.percent }}%</span>
                    </div>
                    <div class="usage-bar">
                        <div class="usage-bar-fill" style="width: {{ overview.usage.ram.percent }}%"></div>
                    </div>
                    <div class="usage-meta">
                        <span>Используется: {{ overview.usage.ram.used_gb }} GB</span>
                        <span>Доступно: {{ overview.usage.ram.available_gb }} GB</span>
                    </div>
                </div>
                <div class="usage-item">
                    <div class="usage-top">
                        <span>Хранилище</span>
                        <span class="usage-percent">{{ overview.usage.storage.percent }}%</span>
                    </div>
                    <div class="usage-bar">
                        <div class="usage-bar-fill" style="width: {{ overview.usage.storage.percent }}%"></div>
                    </div>
                    <div class="usage-meta">
                        <span>Используется: {{ overview.usage.storage.used_tb }} TB</span>
                        <span>Доступно: {{ overview.usage.storage.available_tb }} TB</span>
                    </div>
                </div>
                <div class="usage-item">
                    <div class="usage-top">
                        <span>Сетевой трафик</span>
                        <span class="usage-percent">{{ overview.usage.network.percent }}%</span>
                    </div>
                    <div class="usage-bar">
                        <div class="usage-bar-fill" style="width: {{ overview.usage.network.percent }}%"></div>
                    </div>
                    <div class="usage-meta">
                        <span>Использовано: {{ overview.usage.network.used_tb }} TB</span>
                        <span>Лимит: {{ overview.usage.network.limit_tb }} TB</span>
                    </div>
                </div>
            </div>
        </article>
    </section>

    <section class="dashboard-section">
        <div class="section-header">
            <div>
                <h2 class="section-title">Рекомендации по оптимизации</h2>
                <p class="section-meta">Предложения для снижения расходов</p>
            </div>
            <div class="section-actions">
                <span class="section-meta">Потенциальная экономия: {{ overview.kpis.potential_savings_rub | default(0) }} ₽</span>
                <button class="icon-button"><i class="fa-solid fa-arrows-rotate"></i></button>
            </div>
        </div>
        {% if overview.recommendations %}
        <div class="recommendations-list">
            {% for r in overview.recommendations %}
            <div class="recommendation-item">
                <div class="rec-title">{{ r.title }}</div>
                <div class="rec-meta">{{ r.provider }} • Экономия: {{ r.estimated_savings_rub }} ₽ • Доверие: {{ (r.confidence * 100)|round(0) }}%</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon"><i class="fa-solid fa-lightbulb"></i></div>
            <div class="empty-state-title">Рекомендации не найдены</div>
            <div class="empty-state-text">Все ваши ресурсы оптимально настроены</div>
        </div>
        {% endif %}
    </section>

    <section class="dashboard-section">
        <div class="section-header">
            <div>
                <h2 class="section-title">Инвентарь ресурсов</h2>
                <p class="section-meta">Поиск и фильтрация по провайдерам</p>
            </div>
            <div class="section-actions">
                <span class="section-meta">0 из 0 ресурсов</span>
                <button class="icon-button"><i class="fa-solid fa-filter"></i></button>
            </div>
        </div>
        <div class="filter-row">
            <input class="form-control" type="text" placeholder="Поиск ресурсов...">
            <select class="form-control">
                <option>Все провайдеры</option>
            </select>
            <select class="form-control">
                <option>Все типы</option>
            </select>
            <select class="form-control">
                <option>Все статусы</option>
            </select>
        </div>
        {% if overview.resources %}
        <div class="resource-table">
            <div class="resource-table-header">
                <span>Ресурс</span>
                <span>Провайдер</span>
                <span>Тип</span>
                <span>Регион</span>
                <span>Статус</span>
                <span>Месячная стоимость</span>
            </div>
            {% for res in overview.resources %}
            <div class="resource-row">
                <span>{{ res.name }}</span>
                <span>{{ res.provider }}</span>
                <span>{{ res.type }}</span>
                <span>{{ res.region }}</span>
                <span>{{ res.status }}</span>
                <span>{{ res.monthly_cost_rub | default(0) }} ₽</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon"><i class="fa-solid fa-server"></i></div>
            <div class="empty-state-title">Нет ресурсов</div>
            <div class="empty-state-text">Подключите облачных провайдеров для отображения ресурсов</div>
        </div>
        {% endif %}
    </section>
</div>

<style>
/* Provider Info Layout */
.provider-info {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin: 0.75rem 0;
}

.provider-date,
.provider-sync {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.provider-date i,
.provider-sync i {
    color: var(--primary-blue);
    width: 14px;
    text-align: center;
}

.provider-sync {
    color: var(--text-primary);
}

.provider-actions {
    margin-top: 0.75rem;
    display: flex;
    justify-content: center;
}

.sync-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    transition: all 0.2s ease;
}

.sync-btn:hover {
    background: var(--primary-blue);
    color: white;
    border-color: var(--primary-blue);
}

.sync-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.sync-btn.loading {
    position: relative;
    color: transparent;
}

.sync-btn.loading::after {
    content: '';
    position: absolute;
    width: 16px;
    height: 16px;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
}

@keyframes spin {
    0% { transform: translate(-50%, -50%) rotate(0deg); }
    100% { transform: translate(-50%, -50%) rotate(360deg); }
}

/* Provider badge colors */
.provider-badge.beget {
    background: #8B4513;
    color: white;
}

.provider-badge.aws {
    background: #FF9900;
    color: white;
}

.provider-badge.azure {
    background: #0078D4;
    color: white;
}

.provider-badge.gcp {
    background: #4285F4;
    color: white;
}

.provider-badge.vk-cloud {
    background: #4CAF50;
    color: white;
}

/* Chart container styling */
.chart-container {
    height: 200px;
    margin: 1rem 0;
    position: relative;
}

.chart-container canvas {
    max-height: 200px;
}
</style>

<script>
// Expense Dynamics Chart
let expenseChart = null;

function initExpenseDynamicsChart() {
    const ctx = document.getElementById('expenseDynamicsChart');
    if (!ctx) return;
    
    // Get trend data from server
    const trendData = {{ expense_dynamics.trend_data | tojson }};
    
    const labels = trendData.map(item => item.date);
    const costs = trendData.map(item => item.cost);
    
    expenseChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
                datasets: [{
                    label: 'Месячные расходы (₽)',
                    data: costs,
                    borderColor: '#1e40af',
                    backgroundColor: 'rgba(30, 64, 175, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₽' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

// Time range filter functionality
function initTimeRangeFilters() {
    const filterButtons = document.querySelectorAll('.filter-controls .filter-pill');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from all buttons
            filterButtons.forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Get the selected days
            const days = parseInt(this.dataset.days);
            
            // Reload chart with new time range
            loadExpenseDynamicsData(days);
        });
    });
}

function loadExpenseDynamicsData(days) {
    // Show loading state
    if (expenseChart) {
        expenseChart.destroy();
    }
    
    const ctx = document.getElementById('expenseDynamicsChart');
    if (ctx && ctx.parentElement) {
        ctx.parentElement.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 200px;"><i class="fa-solid fa-spinner fa-spin"></i> Загрузка данных...</div>';
    }
    
    // Fetch new data based on time range
    fetch(`/api/analytics/main-trends?days=${days}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Restore canvas
                const container = document.querySelector('.chart-container');
                if (container) {
                    container.innerHTML = '<canvas id="expenseDynamicsChart" width="400" height="200"></canvas>';
                }
                
                // Create new chart with fetched data
                const newCtx = document.getElementById('expenseDynamicsChart');
                expenseChart = new Chart(newCtx, {
                    type: 'line',
                    data: data.data,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '₽' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                console.error('Failed to load expense dynamics data:', data.error);
            }
        })
        .catch(error => {
            console.error('Error loading expense dynamics data:', error);
        });
}

function syncProvider(providerId) {
    const button = event.target.closest('.sync-btn');
    const originalText = button.innerHTML;
    
    // Show loading state
    button.disabled = true;
    button.classList.add('loading');
    button.innerHTML = '<i class="fa-solid fa-arrows-rotate"></i><span>Синхронизация...</span>';
    
    // Simulate sync API call
    fetch(`/api/providers/beget/sync`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ provider_id: providerId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success state
            button.innerHTML = '<i class="fa-solid fa-check"></i><span>Синхронизировано</span>';
            button.style.background = 'var(--success-green)';
            button.style.borderColor = 'var(--success-green)';
            button.style.color = 'white';
            
            // Reset after 2 seconds
            setTimeout(() => {
                button.disabled = false;
                button.classList.remove('loading');
                button.innerHTML = originalText;
                button.style.background = '';
                button.style.borderColor = '';
                button.style.color = '';
            }, 2000);
        } else {
            throw new Error(data.error || 'Sync failed');
        }
    })
    .catch(error => {
        console.error('Sync error:', error);
        
        // Show error state
        button.innerHTML = '<i class="fa-solid fa-exclamation-triangle"></i><span>Ошибка</span>';
        button.style.background = 'var(--error-red)';
        button.style.borderColor = 'var(--error-red)';
        button.style.color = 'white';
        
        // Reset after 3 seconds
        setTimeout(() => {
            button.disabled = false;
            button.classList.remove('loading');
            button.innerHTML = originalText;
            button.style.background = '';
            button.style.borderColor = '';
            button.style.color = '';
        }, 3000);
    });
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load Chart.js if not already loaded
    if (typeof Chart === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        script.onload = function() {
            initExpenseDynamicsChart();
            initTimeRangeFilters();
        };
        document.head.appendChild(script);
    } else {
        initExpenseDynamicsChart();
        initTimeRangeFilters();
    }
});
</script>
{% endblock %}
