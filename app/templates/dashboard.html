{% extends "base.html" %}

{% block title %}Дашборд - InfraZen FinOps Platform{% endblock %}

{% block page_title %}{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block header_actions %}{% endblock %}

{% block header %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="dashboard-content">
    <section class="kpi-grid">
        <article class="kpi-card">
            <div class="kpi-card-header">
                <div>
                    <span class="kpi-label">Общие расходы</span>
                </div>
                <div class="kpi-icon icon-expense"><i class="fa-solid fa-ruble-sign"></i></div>
            </div>
            <div class="kpi-value">
                {% if last_complete_sync and last_complete_sync.sync_status == 'success' %}
                    {{ "{:,.0f}".format((last_complete_sync.total_monthly_cost or 0)) }} ₽/мес
                {% else %}
                    {{ "{:,.0f}".format(overview.kpis.total_expenses_rub | default(0)) }} ₽/мес
                {% endif %}
            </div>
            <div class="kpi-secondary">
                {% if last_complete_sync and last_complete_sync.sync_status == 'success' %}
                    <span class="kpi-secondary-text">
                        <i class="fa-solid fa-calendar"></i> 
                        {{ "%.0f"|format((last_complete_sync.total_monthly_cost or 0) * 12) }} ₽/год
                    </span>
                {% elif is_demo_user %}
                    <span class="kpi-secondary-text trend-down">
                        <i class="fa-solid fa-arrow-down"></i> -12.5% за месяц
                    </span>
                {% else %}
                    <span class="kpi-secondary-text trend-neutral">
                        <i class="fa-solid fa-minus"></i> 0% за месяц
                    </span>
                {% endif %}
            </div>
            <div class="kpi-footer">
                <a href="/analytics" class="link-button">Аналитика</a>
            </div>
        </article>

        <article class="kpi-card">
            <div class="kpi-card-header">
                <div>
                    <span class="kpi-label">Потенциальная экономия</span>
                </div>
                <div class="kpi-icon icon-savings"><i class="fa-solid fa-piggy-bank"></i></div>
            </div>
            <div class="kpi-value">{{ "{:,.0f}".format(overview.kpis.potential_savings_rub | default(0)) }} ₽/мес</div>
            <div class="kpi-secondary">
                <span class="kpi-secondary-text">{{ overview.kpis.savings_percentage | default(0) }}% от общих расходов</span>
            </div>
            <div class="kpi-footer">
                <a href="/recommendations" class="link-button">Управлять</a>
            </div>
        </article>

        <article class="kpi-card">
            <div class="kpi-card-header">
                <div>
                    <span class="kpi-label">Активные ресурсы</span>
                </div>
                <div class="kpi-icon icon-resources"><i class="fa-solid fa-box-open"></i></div>
            </div>
            <div class="kpi-value">{{ overview.kpis.active_resources | default(0) }}</div>
            <div class="kpi-secondary">
                <span class="kpi-secondary-text">Ресурсы</span>
            </div>
            <div class="kpi-footer">
                <a href="/resources" class="link-button">Управлять</a>
            </div>
        </article>

        <article class="kpi-card">
            <div class="kpi-card-header">
                <div>
                    <span class="kpi-label">Облачных провайдеров</span>
                </div>
                <div class="kpi-icon icon-providers"><i class="fa-solid fa-cloud"></i></div>
            </div>
            <div class="kpi-value">{{ overview.kpis.connected_providers | default(0) }}</div>
            <div class="kpi-secondary">
                <span class="kpi-secondary-text">Провайдеры</span>
            </div>
            <div class="kpi-footer">
                <a href="/connections" class="link-button">Управлять</a>
            </div>
        </article>
    </section>

    <section class="dashboard-section">
        <div class="section-header">
            <div>
                <h2 class="section-title">Подключенные облачные провайдеры ({{ overview.providers|length }})</h2>
            </div>
        </div>
        <div class="provider-grid">
            {% for p in overview.providers %}
            <article class="provider-card">
                <header class="provider-header">
                    <div class="provider-logo">
                        {% if p.code | lower == 'selectel' %}
                            <img src="{{ url_for('static', filename='provider_logos/selectel_logo.svg') }}" alt="Selectel" style="width: 2rem; height: 2rem; object-fit: contain;">
                        {% elif p.code | lower == 'beget' %}
                            <img src="{{ url_for('static', filename='provider_logos/beget_logo.jpeg') }}" alt="Beget" style="width: 2rem; height: 2rem; object-fit: contain;">
                        {% elif p.code | lower == 'yandex' %}
                            <img src="{{ url_for('static', filename='provider_logos/yc_logo.png') }}" alt="Yandex Cloud" style="width: 2rem; height: 2rem; object-fit: contain;">
                        {% else %}
                            <span class="provider-badge {{ p.code | lower }}">{{ p.code | upper }}</span>
                        {% endif %}
                    </div>
                    <span class="provider-name">{{ p.name }}</span>
                </header>
                <div class="provider-connection {% if p.status == 'connected' %}status-connected{% else %}status-disconnected{% endif %}">
                    <span class="status-indicator"></span>
                    {% if p.status == 'connected' %}Подключен{% else %}Отключен{% endif %}
                </div>
                <div class="provider-info">
                    <div class="provider-sync {% if p.sync_error %}sync-warning{% endif %}">
                        {% if p.sync_error %}
                            <i class="fa-solid fa-exclamation-triangle"></i>
                            <span>⚠️ Частичная: {{ p.last_sync or 'Никогда' }}</span>
                        {% else %}
                            <i class="fa-solid fa-arrows-rotate"></i>
                            <span>{{ p.last_sync or 'Никогда' }}</span>
                        {% endif %}
                    </div>
                    <div class="provider-cost">
                        <i class="fa-solid fa-ruble-sign"></i>
                        <span>{{ "{:,.0f}".format(p.monthly_cost or 0) }} ₽/мес</span>
                    </div>
                    {% if p.sync_error %}
                    <div class="provider-sync-error">
                        <i class="fa-solid fa-info-circle"></i>
                        <span>{{ p.sync_error }}</span>
                    </div>
                    {% endif %}
                </div>
                <div class="provider-actions">
                    <button class="action-btn primary sync-btn" 
                            onclick="syncConnection('{{ p.id }}', '{{ p.code }}')">
                        <i class="fa-solid fa-sync"></i>
                        <span>Синхронизировать</span>
                    </button>
                </div>
            </article>
            {% endfor %}
            <!-- Example card structure retained for reference -->
            <!--
            <article class="provider-card">
                <header class="provider-header">
                    <span class="provider-badge gcp">GCP</span>
                    <span class="provider-name">gcp</span>
                </header>
                <div class="provider-connection status-connected">
                    <span class="status-indicator"></span>
                    Подключен • Ожидает синхронизации
                </div>
                <div class="provider-status">Добавлен: 21.09.2025</div>
                <div class="provider-actions">
                    <button class="icon-button"><i class="fa-solid fa-gear"></i></button>
                    <button class="icon-button icon-danger"><i class="fa-solid fa-trash"></i></button>
                </div>
            </article>
            -->

        </div>
    </section>

    <section class="split-grid">
        <article class="dashboard-section">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Динамика расходов</h2>
                    <p class="section-meta">Анализ затрат за выбранный период</p>
                </div>
                <div class="filter-controls">
                    <button class="filter-pill active" data-days="30">30д</button>
                    <button class="filter-pill" data-days="90">90д</button>
                    <button class="filter-pill" data-days="365">1г</button>
                </div>
            </div>
            <div class="chart-container" data-trend-data='{{ expense_dynamics.trend_data | tojson }}'>
                <canvas id="expenseDynamicsChart" width="400" height="200"></canvas>
            </div>
            <div class="summary-metrics">
                <div>
                    <div class="summary-label">ПРОШЛЫЙ МЕСЯЦ</div>
                    <div class="summary-value">₽{{ "%.0f"|format(expense_dynamics.last_month_cost) }}</div>
                </div>
                <div>
                    <div class="summary-label">ТЕКУЩИЙ МЕСЯЦ</div>
                    <div class="summary-value text-success">₽{{ "%.0f"|format(expense_dynamics.current_month_cost) }}</div>
                </div>
                <div>
                    <div class="summary-label">ЭКОНОМИЯ</div>
                    <div class="summary-value text-primary-blue">₽{{ "%.0f"|format(expense_dynamics.savings) }}</div>
                </div>
            </div>
        </article>

        <article class="dashboard-section">
            <div class="section-header">
                <div>
                    <h2 class="section-title">Использование ресурсов</h2>
                    <p class="section-meta">Нагрузка и доступные мощности</p>
                </div>
                <a class="icon-button" href="#"><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
            </div>
            <div class="usage-list">
                <div class="usage-item">
                    <div class="usage-top">
                        <span>Процессоры (CPU)</span>
                        <span class="usage-percent">{{ overview.usage.cpu.percent }}%</span>
                    </div>
                    <div class="usage-bar">
                        <div class="usage-bar-fill" style="width: {{ overview.usage.cpu.percent }}%"></div>
                    </div>
                    <div class="usage-meta">
                        <span>Используется: {{ overview.usage.cpu.used_vcpu }} vCPU</span>
                        <span>Доступно: {{ overview.usage.cpu.available_vcpu }} vCPU</span>
                    </div>
                </div>
                <div class="usage-item">
                    <div class="usage-top">
                        <span>Память (RAM)</span>
                        <span class="usage-percent">{{ overview.usage.ram.percent }}%</span>
                    </div>
                    <div class="usage-bar">
                        <div class="usage-bar-fill" style="width: {{ overview.usage.ram.percent }}%"></div>
                    </div>
                    <div class="usage-meta">
                        <span>Используется: {{ overview.usage.ram.used_gb }} GB</span>
                        <span>Доступно: {{ overview.usage.ram.available_gb }} GB</span>
                    </div>
                </div>
                <div class="usage-item">
                    <div class="usage-top">
                        <span>Хранилище</span>
                        <span class="usage-percent">{{ overview.usage.storage.percent }}%</span>
                    </div>
                    <div class="usage-bar">
                        <div class="usage-bar-fill" style="width: {{ overview.usage.storage.percent }}%"></div>
                    </div>
                    <div class="usage-meta">
                        <span>Используется: {{ overview.usage.storage.used_tb }} TB</span>
                        <span>Доступно: {{ overview.usage.storage.available_tb }} TB</span>
                    </div>
                </div>
                <div class="usage-item">
                    <div class="usage-top">
                        <span>Сетевой трафик</span>
                        <span class="usage-percent">{{ overview.usage.network.percent }}%</span>
                    </div>
                    <div class="usage-bar">
                        <div class="usage-bar-fill" style="width: {{ overview.usage.network.percent }}%"></div>
                    </div>
                    <div class="usage-meta">
                        <span>Использовано: {{ overview.usage.network.used_tb }} TB</span>
                        <span>Лимит: {{ overview.usage.network.limit_tb }} TB</span>
                    </div>
                </div>
            </div>
        </article>
    </section>

    <section class="dashboard-section">
        <div class="section-header">
            <div>
                <h2 class="section-title">Рекомендации по оптимизации</h2>
                <p class="section-meta">Предложения для снижения расходов</p>
            </div>
            <div class="section-actions">
                <span class="section-meta">Потенциальная экономия: {{ "%.0f"|format(overview.kpis.potential_savings_rub | default(0)) }} ₽</span>
                <button class="icon-button"><i class="fa-solid fa-arrows-rotate"></i></button>
            </div>
        </div>
        {% if overview.recommendations %}
        <div class="recommendations-list">
            {% for r in overview.recommendations %}
            <div class="recommendation-item">
                <div class="rec-title">{{ r.title }}</div>
                <div class="rec-meta">{{ r.provider }} • Экономия: {{ r.estimated_savings_rub }} ₽ • Доверие: {{ (r.confidence * 100)|round(0) }}%</div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon"><i class="fa-solid fa-lightbulb"></i></div>
            <div class="empty-state-title">Рекомендации не найдены</div>
            <div class="empty-state-text">Все ваши ресурсы оптимально настроены</div>
        </div>
        {% endif %}
    </section>

    <section class="dashboard-section">
        <div class="section-header">
            <div>
                <h2 class="section-title">Инвентарь ресурсов</h2>
                <p class="section-meta">Поиск и фильтрация по провайдерам</p>
            </div>
            <div class="section-actions">
                <span class="section-meta">0 из 0 ресурсов</span>
                <button class="icon-button"><i class="fa-solid fa-filter"></i></button>
            </div>
        </div>
        <div class="filter-row">
            <input class="form-control" type="text" placeholder="Поиск ресурсов...">
            <select class="form-control">
                <option>Все провайдеры</option>
            </select>
            <select class="form-control">
                <option>Все типы</option>
            </select>
            <select class="form-control">
                <option>Все статусы</option>
            </select>
        </div>
        {% if overview.resources %}
        <div class="resource-table">
            <div class="resource-table-header">
                <span>Ресурс</span>
                <span>Провайдер</span>
                <span>Тип</span>
                <span>Регион</span>
                <span>Статус</span>
                <span>Месячная стоимость</span>
            </div>
            {% for res in overview.resources %}
            <div class="resource-row">
                <span>{{ res.name }}</span>
                <span>{{ res.provider }}</span>
                <span>{{ res.type }}</span>
                <span>{{ res.region }}</span>
                <span>{{ res.status }}</span>
                <span>{{ res.monthly_cost_rub | default(0) }} ₽</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-state-icon"><i class="fa-solid fa-server"></i></div>
            <div class="empty-state-title">Нет ресурсов</div>
            <div class="empty-state-text">Подключите облачных провайдеров для отображения ресурсов</div>
        </div>
        {% endif %}
    </section>
</div>


<!-- External JavaScript -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
