{% extends "base.html" %}

{% block title %}Settings - InfraZen FinOps Platform{% endblock %}

{% block scripts %}
<script src="https://accounts.google.com/gsi/client" async defer></script>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/settings.css') }}">
{% endblock %}

{% block page_title %}Settings - Manage your account settings and preferences{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block content %}
<div class="settings-container">
    <!-- Account Information Section -->
    <div class="settings-card">
        <div class="settings-card-header">
            <h3><i class="fa-solid fa-user"></i> Account Information</h3>
        </div>
        <div class="settings-card-body">
            <div class="info-grid">
                <div class="info-item">
                    <label>Email</label>
                    <div class="info-value">
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <span id="userEmail">{{ user.email }}</span>
                            <span class="email-status-badge" id="emailStatusBadge">
                                <i class="fa-solid fa-spinner fa-spin"></i> Checking...
                            </span>
                            <button id="sendConfirmationBtn" class="btn-send-confirmation" style="display: none;" onclick="sendConfirmationEmail()">
                                <i class="fa-solid fa-envelope"></i> Send Confirmation Email
                            </button>
                        </div>
                    </div>
                </div>
                <div class="info-item">
                    <label>Name</label>
                    <div class="info-value" id="userName">{{ user.name }}</div>
                </div>
                <div class="info-item">
                    <label>Role</label>
                    <div class="info-value">
                        <span class="role-badge role-{{ user.role }}">
                            {{ user.role.replace('_', ' ').upper() }}
                        </span>
                    </div>
                </div>
                <div class="info-item">
                    <label>Account Created</label>
                    <div class="info-value" id="accountCreated">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Login Methods Section -->
    <div class="settings-card">
        <div class="settings-card-header">
            <h3><i class="fa-solid fa-shield-alt"></i> Login Methods</h3>
        </div>
        <div class="settings-card-body">
            <div class="login-methods">
                <div class="login-method" id="googleLoginMethod" onclick="handleGoogleConnect()">
                    <div class="method-icon google">
                        <i class="fa-brands fa-google"></i>
                    </div>
                    <div class="method-info">
                        <div class="method-name">Google OAuth</div>
                        <div class="method-status" id="googleStatus">Checking...</div>
                    </div>
                    <div class="method-badge" id="googleBadge"></div>
                </div>
                
                <div class="login-method" id="passwordLoginMethod">
                    <div class="method-icon password">
                        <i class="fa-solid fa-key"></i>
                    </div>
                    <div class="method-info">
                        <div class="method-name">Username & Password</div>
                        <div class="method-status" id="passwordStatus">Checking...</div>
                    </div>
                    <div class="method-badge" id="passwordBadge"></div>
                </div>
            </div>
            
            <div class="current-session">
                <i class="fa-solid fa-info-circle"></i>
                <span id="currentLoginMethod">Current session: Loading...</span>
            </div>
        </div>
    </div>

    <!-- Password Management Section -->
    <div class="settings-card">
        <div class="settings-card-header">
            <h3><i class="fa-solid fa-lock"></i> Password Management</h3>
        </div>
        <div class="settings-card-body">
            <div id="passwordManagementContent">
                <!-- Content will be loaded dynamically based on user's password status -->
            </div>
        </div>
    </div>

    <!-- Preferences Section -->
    <div class="settings-card">
        <div class="settings-card-header">
            <h3><i class="fa-solid fa-cog"></i> Preferences</h3>
        </div>
        <div class="settings-card-body">
            <div class="info-grid">
                <div class="info-item">
                    <label>Timezone</label>
                    <div class="info-value" id="userTimezone">Loading...</div>
                </div>
                <div class="info-item">
                    <label>Currency</label>
                    <div class="info-value" id="userCurrency">Loading...</div>
                </div>
                <div class="info-item">
                    <label>Language</label>
                    <div class="info-value" id="userLanguage">Loading...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Provider Preferences for Recommendations Section -->
    <div class="settings-card">
        <div class="settings-card-header">
            <h3><i class="fa-solid fa-server"></i> Провайдеры для рекомендаций</h3>
        </div>
        <div class="settings-card-body">
            <div class="provider-preferences-description">
                <p>Выберите провайдеры, которые будут использоваться при сравнении цен и поиске более выгодных предложений в рекомендациях.</p>
            </div>
            <div id="providerPreferencesList" class="provider-preferences-list">
                <!-- Providers will be loaded dynamically -->
                <div class="loading-spinner">
                    <i class="fa-solid fa-spinner fa-spin"></i> Загрузка провайдеров...
                </div>
            </div>
        </div>
    </div>

    <!-- Clear Recommendations Section -->
    <div class="settings-card">
        <div class="settings-card-header">
            <h3><i class="fa-solid fa-trash-restore"></i> Сброс рекомендаций</h3>
        </div>
        <div class="settings-card-body">
            <div class="provider-preferences-description">
                <p>Удалите все существующие рекомендации для вашего аккаунта. При следующей синхронизации система автоматически создаст новые рекомендации на основе актуальных данных об инфраструктуре и ценах провайдеров.</p>
                <p style="margin-top: 0.75rem; color: var(--warning-orange); font-weight: 500;">
                    <i class="fa-solid fa-exclamation-triangle"></i> Внимание: Это действие нельзя отменить. Все рекомендации (новые, внедрённые, отложенные, скрытые) будут безвозвратно удалены.
                </p>
            </div>
            <div style="margin-top: 1.5rem;">
                <button id="clearAllRecommendations" class="btn btn-danger">
                    <i class="fa-solid fa-trash-alt"></i> Удалить все рекомендации
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Success/Error Messages -->
<div id="messageContainer"></div>


<!-- Pass template variables to JavaScript -->
<script>
window.INFRAZEN_DATA = window.INFRAZEN_DATA || {};
window.INFRAZEN_DATA.googleClientId = "{{ google_client_id }}";
</script>

<!-- External JavaScript -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script src="{{ url_for('static', filename='js/settings.js') }}"></script>
{% endblock %}

