{% extends "base.html" %}

{% block title %}–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ - InfraZen{% endblock %}

{% block page_title %}–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏{% endblock %}
{% block page_subtitle %}–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏{% endblock %}

{% block header_actions %}
<div style="display: flex; gap: 1rem; align-items: center;">
    <button id="refreshBtn" class="btn btn-secondary" style="padding: 0.5rem 1rem;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    <div style="display:flex; gap:0.5rem;">
        <button id="bulkImplement" class="btn btn-primary" disabled>–û—Ç–º–µ—Ç–∏—Ç—å –≤–Ω–µ–¥—Ä—ë–Ω–Ω—ã–º–∏</button>
        <button id="bulkDismiss" class="btn btn-secondary" disabled>–°–∫—Ä—ã—Ç—å</button>
    </div>
    <button id="exportCsv" class="btn btn-secondary">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
    <a href="/connections" class="btn btn-link">–ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏</a>
    </div>
{% endblock %}

{% block content %}
<div class="filters" style="margin-bottom: 1rem; display: grid; grid-template-columns: repeat(6, minmax(140px, 1fr)); gap: 0.75rem;">
    <input id="search" class="input" placeholder="–ü–æ–∏—Å–∫..." />
    <select id="provider" class="input">
        <option value="">–ü—Ä–æ–≤–∞–π–¥–µ—Ä</option>
    </select>
    <select id="status" class="input">
        <option value="">–°—Ç–∞—Ç—É—Å</option>
        <option value="pending">–ù–æ–≤—ã–µ</option>
        <option value="seen">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω—ã</option>
        <option value="snoozed">–û—Ç–ª–æ–∂–µ–Ω—ã</option>
        <option value="implemented">–í–Ω–µ–¥—Ä–µ–Ω—ã</option>
        <option value="dismissed">–°–∫—Ä—ã—Ç—ã</option>
    </select>
    <select id="severity" class="input">
        <option value="">–í–∞–∂–Ω–æ—Å—Ç—å</option>
        <option value="critical">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è</option>
        <option value="high">–í—ã—Å–æ–∫–∞—è</option>
        <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
        <option value="low">–ù–∏–∑–∫–∞—è</option>
        <option value="info">–ò–Ω—Ñ–æ</option>
    </select>
    <select id="type" class="input">
        <option value="">–¢–∏–ø</option>
        <option value="rightsizing">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä</option>
        <option value="shutdown">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</option>
        <option value="migrate">–ú–∏–≥—Ä–∞—Ü–∏—è</option>
        <option value="cleanup">–û—á–∏—Å—Ç–∏—Ç—å</option>
    </select>
    <select id="resource_type" class="input">
        <option value="">–¢–∏–ø —Ä–µ—Å—É—Ä—Å–∞</option>
        <option value="VM">VM</option>
        <option value="volume">–¢–æ–º</option>
        <option value="bucket">–•—Ä–∞–Ω–∏–ª–∏—â–µ</option>
    </select>
</div>

<div style="overflow:auto;">
  <table class="table" id="recsTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="selectAll" /></th>
        <th>–í–∞–∂–Ω–æ—Å—Ç—å</th>
        <th>–ó–∞–≥–æ–ª–æ–≤–æ–∫</th>
        <th>–†–µ—Å—É—Ä—Å</th>
        <th>–≠–∫–æ–Ω–æ–º–∏—è/–º–µ—Å</th>
        <th>–°—Ç–∞—Ç—É—Å</th>
        <th>–°–æ–∑–¥–∞–Ω–æ</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div id="recModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div style="display:flex; justify-content: space-between; align-items:center;">
      <h3 id="modalTitle">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</h3>
      <button id="modalClose" class="btn btn-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="modalBody"></div>
  </div>
  <div class="modal-backdrop"></div>
  </div>

<script>
const qs = (s, el=document) => el.querySelector(s);
const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));
const state = { page: 1, page_size: 25, order_by: '-estimated_monthly_savings' };

function buildQuery(){
  const params = new URLSearchParams();
  ['q','provider','status','severity','type','resource_type'].forEach(k=>{
    const v = qs('#'+k)?.value?.trim(); if(v) params.set(k, v);
  });
  params.set('page', state.page); params.set('page_size', state.page_size); params.set('order_by', state.order_by);
  history.replaceState(null, '', '?'+params.toString());
  return params.toString();
}

async function fetchProviders(){
  try {
    const res = await fetch('/api/providers');
    const data = await res.json();
    const sel = qs('#provider');
    (data.providers || []).forEach(p=>{
      const o = document.createElement('option'); o.value = p.id; o.textContent = p.provider_type || p.code || p.name; sel.appendChild(o);
    });
  } catch(e) {}
}

function sevBadge(sev){
  const colors = {critical:'#d93025', high:'#ea4335', medium:'#f9ab00', low:'#34a853', info:'#5f6368'};
  const c = colors[sev]||'#5f6368';
  return `<span style="display:inline-block;padding:2px 8px;border-radius:12px;background:${c}20;color:${c};text-transform:capitalize;">${sev||'n/a'}</span>`;
}

function statusBadge(st){
  const colors = {pending:'#1a73e8', seen:'#5f6368', snoozed:'#a142f4', implemented:'#34a853', dismissed:'#9aa0a6'};
  const c = colors[st]||'#5f6368';
  return `<span style="display:inline-block;padding:2px 8px;border-radius:12px;background:${c}20;color:${c};text-transform:capitalize;">${st}</span>`;
}

function formatMoney(v){
  const n = Number(v||0); return new Intl.NumberFormat('ru-RU', {style:'currency', currency:'RUB', maximumFractionDigits:0}).format(n);
}

function rowTemplate(rec){
  const res = `${rec.resource_name||'-'} ‚Ä¢ ${rec.resource_type||''} ‚Ä¢ ${rec.provider_code||''}`;
  const created = rec.created_at? new Date(rec.created_at).toLocaleString('ru-RU') : '';
  return `<tr data-id="${rec.id}">
    <td><input type="checkbox" class="rowCheck" /></td>
    <td>${sevBadge(rec.severity)}</td>
    <td><a href="#" class="openModal">${rec.title}</a></td>
    <td>${res}</td>
    <td>${formatMoney(rec.estimated_monthly_savings)}</td>
    <td>${statusBadge(rec.status)}</td>
    <td>${created}</td>
    <td style="white-space:nowrap;display:flex;gap:6px;">
      <button class="btn btn-secondary btn-xs act" data-act="seen">üëÅ</button>
      <button class="btn btn-primary btn-xs act" data-act="implemented">‚úÖ</button>
      <button class="btn btn-secondary btn-xs act" data-act="snooze">‚è±</button>
      <button class="btn btn-secondary btn-xs act" data-act="dismiss">üóë</button>
    </td>
  </tr>`;
}

async function load(){
  const res = await fetch('/api/recommendations?'+buildQuery());
  const data = await res.json();
  const tbody = qs('#recsTable tbody');
  tbody.innerHTML = (data.items||[]).map(rowTemplate).join('');
  enableBulkButtons();
}

async function actOne(id, action, extra={}){
  const res = await fetch(`/api/recommendations/${id}/action`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action, ...extra})});
  if(res.ok) await load();
}

function selectedIds(){
  return qsa('.rowCheck:checked').map(cb=>cb.closest('tr').dataset.id);
}

async function actBulk(action){
  const ids = selectedIds(); if(!ids.length) return;
  const res = await fetch('/api/recommendations/bulk', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ids, action})});
  if(res.ok) await load();
}

function enableBulkButtons(){
  const has = selectedIds().length>0;
  qs('#bulkImplement').disabled = !has;
  qs('#bulkDismiss').disabled = !has;
}

// Events
['#search','#provider','#status','#severity','#type','#resource_type'].forEach(sel=>{
  qs(sel).addEventListener('change', ()=>{state.page=1; load();});
});
qs('#refreshBtn').addEventListener('click', ()=>load());
qs('#selectAll').addEventListener('change', (e)=>{ qsa('.rowCheck').forEach(cb=>cb.checked=e.target.checked); enableBulkButtons(); });
document.addEventListener('change', (e)=>{ if(e.target.classList.contains('rowCheck')) enableBulkButtons(); });
document.addEventListener('click', (e)=>{
  if(e.target.classList.contains('act')){ e.preventDefault(); const id = e.target.closest('tr').dataset.id; actOne(id, e.target.dataset.act); }
  if(e.target.classList.contains('openModal')){ e.preventDefault(); const id = e.target.closest('tr').dataset.id; openModal(id); }
});

async function openModal(id){
  const res = await fetch(`/api/recommendations/${id}`);
  const rec = await res.json();
  qs('#modalTitle').textContent = rec.title;
  const body = `
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <div><strong>–¢–∏–ø:</strong> ${rec.recommendation_type}</div>
        <div><strong>–í–∞–∂–Ω–æ—Å—Ç—å:</strong> ${rec.severity}</div>
        <div><strong>–°—Ç–∞—Ç—É—Å:</strong> ${rec.status}</div>
        <div><strong>–†–µ—Å—É—Ä—Å:</strong> ${rec.resource_name||''} ‚Ä¢ ${rec.resource_type||''}</div>
        <div><strong>–≠–∫–æ–Ω–æ–º–∏—è/–º–µ—Å:</strong> ${formatMoney(rec.estimated_monthly_savings)}</div>
        <div><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${rec.description||''}</div>
      </div>
      <div>
        <div><strong>–ü–æ—è—Å–Ω–µ–Ω–∏—è:</strong></div>
        <pre style="white-space:pre-wrap;background:#f6f7f9;border:1px solid #e0e3e7;border-radius:8px;padding:8px;">${rec.insights||''}</pre>
      </div>
    </div>
    <div style="margin-top:12px;display:flex;gap:6px;">
      <button class="btn btn-primary" onclick="actOne(${id}, 'implemented')">–û—Ç–º–µ—Ç–∏—Ç—å –≤–Ω–µ–¥—Ä—ë–Ω–Ω–æ–π</button>
      <button class="btn btn-secondary" onclick="actOne(${id}, 'seen')">–û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–π</button>
      <button class="btn btn-secondary" onclick="actOne(${id}, 'snooze')">–û—Ç–ª–æ–∂–∏—Ç—å</button>
      <button class="btn btn-secondary" onclick="actOne(${id}, 'dismiss')">–°–∫—Ä—ã—Ç—å</button>
    </div>`;
  qs('#modalBody').innerHTML = body;
  qs('#recModal').style.display = 'block';
}
qs('#modalClose').addEventListener('click', ()=> qs('#recModal').style.display = 'none');

// Init
(async function(){
  await fetchProviders();
  const urlp = new URLSearchParams(location.search);
  ['q','provider','status','severity','type','resource_type'].forEach(k=>{ if(urlp.get(k)) qs('#'+k).value = urlp.get(k);});
  await load();
})();
</script>
{% endblock %}


