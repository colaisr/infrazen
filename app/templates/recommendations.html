{% extends "base.html" %}

{% block title %}–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ - InfraZen{% endblock %}

{% block page_title %}–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏{% endblock %}
{% block page_subtitle %}–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏{% endblock %}

{% block header_actions %}
<div style="display: flex; gap: 1rem; align-items: center;">
    {% if user.role != 'demouser' %}
    <button id="refreshBtn" class="btn btn-secondary" style="padding: 0.5rem 1rem;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    <div style="display:flex; gap:0.5rem;">
        <button id="bulkImplement" class="btn btn-primary" disabled>–û—Ç–º–µ—Ç–∏—Ç—å –≤–Ω–µ–¥—Ä—ë–Ω–Ω—ã–º–∏</button>
        <button id="bulkDismiss" class="btn btn-secondary" disabled>–°–∫—Ä—ã—Ç—å</button>
    </div>
    {% endif %}
    <button id="exportCsv" class="btn btn-secondary">–≠–∫—Å–ø–æ—Ä—Ç CSV</button>
    <a href="/connections" class="btn btn-link">–ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è–º–∏</a>
    </div>
{% endblock %}

{% block content %}
<style>
  .rec-list { display: flex; flex-direction: column; gap: 10px; }
  .rec-card { border: 1px solid #e0e3e7; border-radius: 12px; padding: 12px 14px; background: #fff; display: grid; grid-template-columns: 1fr auto; gap: 8px; }
  .rec-head { display: flex; align-items: center; gap: 10px; min-width: 0; }
  .sev-dot { width: 10px; height: 10px; border-radius: 50%; flex: 0 0 auto; }
  .sev-critical { background:#d93025; } .sev-high{ background:#ea4335;} .sev-medium{ background:#f9ab00;} .sev-low{ background:#34a853;} .sev-info{ background:#5f6368;}
  .rec-title { font-weight: 600; color:#1f2937; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .kpi { align-self: start; padding: 6px 10px; background:#eff6ff; color:#1a73e8; border:1px solid #dbeafe; border-radius: 999px; font-weight:600; }
  .rec-context { display:flex; flex-wrap: wrap; gap:6px; }
  .chip { padding: 2px 8px; border-radius: 999px; border:1px solid #e5e7eb; color:#374151; background:#f9fafb; font-size: 12px; }
  .rec-body { color:#374151; line-height: 1.4; }
  .rec-actions { display:flex; align-items:center; gap:6px; justify-content: flex-end; }
  .rec-footer { display:flex; align-items:center; justify-content: space-between; color:#6b7280; font-size: 12px; margin-top: 6px; }
  .link-btn { color:#1a73e8; background:none; border:none; padding:0; cursor:pointer; }
  .btn-icon { padding: 4px 8px; border:1px solid #e5e7eb; border-radius: 8px; background:#fff; }
  .rec-details { display:none; padding-top: 8px; border-top:1px dashed #e5e7eb; margin-top: 6px; }
  .rec-split { display:grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  @media (max-width: 960px) { .rec-card{ grid-template-columns: 1fr; } .rec-split{ grid-template-columns:1fr; } }
</style>

<div class="filters" style="margin-bottom: 1rem; display: grid; grid-template-columns: repeat(6, minmax(140px, 1fr)); gap: 0.75rem;">
    <input id="search" class="input" placeholder="–ü–æ–∏—Å–∫..." />
    <select id="provider" class="input">
        <option value="">–ü—Ä–æ–≤–∞–π–¥–µ—Ä</option>
    </select>
    <select id="status" class="input">
        <option value="">–°—Ç–∞—Ç—É—Å</option>
        <option value="pending">–ù–æ–≤—ã–µ</option>
        <option value="seen">–ü—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω—ã</option>
        <option value="snoozed">–û—Ç–ª–æ–∂–µ–Ω—ã</option>
        <option value="implemented">–í–Ω–µ–¥—Ä–µ–Ω—ã</option>
        <option value="dismissed">–°–∫—Ä—ã—Ç—ã</option>
    </select>
    <select id="severity" class="input">
        <option value="">–í–∞–∂–Ω–æ—Å—Ç—å</option>
        <option value="critical">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è</option>
        <option value="high">–í—ã—Å–æ–∫–∞—è</option>
        <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
        <option value="low">–ù–∏–∑–∫–∞—è</option>
        <option value="info">–ò–Ω—Ñ–æ</option>
    </select>
    <select id="type" class="input">
        <option value="">–¢–∏–ø</option>
        <option value="rightsizing">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä</option>
        <option value="shutdown">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</option>
        <option value="migrate">–ú–∏–≥—Ä–∞—Ü–∏—è</option>
        <option value="cleanup">–û—á–∏—Å—Ç–∏—Ç—å</option>
    </select>
    <select id="resource_type" class="input">
        <option value="">–¢–∏–ø —Ä–µ—Å—É—Ä—Å–∞</option>
        <option value="VM">VM</option>
        <option value="volume">–¢–æ–º</option>
        <option value="bucket">–•—Ä–∞–Ω–∏–ª–∏—â–µ</option>
    </select>
</div>

<div class="rec-list" id="recsList"></div>

<div id="recModal" class="modal" style="display:none;">
  <div class="modal-content">
    <div style="display:flex; justify-content: space-between; align-items:center;">
      <h3 id="modalTitle">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</h3>
      <button id="modalClose" class="btn btn-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div id="modalBody"></div>
  </div>
  <div class="modal-backdrop"></div>
  </div>

<script>
const qs = (s, el=document) => el.querySelector(s);
const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));
const state = { page: 1, page_size: 25, order_by: '-estimated_monthly_savings' };
const isDemoUser = {{ 'true' if user.role == 'demouser' else 'false' }};

function buildQuery(){
  const params = new URLSearchParams();
  ['q','provider','status','severity','type','resource_type'].forEach(k=>{
    const v = qs('#'+k)?.value?.trim(); if(v) params.set(k, v);
  });
  params.set('page', state.page); params.set('page_size', state.page_size); params.set('order_by', state.order_by);
  history.replaceState(null, '', '?'+params.toString());
  return params.toString();
}

async function fetchProviders(){
  try {
    const res = await fetch('/api/providers');
    const data = await res.json();
    const sel = qs('#provider');
    (data.providers || []).forEach(p=>{
      const o = document.createElement('option'); o.value = p.id; o.textContent = p.provider_type || p.code || p.name; sel.appendChild(o);
    });
  } catch(e) {}
}

function sevClass(sev){
  return {
    critical:'sev-critical', high:'sev-high', medium:'sev-medium', low:'sev-low', info:'sev-info'
  }[sev] || 'sev-info';
}

function statusBadge(st){
  const colors = {pending:'#1a73e8', seen:'#5f6368', snoozed:'#a142f4', implemented:'#34a853', dismissed:'#9aa0a6'};
  const c = colors[st]||'#5f6368';
  return `<span style="display:inline-block;padding:2px 8px;border-radius:12px;background:${c}20;color:${c};text-transform:capitalize;">${st}</span>`;
}

function formatMoney(v){
  const n = Number(v||0); return new Intl.NumberFormat('ru-RU', {style:'currency', currency:'RUB', maximumFractionDigits:0}).format(n);
}

function cardTemplate(rec){
  const created = rec.created_at? new Date(rec.created_at).toLocaleString('ru-RU') : '';
  const sev = `<span class="sev-dot ${sevClass(rec.severity)}"></span>`;
  const ctx = [rec.provider_code, rec.resource_name, rec.resource_type].filter(Boolean);
  const chips = ctx.map(x=>`<span class="chip">${x}</span>`).join('');
  const id = rec.id;
  
  // Conditionally show action buttons for non-demo users
  const actionButtons = isDemoUser ? '' : `
    <div class="rec-actions">
      <input type="checkbox" class="rowCheck" />
      <button class="btn-icon act" data-act="seen" title="–û—Ç–º–µ—Ç–∏—Ç—å –ø—Ä–æ—Å–º–æ—Ç—Ä–µ–Ω–Ω–æ–π">üëÅ</button>
      <button class="btn-icon act" data-act="implemented" title="–û—Ç–º–µ—Ç–∏—Ç—å –≤–Ω–µ–¥—Ä—ë–Ω–Ω–æ–π">‚úÖ</button>
      <button class="btn-icon act" data-act="snooze" title="–û—Ç–ª–æ–∂–∏—Ç—å">‚è±</button>
      <button class="btn-icon act" data-act="dismiss" title="–°–∫—Ä—ã—Ç—å">üóë</button>
    </div>
  `;
  
  return `<div class="rec-card" data-id="${id}">
    <div class="rec-head">
      ${sev}
      <div class="rec-title" title="${rec.title}">${rec.title}</div>
    </div>
    <div class="kpi">–≠–∫–æ–Ω–æ–º–∏—è/–º–µ—Å: ${formatMoney(rec.estimated_monthly_savings)}</div>

    <div class="rec-context">${chips}</div>
    ${actionButtons}

    <div class="rec-body">${(rec.description||'').slice(0,220)}${(rec.description||'').length>220?'‚Ä¶':''}
      <button class="link-btn more" data-id="${id}">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>
    </div>
    <div class="rec-details" id="details-${id}"></div>

    <div class="rec-footer">
      <span>${statusBadge(rec.status)}</span>
      <span>${created}</span>
    </div>
  </div>`;
}

async function load(){
  try {
    console.log('Fetching recommendations from API...');
    const queryString = buildQuery();
    console.log('Query string:', queryString);
    const res = await fetch('/api/recommendations?'+queryString);
    console.log('API response status:', res.status);
    
    if (!res.ok) {
      throw new Error(`API request failed with status ${res.status}`);
    }
    
    const data = await res.json();
    console.log('API response data:', data);
    
    const list = qs('#recsList');
    if (!list) {
      console.error('Recommendations list container not found');
      return;
    }
    
    const items = data.items || [];
    console.log(`Found ${items.length} recommendations`);
    
    if (items.length === 0) {
      list.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>';
    } else {
      list.innerHTML = items.map(cardTemplate).join('');
    }
    
    enableBulkButtons();
  } catch (error) {
    console.error('Error in load function:', error);
    const list = qs('#recsList');
    if (list) {
      list.innerHTML = '<div style="padding: 2rem; text-align: center; color: #d32f2f;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π: ' + error.message + '</div>';
    }
  }
}

async function actOne(id, action, extra={}){
  const res = await fetch(`/api/recommendations/${id}/action`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({action, ...extra})});
  if(res.ok) await load();
}

function selectedIds(){
  return qsa('.rowCheck:checked').map(cb=>cb.closest('tr').dataset.id);
}

async function actBulk(action){
  const ids = selectedIds(); if(!ids.length) return;
  const res = await fetch('/api/recommendations/bulk', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ids, action})});
  if(res.ok) await load();
}

function enableBulkButtons(){
  const has = selectedIds().length>0;
  qs('#bulkImplement').disabled = !has;
  qs('#bulkDismiss').disabled = !has;
}

// Events
['#search','#provider','#status','#severity','#type','#resource_type'].forEach(sel=>{
  qs(sel).addEventListener('change', ()=>{state.page=1; load();});
});
qs('#refreshBtn').addEventListener('click', ()=>load());
qs('#selectAll').addEventListener('change', (e)=>{ qsa('.rowCheck').forEach(cb=>cb.checked=e.target.checked); enableBulkButtons(); });
document.addEventListener('change', (e)=>{ if(e.target.classList.contains('rowCheck')) enableBulkButtons(); });
document.addEventListener('click', (e)=>{
  if(e.target.classList.contains('act')){ e.preventDefault(); const id = e.target.closest('.rec-card').dataset.id; actOne(id, e.target.dataset.act); }
  if(e.target.classList.contains('more')){ e.preventDefault(); const id = e.target.dataset.id; toggleDetails(id); }
});

async function toggleDetails(id){
  const box = qs(`#details-${id}`);
  if(!box) return;
  if(box.dataset.loaded === '1'){
    box.style.display = box.style.display === 'none' ? 'block' : 'none';
    return;
  }
  const res = await fetch(`/api/recommendations/${id}`);
  const rec = await res.json();
  const insights = rec.insights || '';
  const metrics = rec.metrics_snapshot || '';
  box.innerHTML = `
    <div class="rec-split">
      <div>
        <div style="font-weight:600; margin-bottom:4px;">–ü–æ—è—Å–Ω–µ–Ω–∏—è</div>
        <pre style="white-space:pre-wrap;background:#f6f7f9;border:1px solid #e0e3e7;border-radius:8px;padding:8px;">${insights}</pre>
      </div>
      <div>
        <div style="font-weight:600; margin-bottom:4px;">–ú–µ—Ç—Ä–∏–∫–∏</div>
        <pre style="white-space:pre-wrap;background:#f6f7f9;border:1px solid #e0e3e7;border-radius:8px;padding:8px;">${metrics}</pre>
      </div>
    </div>`;
  box.dataset.loaded = '1';
  box.style.display = 'block';
}
// Init
(async function(){
  try {
    console.log('Loading recommendations page...');
    await fetchProviders();
    const urlp = new URLSearchParams(location.search);
    ['q','provider','status','severity','type','resource_type'].forEach(k=>{ if(urlp.get(k)) qs('#'+k).value = urlp.get(k);});
    console.log('Loading recommendations data...');
    await load();
    console.log('Recommendations loaded successfully');
  } catch (error) {
    console.error('Error loading recommendations:', error);
    const list = qs('#recsList');
    if (list) {
      list.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>';
    }
  }
})();
</script>
{% endblock %}


