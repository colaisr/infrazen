{% extends "base.html" %}

{% block title %}Unrecognized Resources - Admin Dashboard{% endblock %}

{% block page_title %}{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block content %}
<div class="admin-content">
    <!-- Compact Filters -->
    <div class="compact-filters">
        <div class="filters-container">
            <div class="filter-group">
                <input type="text" class="filter-input" id="search" placeholder="Search resources..." />
                <i class="fas fa-search filter-icon"></i>
            </div>
            
            <div class="filter-group">
                <select class="filter-select" id="provider-filter">
                    <option value="">All Providers</option>
                    <option value="1">Beget</option>
                    <option value="2">Selectel</option>
                </select>
            </div>
            
            <div class="filter-group">
                <select class="filter-select" id="resource-type-filter">
                    <option value="">All Types</option>
                </select>
            </div>
            
            <div class="filter-group">
                <select class="filter-select" id="resolved-filter">
                    <option value="">All Status</option>
                    <option value="false">Unresolved</option>
                    <option value="true">Resolved</option>
                </select>
            </div>
            
            <div class="filter-actions">
                <button class="btn btn-primary btn-sm" onclick="loadUnrecognizedResources()">
                    <i class="fas fa-filter"></i> Filter
                </button>
                <button class="btn btn-secondary btn-sm" onclick="clearFilters()">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
        </div>
        
        <div class="view-controls">
            <div class="results-info" id="results-info">
                <!-- Results count will be shown here -->
            </div>
        </div>
    </div>

    <!-- Resources Container -->
    <div class="resources-container">
        <div id="loading" class="loading-state" style="display: none;">
            <div class="spinner"></div>
            <p>Loading resources...</p>
        </div>
        
        <div id="error-message" class="error-state" style="display: none;"></div>
        
        <!-- Table View -->
        <div class="modern-table">
            <table class="resources-table" id="unrecognized-resources-table">
                <thead>
                    <tr>
                        <th class="col-resource">Resource</th>
                        <th class="col-type">Type</th>
                        <th class="col-provider">Provider</th>
                        <th class="col-user">User</th>
                        <th class="col-discovered">Discovered</th>
                        <th class="col-status">Status</th>
                        <th class="col-actions">Actions</th>
                    </tr>
                </thead>
                <tbody id="unrecognized-resources-tbody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div class="pagination-container" id="pagination-nav" style="display: none;">
            <div class="pagination" id="pagination">
                <!-- Pagination will be generated here -->
            </div>
        </div>
    </div>
</div>

<!-- Resolution Modal -->
<div class="modal fade" id="resolveModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mark as Resolved</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="resolution-notes">Resolution Notes (Optional)</label>
                    <textarea class="form-control" id="resolution-notes" rows="3" 
                              placeholder="Add notes about how this resource type was resolved..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="resolveResource()">Mark as Resolved</button>
            </div>
        </div>
    </div>
</div>

<!-- Billing Data Modal -->
<div class="modal fade" id="billingDataModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Raw Billing Data</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <pre id="billing-data-content" class="bg-light p-3" style="max-height: 400px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentResourceId = null;

// Load unrecognized resources on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUnrecognizedResources();
});

function loadUnrecognizedResources(page = 1) {
    currentPage = page;
    
    const search = document.getElementById('search').value;
    const provider = document.getElementById('provider-filter').value;
    const resourceType = document.getElementById('resource-type-filter').value;
    const resolved = document.getElementById('resolved-filter').value;
    
    const params = new URLSearchParams({
        page: page,
        per_page: 20,
        ...(search && { search }),
        ...(provider && { provider }),
        ...(resourceType && { resource_type: resourceType }),
        ...(resolved && { resolved })
    });
    
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error-message').style.display = 'none';
    
    fetch(`/api/admin/unrecognized-resources?${params}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            
            if (data.success) {
                displayUnrecognizedResources(data.data);
                updatePagination(data.pagination);
                updateResultsInfo(data.pagination);
            } else {
                showError(data.error || 'Failed to load unrecognized resources');
            }
        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            showError('Network error: ' + error.message);
        });
}

function displayUnrecognizedResources(resources) {
    const tbody = document.getElementById('unrecognized-resources-tbody');
    
    if (resources.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="empty-state-cell">
                    <div class="empty-results">
                        <i class="fas fa-search"></i>
                        <h3>No unrecognized resources found</h3>
                        <p>Try adjusting your filters or check back later for new discoveries.</p>
                    </div>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = resources.map(resource => `
        <tr class="resource-row">
            <td class="col-resource">
                <div class="resource-info">
                    <div class="resource-name">${resource.resource_name || 'Unknown'}</div>
                    <div class="resource-id">ID: ${resource.resource_id}</div>
                </div>
            </td>
            <td class="col-type">
                <span class="resource-type-badge">${resource.resource_type || 'unknown'}</span>
            </td>
            <td class="col-provider">
                <div class="provider-info">
                    <div class="provider-name">${resource.provider ? resource.provider.provider_type.toUpperCase() : 'Unknown'}</div>
                    <div class="provider-connection">${resource.provider ? resource.provider.connection_name : ''}</div>
                </div>
            </td>
            <td class="col-user">
                <div class="user-info">
                    <div class="user-email">${resource.user ? resource.user.email : 'Unknown'}</div>
                    <div class="user-name">${resource.user ? (resource.user.first_name + ' ' + resource.user.last_name).trim() : ''}</div>
                </div>
            </td>
            <td class="col-discovered">
                <div class="discovery-info">
                    <div class="discovery-date">${new Date(resource.discovered_at).toLocaleDateString()}</div>
                    <div class="discovery-time">${new Date(resource.discovered_at).toLocaleTimeString()}</div>
                </div>
            </td>
            <td class="col-status">
                <span class="status-badge ${resource.is_resolved ? 'resolved' : 'unresolved'}">
                    ${resource.is_resolved ? 'Resolved' : 'Unresolved'}
                </span>
            </td>
            <td class="col-actions">
                <div class="action-buttons">
                    <button class="action-btn view-btn" onclick="viewBillingData(${resource.id}, \`${escapeHtml(resource.billing_data)}\`)" title="View billing data">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${!resource.is_resolved ? `
                        <button class="action-btn resolve-btn" onclick="openResolveModal(${resource.id})" title="Mark as resolved">
                            <i class="fas fa-check"></i>
                        </button>
                    ` : ''}
                    <button class="action-btn delete-btn" onclick="deleteResource(${resource.id})" title="Delete resource">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}


function updatePagination(pagination) {
    const nav = document.getElementById('pagination-nav');
    const paginationUl = document.getElementById('pagination');
    
    if (pagination.pages <= 1) {
        nav.style.display = 'none';
        return;
    }
    
    nav.style.display = 'block';
    
    let html = '';
    
    // Previous button
    if (pagination.has_prev) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadUnrecognizedResources(${pagination.page - 1})">Previous</a></li>`;
    } else {
        html += `<li class="page-item disabled"><span class="page-link">Previous</span></li>`;
    }
    
    // Page numbers
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.pages, pagination.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === pagination.page) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadUnrecognizedResources(${i})">${i}</a></li>`;
        }
    }
    
    // Next button
    if (pagination.has_next) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadUnrecognizedResources(${pagination.page + 1})">Next</a></li>`;
    } else {
        html += `<li class="page-item disabled"><span class="page-link">Next</span></li>`;
    }
    
    paginationUl.innerHTML = html;
}

function openResolveModal(resourceId) {
    currentResourceId = resourceId;
    document.getElementById('resolution-notes').value = '';
    $('#resolveModal').modal('show');
}

function resolveResource() {
    if (!currentResourceId) return;
    
    const notes = document.getElementById('resolution-notes').value;
    
    fetch(`/api/admin/unrecognized-resources/${currentResourceId}/resolve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            resolution_notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#resolveModal').modal('hide');
            loadUnrecognizedResources(currentPage);
            showSuccess(data.message);
        } else {
            showError(data.error || 'Failed to resolve resource');
        }
    })
    .catch(error => {
        showError('Network error: ' + error.message);
    });
}

function deleteResource(resourceId) {
    if (!confirm('Are you sure you want to delete this unrecognized resource? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/admin/unrecognized-resources/${resourceId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadUnrecognizedResources(currentPage);
            showSuccess(data.message);
        } else {
            showError(data.error || 'Failed to delete resource');
        }
    })
    .catch(error => {
        showError('Network error: ' + error.message);
    });
}

function viewBillingData(resourceId, billingData) {
    document.getElementById('billing-data-content').textContent = billingData;
    $('#billingDataModal').modal('show');
}

function clearFilters() {
    document.getElementById('search').value = '';
    document.getElementById('provider-filter').value = '';
    document.getElementById('resource-type-filter').value = '';
    document.getElementById('resolved-filter').value = '';
    loadUnrecognizedResources(1);
}

function showError(message) {
    const errorDiv = document.getElementById('error-message');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

function showSuccess(message) {
    // You can implement a toast notification here
    alert(message); // Simple alert for now
}


function updateResultsInfo(pagination) {
    const resultsInfo = document.getElementById('results-info');
    const start = (pagination.page - 1) * pagination.per_page + 1;
    const end = Math.min(pagination.page * pagination.per_page, pagination.total);
    
    if (pagination.total === 0) {
        resultsInfo.innerHTML = 'No results found';
    } else {
        resultsInfo.innerHTML = `Showing ${start}-${end} of ${pagination.total} resources`;
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
</div>
{% endblock %}
