{% extends "base.html" %}

{% block title %}Unrecognized Resources - Admin Dashboard{% endblock %}

{% block page_title %}{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-title">
        <h1>Unrecognized Resources</h1>
        <p>Resources that appear in billing data but are not recognized by our platform</p>
    </div>
</div>

<div class="admin-content">
    <!-- Filters -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="search">Search</label>
                                <input type="text" class="form-control" id="search" placeholder="Resource name or ID">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="provider-filter">Provider</label>
                                <select class="form-control" id="provider-filter">
                                    <option value="">All Providers</option>
                                    <option value="1">Beget</option>
                                    <option value="2">Selectel</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="resource-type-filter">Resource Type</label>
                                <select class="form-control" id="resource-type-filter">
                                    <option value="">All Types</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="resolved-filter">Status</label>
                                <select class="form-control" id="resolved-filter">
                                    <option value="">All</option>
                                    <option value="false">Unresolved</option>
                                    <option value="true">Resolved</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label>&nbsp;</label>
                                <div>
                                    <button class="btn btn-primary" onclick="loadUnrecognizedResources()">Filter</button>
                                    <button class="btn btn-secondary" onclick="clearFilters()">Clear</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Unrecognized Resources Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Unrecognized Resources</h5>
                </div>
                <div class="card-body">
                    <div id="loading" class="text-center py-4" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                    
                    <div id="error-message" class="alert alert-danger" style="display: none;"></div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped" id="unrecognized-resources-table">
                            <thead>
                                <tr>
                                    <th>Resource Name</th>
                                    <th>Resource Type</th>
                                    <th>Provider</th>
                                    <th>User</th>
                                    <th>Discovered</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="unrecognized-resources-tbody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <nav id="pagination-nav" style="display: none;">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Pagination will be generated here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resolution Modal -->
<div class="modal fade" id="resolveModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Mark as Resolved</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="resolution-notes">Resolution Notes (Optional)</label>
                    <textarea class="form-control" id="resolution-notes" rows="3" 
                              placeholder="Add notes about how this resource type was resolved..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="resolveResource()">Mark as Resolved</button>
            </div>
        </div>
    </div>
</div>

<!-- Billing Data Modal -->
<div class="modal fade" id="billingDataModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Raw Billing Data</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <pre id="billing-data-content" class="bg-light p-3" style="max-height: 400px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentResourceId = null;

// Load unrecognized resources on page load
document.addEventListener('DOMContentLoaded', function() {
    loadUnrecognizedResources();
});

function loadUnrecognizedResources(page = 1) {
    currentPage = page;
    
    const search = document.getElementById('search').value;
    const provider = document.getElementById('provider-filter').value;
    const resourceType = document.getElementById('resource-type-filter').value;
    const resolved = document.getElementById('resolved-filter').value;
    
    const params = new URLSearchParams({
        page: page,
        per_page: 20,
        ...(search && { search }),
        ...(provider && { provider }),
        ...(resourceType && { resource_type: resourceType }),
        ...(resolved && { resolved })
    });
    
    document.getElementById('loading').style.display = 'block';
    document.getElementById('error-message').style.display = 'none';
    
    fetch(`/api/admin/unrecognized-resources?${params}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('loading').style.display = 'none';
            
            if (data.success) {
                displayUnrecognizedResources(data.data);
                updatePagination(data.pagination);
            } else {
                showError(data.error || 'Failed to load unrecognized resources');
            }
        })
        .catch(error => {
            document.getElementById('loading').style.display = 'none';
            showError('Network error: ' + error.message);
        });
}

function displayUnrecognizedResources(resources) {
    const tbody = document.getElementById('unrecognized-resources-tbody');
    
    if (resources.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    No unrecognized resources found
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = resources.map(resource => `
        <tr>
            <td>
                <div>
                    <strong>${resource.resource_name || 'Unknown'}</strong>
                    <br>
                    <small class="text-muted">ID: ${resource.resource_id}</small>
                </div>
            </td>
            <td>
                <span class="badge badge-info">${resource.resource_type || 'unknown'}</span>
            </td>
            <td>
                <div>
                    ${resource.provider ? resource.provider.provider_type.toUpperCase() : 'Unknown'}
                    <br>
                    <small class="text-muted">${resource.provider ? resource.provider.connection_name : ''}</small>
                </div>
            </td>
            <td>
                <div>
                    ${resource.user ? resource.user.email : 'Unknown'}
                    <br>
                    <small class="text-muted">${resource.user ? (resource.user.first_name + ' ' + resource.user.last_name).trim() : ''}</small>
                </div>
            </td>
            <td>
                <div>
                    ${new Date(resource.discovered_at).toLocaleDateString()}
                    <br>
                    <small class="text-muted">${new Date(resource.discovered_at).toLocaleTimeString()}</small>
                </div>
            </td>
            <td>
                ${resource.is_resolved 
                    ? '<span class="badge badge-success">Resolved</span>' 
                    : '<span class="badge badge-warning">Unresolved</span>'
                }
            </td>
            <td>
                <div class="btn-group" role="group">
                    <button class="btn btn-sm btn-info" onclick="viewBillingData(${resource.id}, \`${escapeHtml(resource.billing_data)}\`)">
                        <i class="fas fa-eye"></i>
                    </button>
                    ${!resource.is_resolved ? `
                        <button class="btn btn-sm btn-success" onclick="openResolveModal(${resource.id})">
                            <i class="fas fa-check"></i>
                        </button>
                    ` : ''}
                    <button class="btn btn-sm btn-danger" onclick="deleteResource(${resource.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function updatePagination(pagination) {
    const nav = document.getElementById('pagination-nav');
    const paginationUl = document.getElementById('pagination');
    
    if (pagination.pages <= 1) {
        nav.style.display = 'none';
        return;
    }
    
    nav.style.display = 'block';
    
    let html = '';
    
    // Previous button
    if (pagination.has_prev) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadUnrecognizedResources(${pagination.page - 1})">Previous</a></li>`;
    } else {
        html += `<li class="page-item disabled"><span class="page-link">Previous</span></li>`;
    }
    
    // Page numbers
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.pages, pagination.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        if (i === pagination.page) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="loadUnrecognizedResources(${i})">${i}</a></li>`;
        }
    }
    
    // Next button
    if (pagination.has_next) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="loadUnrecognizedResources(${pagination.page + 1})">Next</a></li>`;
    } else {
        html += `<li class="page-item disabled"><span class="page-link">Next</span></li>`;
    }
    
    paginationUl.innerHTML = html;
}

function openResolveModal(resourceId) {
    currentResourceId = resourceId;
    document.getElementById('resolution-notes').value = '';
    $('#resolveModal').modal('show');
}

function resolveResource() {
    if (!currentResourceId) return;
    
    const notes = document.getElementById('resolution-notes').value;
    
    fetch(`/api/admin/unrecognized-resources/${currentResourceId}/resolve`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            resolution_notes: notes
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#resolveModal').modal('hide');
            loadUnrecognizedResources(currentPage);
            showSuccess(data.message);
        } else {
            showError(data.error || 'Failed to resolve resource');
        }
    })
    .catch(error => {
        showError('Network error: ' + error.message);
    });
}

function deleteResource(resourceId) {
    if (!confirm('Are you sure you want to delete this unrecognized resource? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/admin/unrecognized-resources/${resourceId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadUnrecognizedResources(currentPage);
            showSuccess(data.message);
        } else {
            showError(data.error || 'Failed to delete resource');
        }
    })
    .catch(error => {
        showError('Network error: ' + error.message);
    });
}

function viewBillingData(resourceId, billingData) {
    document.getElementById('billing-data-content').textContent = billingData;
    $('#billingDataModal').modal('show');
}

function clearFilters() {
    document.getElementById('search').value = '';
    document.getElementById('provider-filter').value = '';
    document.getElementById('resource-type-filter').value = '';
    document.getElementById('resolved-filter').value = '';
    loadUnrecognizedResources(1);
}

function showError(message) {
    const errorDiv = document.getElementById('error-message');
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

function showSuccess(message) {
    // You can implement a toast notification here
    alert(message); // Simple alert for now
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
</div>
{% endblock %}
