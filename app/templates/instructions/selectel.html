{% extends "instructions_base.html" %}

{% block title %}Инструкция по подключению Selectel{% endblock %}

{% block content %}
<div class="container">
    <h1><i class="fa-solid fa-book"></i>Инструкция по подключению Selectel</h1>
    <p class="subtitle">Пошаговое руководство для интеграции Selectel с InfraZen</p>

    <!-- Prerequisites -->
    <div class="section">
        <h2><i class="fa-solid fa-clipboard-check"></i>Требования</h2>
        <ul>
            <li>Активный аккаунт Selectel</li>
            <li>Доступ к панели управления Selectel</li>
        </ul>
    </div>

    <!-- Step 1: Get API Key -->
    <div class="section">
        <h2><span class="step-number">1</span>Получение API ключа</h2>
        
        <ol>
            <li>Войдите в <a href="https://my.selectel.ru" target="_blank">панель управления Selectel</a></li>
            <li>В верхнем меню перейдите в раздел <strong>"Аккаунт"</strong></li>
            <li>В левом боковом меню выберите <strong>"Доступ"</strong></li>
            <li>Перейдите на вкладку <strong>"API-ключи"</strong></li>
            <li>Нажмите кнопку <strong>"Добавить ключ"</strong></li>
        </ol>
        
        <img src="{{ url_for('static', filename='instructions/selectel_step_1.png') }}" 
             alt="Selectel панель управления - раздел API-ключи" 
             class="instruction-image">
        <p class="image-caption">Раздел управления API-ключами: Аккаунт → Доступ → API-ключи</p>
        
        <ol start="6">
            <li>Задайте имя для ключа (например, "InfraZen")</li>
            <li>Скопируйте сгенерированный API ключ</li>
        </ol>
        
        <div class="notice notice-warning">
            <i class="fa-solid fa-exclamation-triangle"></i>
            <strong>Важно:</strong> Сохраните API ключ в безопасном месте. Он показывается только один раз после создания!
        </div>
    </div>

    <!-- Step 2: Create Service User -->
    <div class="section">
        <h2><span class="step-number">2</span>Создание сервисного пользователя</h2>
        
        <p>Сервисный пользователь необходим для доступа к OpenStack API (статистика VM, диски, сети).</p>
        
        <ol>
            <li>В верхнем меню перейдите в раздел <strong>"Аккаунт"</strong></li>
            <li>В левом боковом меню выберите <strong>"Сервисные пользователи"</strong></li>
            <li>Нажмите кнопку <strong>"Добавить сервисного пользователя"</strong></li>
        </ol>
        
        <img src="{{ url_for('static', filename='instructions/selectel_step_2.png') }}" 
             alt="Selectel панель управления - раздел Сервисные пользователи" 
             class="instruction-image">
        <p class="image-caption">Раздел управления сервисными пользователями: Аккаунт → Сервисные пользователи</p>
        
        <p>В открывшейся форме создания сервисного пользователя:</p>
        
        <ol start="4">
            <li>Укажите имя пользователя (например, <code>infrazen-service</code>)</li>
            <li>Создайте надежный пароль</li>
            <li><strong>Критически важно:</strong> Назначьте роль <strong>"member"</strong> на уровне аккаунта или проекта</li>
            <li>Нажмите <strong>"Создать"</strong></li>
            <li>Сохраните имя пользователя и пароль для использования в InfraZen</li>
        </ol>
        
        <img src="{{ url_for('static', filename='instructions/selectel_step_3.png') }}" 
             alt="Selectel форма создания сервисного пользователя" 
             class="instruction-image">
        <p class="image-caption">Форма создания сервисного пользователя: укажите имя, пароль и роль "member"</p>
        
        <div class="notice notice-warning">
            <i class="fa-solid fa-exclamation-triangle"></i>
            <strong>Распространенная ошибка:</strong> Роль "reader" НЕ работает. Обязательно используйте роль "member" для получения статистики использования CPU и памяти.
        </div>
    </div>

    <!-- Step 3: Add Connection -->
    <div class="section">
        <h2><span class="step-number">3</span>Добавление подключения в InfraZen</h2>
        
        <ol>
            <li>Перейдите в раздел <strong>"Подключения"</strong></li>
            <li>Нажмите кнопку <strong>"+ Добавить подключение"</strong></li>
            <li>Выберите провайдера <strong>"Selectel"</strong> из выпадающего списка</li>
            <li>Заполните все поля:
                <ul>
                    <li><strong>Название подключения:</strong> Любое удобное имя (например, "Selectel Production")</li>
                    <li><strong>API Key:</strong> Ключ из шага 1</li>
                    <li><strong>Service Username:</strong> Имя пользователя из шага 2</li>
                    <li><strong>Service Password:</strong> Пароль пользователя из шага 2</li>
                </ul>
            </li>
            <li><strong>Обязательно:</strong> Нажмите <strong>"Тест подключения"</strong> — должны пройти оба теста ✅:
                <ul>
                    <li>API Key (доступ к биллингу)</li>
                    <li>OpenStack (доступ к инфраструктуре)</li>
                </ul>
            </li>
            <li>Если оба теста успешны, нажмите <strong>"Сохранить"</strong></li>
        </ol>
        
        <div class="notice notice-warning">
            <i class="fa-solid fa-exclamation-triangle"></i>
            <strong>Важно:</strong> Всегда тестируйте подключение перед сохранением! Это гарантирует правильную настройку API Key и сервисного пользователя с ролью "member".
        </div>
    </div>

    <!-- Step 4: Sync -->
    <div class="section">
        <h2><span class="step-number">4</span>Синхронизация данных</h2>
        
        <p>После сохранения подключения вы можете запустить синхронизацию одним из способов:</p>
        
        <h3>Вариант 1: Ручная синхронизация (рекомендуется для первого раза)</h3>
        <ul>
            <li><strong>Синхронизация конкретного провайдера:</strong> На карточке подключения нажмите кнопку <strong>"Синхронизировать"</strong></li>
            <li><strong>Полная синхронизация:</strong> В разделе "Подключения" нажмите <strong>"Синхронизировать все"</strong></li>
        </ul>
        
        <h3>Вариант 2: Автоматическая синхронизация</h3>
        <p>InfraZen автоматически синхронизирует данные каждое утро по расписанию.</p>
        
        <h3>Что будет синхронизировано:</h3>
        <ul>
            <li>Виртуальные машины (VM) с полными деталями (CPU, RAM, IP-адреса)</li>
            <li>Статистику использования CPU и памяти (за последние 30 дней)</li>
            <li>Диски и объемы хранения</li>
            <li>Load Balancers</li>
            <li>Kubernetes кластеры</li>
            <li>Базы данных</li>
            <li>Точную стоимость из биллинга</li>
        </ul>
        
        <div class="notice notice-info">
            <i class="fa-solid fa-lightbulb"></i>
            <strong>Совет:</strong> Первая синхронизация занимает 1-3 минуты. Сбор статистики добавляет ~30 секунд на каждую VM. Рекомендуется запустить её вручную сразу после добавления подключения.
        </div>
    </div>

    <!-- Support -->
    <div class="section">
        <h2><i class="fa-solid fa-life-ring"></i>Нужна помощь?</h2>
        <p>
            Если у вас возникли проблемы, ознакомьтесь с 
            <a href="https://docs.selectel.ru" target="_blank">документацией Selectel</a> 
            или свяжитесь с нашей службой поддержки.
        </p>
    </div>

    <!-- Back Button -->
    <div class="actions">
        <button onclick="window.close()" class="btn btn-secondary">
            <i class="fa-solid fa-arrow-left"></i> Закрыть
        </button>
    </div>
</div>
{% endblock %}
