{% extends "instructions_base.html" %}

{% block title %}Инструкция по подключению Yandex Cloud{% endblock %}

{% block content %}
<div class="container">
    <h1><i class="fa-solid fa-book"></i>Инструкция по подключению Yandex Cloud</h1>
    <p class="subtitle">Пошаговое руководство для интеграции Yandex Cloud с InfraZen</p>

    <!-- Prerequisites -->
    <div class="section">
        <h2><i class="fa-solid fa-clipboard-check"></i>Требования</h2>
        <ul>
            <li>Активный аккаунт Yandex Cloud</li>
            <li>Доступ к консоли Yandex Cloud</li>
            <li>Права на создание сервисных аккаунтов (роль <code>admin</code> или <code>editor</code> на каталог/облако)</li>
        </ul>
    </div>

    <!-- Step 1: Create Service Account -->
    <div class="section">
        <h2><span class="step-number">1</span>Создание сервисного аккаунта</h2>
        
        <p>Сервисный аккаунт необходим для безопасного доступа InfraZen к вашим ресурсам в Yandex Cloud.</p>
        
        <ol>
            <li>Откройте <a href="https://console.cloud.yandex.ru" target="_blank">консоль Yandex Cloud</a></li>
            <li>Выберите нужный каталог (folder) в списке каталогов</li>
            <li>В боковом меню перейдите в раздел <strong>"Сервисные аккаунты"</strong></li>
            <li>Нажмите кнопку <strong>"Создать сервисный аккаунт"</strong></li>
        </ol>
        
        <img src="{{ url_for('static', filename='instructions/yandex_1.png') }}" 
             alt="Yandex Cloud консоль - раздел Сервисные аккаунты" 
             class="instruction-image">
        <p class="image-caption">Раздел управления сервисными аккаунтами: Каталог → Сервисные аккаунты</p>
        
        <p>В открывшейся форме создания сервисного аккаунта:</p>
        
        <ol start="5">
            <li>Укажите имя аккаунта (например, <code>infrazen-service</code>)</li>
            <li>Добавьте описание (например, "Сервисный аккаунт для InfraZen")</li>
            <li><strong>Важно:</strong> Назначьте роль <strong>"viewer"</strong> на уровне каталога или облака:
                <ul>
                    <li><code>viewer</code> — минимально необходимая роль для чтения информации о ресурсах</li>
                    <li><code>monitoring.viewer</code> — опционально, для доступа к метрикам мониторинга</li>
                </ul>
            </li>
            <li>Нажмите <strong>"Создать"</strong></li>
        </ol>
        
        <img src="{{ url_for('static', filename='instructions/yandex_2.png') }}" 
             alt="Yandex Cloud форма создания сервисного аккаунта" 
             class="instruction-image">
        <p class="image-caption">Форма создания сервисного аккаунта: укажите имя и роль "viewer"</p>
        
        <img src="{{ url_for('static', filename='instructions/yandex_3.png') }}" 
             alt="Yandex Cloud назначение роли сервисному аккаунту" 
             class="instruction-image">
        <p class="image-caption">Назначение роли "viewer" сервисному аккаунту</p>
        
        <div class="notice notice-info">
            <i class="fa-solid fa-lightbulb"></i>
            <strong>Совет:</strong> Роль <code>viewer</code> предоставляет доступ только для чтения — InfraZen не сможет изменить или удалить ваши ресурсы.
        </div>
    </div>

    <!-- Step 2: Create Authorized Key -->
    <div class="section">
        <h2><span class="step-number">2</span>Создание авторизованного ключа</h2>
        
        <p>Авторизованный ключ (Authorized Key) используется для аутентификации сервисного аккаунта.</p>
        
        <ol>
            <li>В списке сервисных аккаунтов найдите созданный аккаунт</li>
            <li>Нажмите на имя аккаунта для открытия его страницы</li>
            <li>Перейдите на вкладку <strong>"Авторизованные ключи"</strong></li>
            <li>Нажмите кнопку <strong>"Создать новый ключ"</strong></li>
            <li>Выберите тип ключа: <strong>"Создать авторизованный ключ"</strong></li>
        </ol>
        
        <ol start="6">
            <li>В диалоге создания ключа:
                <ul>
                    <li>Укажите описание ключа (например, "InfraZen Integration")</li>
                    <li>Алгоритм: оставьте <strong>RSA-2048</strong> (по умолчанию)</li>
                </ul>
            </li>
            <li>Нажмите <strong>"Создать"</strong></li>
            <li><strong>Критически важно:</strong> Скопируйте весь JSON-ключ из появившегося окна</li>
        </ol>
        
        <img src="{{ url_for('static', filename='instructions/yandex_4.png') }}" 
             alt="Yandex Cloud окно с авторизованным ключом" 
             class="instruction-image">
        <p class="image-caption">Окно с созданным авторизованным ключом (JSON) — скопируйте полностью</p>
        
        <img src="{{ url_for('static', filename='instructions/yandex_5.png') }}" 
             alt="InfraZen - вставка JSON ключа в форму подключения" 
             class="instruction-image">
        <p class="image-caption">Вставьте скопированный JSON-ключ в поле "Service Account Key" в InfraZen</p>
        
        <div class="notice notice-warning">
            <i class="fa-solid fa-exclamation-triangle"></i>
            <strong>Важно:</strong> Ключ показывается только один раз! Обязательно сохраните его в безопасном месте. Если потеряете ключ, придется создать новый.
        </div>
        
        <div class="notice notice-info">
            <i class="fa-solid fa-info-circle"></i>
            <strong>Формат ключа:</strong> JSON-файл содержит ID ключа, ID сервисного аккаунта и приватный ключ. InfraZen использует этот ключ для генерации IAM-токенов.
        </div>
    </div>

    <!-- Step 3: Add Connection -->
    <div class="section">
        <h2><span class="step-number">3</span>Добавление подключения в InfraZen</h2>
        
        <ol>
            <li>Перейдите в раздел <strong>"Подключения"</strong> в InfraZen</li>
            <li>Нажмите кнопку <strong>"+ Добавить подключение"</strong></li>
            <li>Выберите провайдера <strong>"Yandex Cloud"</strong> из выпадающего списка</li>
            <li>Заполните поля:
                <ul>
                    <li><strong>Название подключения:</strong> Любое удобное имя (например, "Yandex Production")</li>
                    <li><strong>Service Account Key (JSON):</strong> Вставьте полностью скопированный JSON-ключ из шага 2</li>
                    <li><strong>Описание:</strong> Опционально, для ваших заметок</li>
                </ul>
            </li>
            <li><strong>Обязательно:</strong> Нажмите <strong>"Тест подключения"</strong> — должна появиться галочка ✅</li>
            <li>Если тест успешен, нажмите <strong>"Сохранить"</strong></li>
        </ol>
        
        <div class="notice notice-warning">
            <i class="fa-solid fa-exclamation-triangle"></i>
            <strong>Важно:</strong> Всегда тестируйте подключение перед сохранением! Это гарантирует, что JSON-ключ корректный и сервисный аккаунт имеет необходимые права.
        </div>
        
        <h3>Возможные ошибки при тестировании:</h3>
        <ul>
            <li><strong>"Invalid JSON format"</strong> — проверьте, что скопировали весь JSON целиком</li>
            <li><strong>"No credentials provided"</strong> — JSON-ключ не содержит необходимых полей</li>
            <li><strong>"Permission denied"</strong> — сервисный аккаунт не имеет роли <code>viewer</code></li>
            <li><strong>"IAM token generation failed"</strong> — проблема с приватным ключом, создайте новый</li>
        </ul>
    </div>

    <!-- Step 4: Sync -->
    <div class="section">
        <h2><span class="step-number">4</span>Синхронизация данных</h2>
        
        <p>После сохранения подключения вы можете запустить синхронизацию одним из способов:</p>
        
        <h3>Вариант 1: Ручная синхронизация (рекомендуется для первого раза)</h3>
        <ul>
            <li><strong>Синхронизация конкретного провайдера:</strong> На карточке подключения нажмите кнопку <strong>"Синхронизировать"</strong></li>
            <li><strong>Полная синхронизация:</strong> В разделе "Подключения" нажмите <strong>"Синхронизировать все"</strong></li>
        </ul>
        
        <h3>Вариант 2: Автоматическая синхронизация</h3>
        <p>InfraZen автоматически синхронизирует данные каждое утро по расписанию.</p>
        
        <h3>Что будет синхронизировано:</h3>
        <ul>
            <li><strong>Виртуальные машины (Compute Cloud):</strong> полные характеристики (CPU, RAM, диски, IP-адреса)</li>
            <li><strong>Статистика CPU:</strong> графики использования за последние 30 дней</li>
            <li><strong>Диски (Block Storage):</strong> все диски, включая orphan-диски (не привязанные к VM)</li>
            <li><strong>Сети и подсети (VPC):</strong> структура сетевой инфраструктуры</li>
            <li><strong>Оценка стоимости:</strong> расчет затрат на основе тарифов Yandex Cloud</li>
        </ul>
        
        <div class="notice notice-info">
            <i class="fa-solid fa-lightbulb"></i>
            <strong>Совет:</strong> Первая синхронизация занимает 30-60 секунд в зависимости от количества ресурсов. Сбор статистики CPU добавляет ~2-3 секунды на каждую VM.
        </div>
        
        <h3>Что пока недоступно (требует Yandex Unified Agent):</h3>
        <ul>
            <li>Статистика использования памяти (RAM)</li>
            <li>Статистика использования дискового пространства (Disk Usage)</li>
        </ul>
        
        <div class="notice notice-coming-soon">
        <i class="fa-solid fa-hourglass-half"></i>
            <strong>В разработке:</strong> Интеграция с Yandex Billing API для получения реальных затрат (вместо оценки). Сейчас стоимость рассчитывается на основе прайс-листа.
        </div>
    </div>

    <!-- Permissions Guide -->
    <div class="section">
        <h2><i class="fa-solid fa-shield-halved"></i>Права доступа и безопасность</h2>
        
        <h3>Минимальные права для работы InfraZen:</h3>
        <ul>
            <li><code>viewer</code> — просмотр всех ресурсов в каталоге</li>
            <li><code>monitoring.viewer</code> (опционально) — доступ к метрикам CPU/RAM</li>
        </ul>
        
        <h3>Уровни назначения прав:</h3>
        <ul>
            <li><strong>Каталог (folder):</strong> InfraZen увидит только ресурсы в этом каталоге</li>
            <li><strong>Облако (cloud):</strong> InfraZen увидит все каталоги в облаке</li>
            <li><strong>Организация:</strong> InfraZen увидит все облака в организации</li>
        </ul>
        
        <div class="notice notice-info">
            <i class="fa-solid fa-shield-check"></i>
            <strong>Безопасность:</strong> InfraZen работает в режиме "только чтение" и не может изменять, создавать или удалять ваши ресурсы в Yandex Cloud.
        </div>
        
        <h3>Smart Folder Discovery:</h3>
        <p>Если у сервисного аккаунта есть права только на один каталог (но нет прав на уровне облака), InfraZen автоматически обнаружит этот каталог и покажет его ресурсы.</p>
    </div>

    <!-- Troubleshooting -->
    <div class="section">
        <h2><i class="fa-solid fa-wrench"></i>Решение проблем</h2>
        
        <h3>Подключение не проходит тест:</h3>
        <ol>
            <li>Убедитесь, что скопировали весь JSON-ключ целиком (включая фигурные скобки)</li>
            <li>Проверьте, что сервисный аккаунт имеет роль <code>viewer</code></li>
            <li>Убедитесь, что роль назначена на нужный каталог/облако</li>
            <li>Если ошибка "IAM token generation failed" — создайте новый авторизованный ключ</li>
        </ol>
        
        <h3>Синхронизация не находит ресурсы:</h3>
        <ol>
            <li>Проверьте, что VM находятся в том же каталоге, на который назначена роль</li>
            <li>Убедитесь, что VM находятся в статусе RUNNING</li>
            <li>Проверьте права сервисного аккаунта в консоли Yandex Cloud</li>
        </ol>
        
        <h3>Не отображается статистика CPU:</h3>
        <ol>
            <li>VM должна работать минимум несколько часов для накопления метрик</li>
            <li>Проверьте, что у сервисного аккаунта есть роль <code>monitoring.viewer</code></li>
            <li>Запустите синхронизацию повторно через 24 часа</li>
        </ol>
    </div>

    <!-- Support -->
    <div class="section">
        <h2><i class="fa-solid fa-life-ring"></i>Нужна помощь?</h2>
        <p>
            Если у вас возникли проблемы, ознакомьтесь с 
            <a href="https://cloud.yandex.ru/docs" target="_blank">документацией Yandex Cloud</a> 
            или свяжитесь с нашей службой поддержки.
        </p>
        
        <h3>Полезные ссылки:</h3>
        <ul>
            <li><a href="https://cloud.yandex.ru/docs/iam/operations/sa/create" target="_blank">Создание сервисного аккаунта</a></li>
            <li><a href="https://cloud.yandex.ru/docs/iam/operations/sa/create-access-key" target="_blank">Создание авторизованного ключа</a></li>
            <li><a href="https://cloud.yandex.ru/docs/iam/concepts/authorization/key" target="_blank">О форматах ключей</a></li>
            <li><a href="https://cloud.yandex.ru/docs/monitoring/" target="_blank">Yandex Monitoring API</a></li>
        </ul>
    </div>

    <!-- Back Button -->
    <div class="actions">
        <button onclick="window.close()" class="btn btn-secondary">
            <i class="fa-solid fa-arrow-left"></i> Закрыть
        </button>
    </div>
</div>
{% endblock %}
