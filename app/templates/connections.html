{% extends "base.html" %}

{% block title %}Подключения облаков - InfraZen FinOps Platform{% endblock %}

{% block page_title %}Подключения облаков{% endblock %}
{% block page_subtitle %}Управление подключениями к облачным провайдерам{% endblock %}

{% block header_actions %}
    <div class="header-actions">
        <button class="btn btn-secondary"><i class="fa-solid fa-arrows-rotate"></i><span>Обновить все</span></button>
        <button class="btn btn-primary" onclick="showProviderModal()"><i class="fa-solid fa-plus"></i><span>Добавить провайдера</span></button>
    </div>
{% endblock %}

{% block content %}
<div class="connections-content">
    <div class="connections-summary">
        <div class="summary-header">
        </div>
        <div class="summary-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fa-solid fa-cloud"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ providers|length }}</span>
                    <span class="stat-label">Всего подключений</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon active">
                    <i class="fa-solid fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ providers|selectattr('status', 'equalto', 'connected')|list|length }}</span>
                    <span class="stat-label">Активных</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon synced">
                    <i class="fa-solid fa-sync"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ providers|selectattr('last_sync', 'defined')|selectattr('last_sync', 'ne', None)|list|length }}</span>
                    <span class="stat-label">Синхронизировано</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fa-solid fa-clock"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-value">
                        {% set synced_providers = providers|selectattr('last_sync', 'defined')|selectattr('last_sync', 'ne', None)|list %}
                        {% if synced_providers|length > 0 %}
                            {% set latest_sync = synced_providers|first %}
                            {{ latest_sync.last_sync.strftime('%H:%M') }}
                        {% else %}
                            Никогда
                        {% endif %}
                    </span>
                    <span class="stat-label">Последняя синхронизация</span>
                </div>
            </div>
        </div>
    </div>

    {% if providers %}
    <div class="providers-grid">
        {% for provider in providers %}
        <article class="connection-card">
            <div class="card-header">
                <div class="provider-logo">
                    {% if provider.code == 'yc' %}
                        <div class="provider-icon yandex-cloud">
                            <i class="fa-solid fa-cloud"></i>
                        </div>
                    {% elif provider.code == 'sel' %}
                        <div class="provider-icon selectel">
                            <i class="fa-solid fa-server"></i>
                        </div>
                    {% elif provider.code == 'beget' %}
                        <div class="provider-icon beget">
                            <i class="fa-solid fa-server"></i>
                        </div>
                    {% else %}
                        <div class="provider-icon default">
                            <i class="fa-solid fa-cloud"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="provider-info">
                    <div class="provider-badge provider-{{ provider.code }}">{{ provider.code|upper }}</div>
                    <div class="provider-name">{{ provider.connection_name or provider.name }}</div>
                </div>
                <div class="connection-status">
                    {% if provider.status == 'connected' %}
                        <div class="status-badge connected">
                            <span class="status-dot"></span>
                            <span class="status-text">Подключен</span>
                        </div>
                    {% else %}
                        <div class="status-badge disconnected">
                            <span class="status-dot"></span>
                            <span class="status-text">Отключен</span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card-body">
                <div class="sync-info">
                    {% if provider.status == 'connected' %}
                        {% if provider.last_sync %}
                            <div class="sync-status success">
                                <i class="fa-solid fa-check-circle"></i>
                                <span>Синхронизирован {{ provider.last_sync.strftime('%d.%m.%Y в %H:%M') }}</span>
                            </div>
                        {% else %}
                            <div class="sync-status pending">
                                <i class="fa-solid fa-clock"></i>
                                <span>Ожидает синхронизации</span>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="sync-status error">
                            <i class="fa-solid fa-exclamation-circle"></i>
                            <span>Требуется подключение</span>
                        </div>
                    {% endif %}
                </div>

                <div class="provider-details">
                    <div class="detail-item">
                        <span class="detail-label">Добавлен:</span>
                        <span class="detail-value">{{ provider.added_at }}</span>
                    </div>
                    
                    <!-- Account Information (if available) -->
                    {% if provider.provider_metadata %}
                        {% set metadata = provider.provider_metadata|from_json %}
                        {% if metadata.account_info %}
                            {% set account = metadata.account_info %}
                            <div class="account-info-collapsible">
                                <div class="account-info-header" onclick="toggleAccountInfo('{{ provider.id }}')">
                                    <i class="fa-solid fa-user"></i>
                                    <span>Информация об аккаунте</span>
                                    <i class="fa-solid fa-chevron-down account-info-chevron" id="chevron-{{ provider.id }}"></i>
                                </div>
                                <div class="account-info-content" id="account-info-{{ provider.id }}" style="display: none;">
                                
                                {% if account.account_id %}
                                <div class="detail-item">
                                    <span class="detail-label">Аккаунт:</span>
                                    <span class="detail-value">{{ account.account_id }}</span>
                                </div>
                                {% endif %}
                                
                                {% if account.account_status %}
                                <div class="detail-item">
                                    <span class="detail-label">Статус:</span>
                                    <span class="detail-value status-{{ account.account_status|lower }}">
                                        {% if account.account_status == 'active' %}Активен
                                        {% elif account.account_status == 'suspended' %}Приостановлен
                                        {% else %}{{ account.account_status }}{% endif %}
                                    </span>
                                </div>
                                {% endif %}
                                
                                {% if account.balance is defined %}
                                <div class="detail-item">
                                    <span class="detail-label">Баланс:</span>
                                    <span class="detail-value">{{ account.balance|round(2) }} {{ account.currency or 'RUB' }}</span>
                                </div>
                                {% endif %}
                                
                                {% if account.finops_insights %}
                                <div class="detail-item">
                                    <span class="detail-label">Стоимость:</span>
                                    <span class="detail-value">
                                        {{ account.finops_insights.daily_cost|round(2) }} ₽/день
                                        {% if account.finops_insights.monthly_cost %}({{ account.finops_insights.monthly_cost|round(2) }} ₽/мес){% endif %}
                                    </span>
                                </div>
                                {% endif %}
                                
                                {% if account.days_to_block and account.days_to_block < 30 %}
                                <div class="detail-item warning">
                                    <span class="detail-label">⚠️ Блокировка:</span>
                                    <span class="detail-value">{{ account.days_to_block }} дней</span>
                                </div>
                                {% endif %}
                                
                                {% if account.service_limits %}
                                <div class="detail-item">
                                    <span class="detail-label">Лимиты:</span>
                                    <span class="detail-value">
                                        {% if account.service_limits.domains %}
                                            Доменов: {{ account.service_limits.domains.used }}/{{ account.service_limits.domains.limit if account.service_limits.domains.limit < 999999 else '∞' }}
                                        {% endif %}
                                        {% if account.service_limits.sites and account.service_limits.sites.limit > 0 %}
                                            , Сайтов: {{ account.service_limits.sites.used }}/{{ account.service_limits.sites.limit }}
                                        {% endif %}
                                        {% if account.service_limits.mysql and account.service_limits.mysql.limit > 0 %}
                                            , MySQL: {{ account.service_limits.mysql.used }}/{{ account.service_limits.mysql.limit }}
                                        {% endif %}
                                    </span>
                                </div>
                                {% endif %}
                                
                                {% if account.plan_name %}
                                <div class="detail-item">
                                    <span class="detail-label">Тариф:</span>
                                    <span class="detail-value">{{ account.plan_name }}</span>
                                </div>
                                {% endif %}
                                
                                {% if account.server_info %}
                                <div class="detail-item">
                                    <span class="detail-label">Сервер:</span>
                                    <span class="detail-value">{{ account.server_info.name }}</span>
                                </div>
                                {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                    
                    {% if provider.details %}
                        {% if provider.details.organization_id %}
                        <div class="detail-item">
                            <span class="detail-label">Организация:</span>
                            <span class="detail-value">{{ provider.details.organization_id }}</span>
                        </div>
                        {% endif %}
                        {% if provider.details.cloud_id %}
                        <div class="detail-item">
                            <span class="detail-label">Облако:</span>
                            <span class="detail-value">{{ provider.details.cloud_id }}</span>
                        </div>
                        {% endif %}
                        {% if provider.details.project_id %}
                        <div class="detail-item">
                            <span class="detail-label">Проект:</span>
                            <span class="detail-value">{{ provider.details.project_id }}</span>
                        </div>
                        {% endif %}
                        {% if provider.details.regions %}
                        <div class="detail-item">
                            <span class="detail-label">Регионы:</span>
                            <span class="detail-value">{{ provider.details.regions|join(', ') }}</span>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
                
                <!-- Provider Cost Display -->
                <div class="provider-cost">
                    <div class="cost-primary">
                        <div class="cost-amount">{{ "%.1f"|format(provider.total_daily_cost or 0) }} ₽</div>
                        <div class="cost-period">в день</div>
                    </div>
                    <div class="cost-secondary">
                        <div class="cost-amount-secondary">{{ "%.1f"|format(provider.total_monthly_cost or 0) }} ₽</div>
                        <div class="cost-period-secondary">в месяц</div>
                    </div>
                </div>
            </div>

            <div class="card-actions">
                <button class="action-btn secondary" title="Настройки" onclick="editConnection('{{ provider.id }}')">
                    <i class="fa-solid fa-gear"></i>
                    <span>Настройки</span>
                </button>
                <button class="action-btn primary" title="Синхронизировать" onclick="syncConnection('{{ provider.id }}')">
                    <i class="fa-solid fa-sync"></i>
                    <span>Синхронизировать</span>
                </button>
                <button class="action-btn danger" title="Удалить" onclick="deleteConnection('{{ provider.id }}')">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        </article>
        {% endfor %}

        <article class="connection-card add-card" id="add-provider-card">
            <div class="add-card-content">
                <div class="add-icon">
                    <i class="fa-solid fa-plus"></i>
                </div>
                <h3>Добавить провайдера</h3>
                <p>Настроить подключение нового облачного провайдера</p>
                <button class="add-btn" onclick="showProviderModal()">
                    <i class="fa-solid fa-cog"></i>
                    <span>Настроить подключение</span>
                </button>
            </div>
        </article>
    </div>

    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon"><i class="fa-solid fa-cloud"></i></div>
        <div class="empty-state-title">Нет подключений</div>
        <div class="empty-state-text">Добавьте облачных провайдеров для начала работы</div>
        <button class="btn btn-primary" onclick="showProviderModal()">Добавить первого провайдера</button>
    </div>
    {% endif %}

    <div class="available-providers">
        <h3>Доступные провайдеры</h3>
        <div class="providers-list">
            <div class="provider-option">
                <div class="provider-logo">
                    <div class="provider-icon aws">
                        <i class="fa-brands fa-aws"></i>
                    </div>
                </div>
                <div class="provider-info">
                    <span class="provider-name">Amazon Web Services</span>
                    <span class="provider-description">Ведущая облачная платформа с широким спектром сервисов</span>
                </div>
                {% if not is_demo_user %}
                <button class="btn btn-outline btn-sm" onclick="showProviderModal('aws')">Добавить</button>
                {% else %}
                <button class="btn btn-outline btn-sm" disabled title="Войдите в систему для создания подключений">Добавить</button>
                {% endif %}
            </div>
            <div class="provider-option">
                <div class="provider-logo">
                    <div class="provider-icon azure">
                        <i class="fa-brands fa-microsoft"></i>
                    </div>
                </div>
                <div class="provider-info">
                    <span class="provider-name">Microsoft Azure</span>
                    <span class="provider-description">Облачная платформа Microsoft с интеграцией Office 365</span>
                </div>
                {% if not is_demo_user %}
                <button class="btn btn-outline btn-sm" onclick="showProviderModal('azure')">Добавить</button>
                {% else %}
                <button class="btn btn-outline btn-sm" disabled title="Войдите в систему для создания подключений">Добавить</button>
                {% endif %}
            </div>
            <div class="provider-option">
                <div class="provider-logo">
                    <div class="provider-icon gcp">
                        <i class="fa-brands fa-google"></i>
                    </div>
                </div>
                <div class="provider-info">
                    <span class="provider-name">Google Cloud Platform</span>
                    <span class="provider-description">Облачная платформа Google с AI и ML сервисами</span>
                </div>
                {% if not is_demo_user %}
                <button class="btn btn-outline btn-sm" onclick="showProviderModal('gcp')">Добавить</button>
                {% else %}
                <button class="btn btn-outline btn-sm" disabled title="Войдите в систему для создания подключений">Добавить</button>
                {% endif %}
            </div>
            <div class="provider-option">
                <div class="provider-logo">
                    <div class="provider-icon vk-cloud">
                        <i class="fa-solid fa-cloud"></i>
                    </div>
                </div>
                <div class="provider-info">
                    <span class="provider-name">VK Cloud</span>
                    <span class="provider-description">Российская облачная платформа от VK</span>
                </div>
                {% if not is_demo_user %}
                <button class="btn btn-outline btn-sm" onclick="showProviderModal('vk-cloud')">Добавить</button>
                {% else %}
                <button class="btn btn-outline btn-sm" disabled title="Войдите в систему для создания подключений">Добавить</button>
                {% endif %}
            </div>
            <div class="provider-option">
                <div class="provider-logo">
                    <div class="provider-icon beget">
                        <i class="fa-solid fa-server"></i>
                    </div>
                </div>
                <div class="provider-info">
                    <span class="provider-name">Beget</span>
                    <span class="provider-description">Российский хостинг-провайдер с веб-хостингом и VPS</span>
                </div>
                {% if not is_demo_user %}
                <button class="btn btn-outline btn-sm" onclick="showProviderModal('beget')">Добавить</button>
                {% else %}
                <button class="btn btn-outline btn-sm" disabled title="Войдите в систему для создания подключений">Добавить</button>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.connections-content {
    padding: 0;
}

/* Summary Section */
.connections-summary {
    background: var(--background-white);
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.summary-header {
    margin-bottom: 1.5rem;
}

.summary-header h2 {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0 0 0.5rem 0;
}

.summary-header p {
    color: var(--text-secondary);
    margin: 0;
    font-size: 0.875rem;
}

.summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.stat-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: var(--background-light);
    border-radius: 8px;
    border: 1px solid var(--border-light);
    transition: all 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.stat-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary-blue);
    color: white;
    font-size: 1.125rem;
}

.stat-icon.active {
    background: var(--success-green);
}

.stat-icon.synced {
    background: var(--warning-orange);
}

.stat-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.stat-value {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
}

/* Connection Cards Grid */
.providers-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.connection-card {
    background: var(--background-white);
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 0;
    transition: all 0.3s ease;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    min-height: 280px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.connection-card:hover {
    border-color: var(--primary-blue);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
    transform: translateY(-2px);
}

.provider-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
}

.provider-logo {
    flex-shrink: 0;
}

.provider-icon {
    width: 36px;
    height: 36px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.125rem;
}

.provider-info {
    flex: 1;
    min-width: 0;
}

.provider-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    margin-bottom: 0.25rem;
    display: inline-block;
}

.provider-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 1.125rem;
}

/* Card Header */
.card-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.5rem 1.5rem 1rem 1.5rem;
    border-bottom: 1px solid var(--border-light);
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.02) 0%, rgba(59, 130, 246, 0.05) 100%);
}

.connection-status {
    flex-shrink: 0;
}

.status-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    white-space: nowrap;
}

.status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: currentColor;
}

.status-badge.connected {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-green);
}

.status-badge.disconnected {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error-red);
}

.status-badge.add-status {
    background: rgba(59, 130, 246, 0.1);
    color: var(--primary-blue);
}

/* Account Information Section */
.account-info-section {
    margin: 1rem 0;
    padding: 1rem;
    background: var(--background-light);
    border-radius: 8px;
    border: 1px solid var(--border-light);
}

/* Collapsible Account Info */
.account-info-collapsible {
    margin: 0.75rem 0;
    border: 1px solid var(--border-light);
    border-radius: 8px;
    background: var(--background-light);
    overflow: hidden;
}

.account-info-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    background: var(--background-light);
    border-bottom: 1px solid var(--border-light);
    cursor: pointer;
    transition: background-color 0.2s ease;
    user-select: none;
}

.account-info-header:hover {
    background: var(--background-hover);
}

.account-info-header i:first-child {
    margin-right: 0.5rem;
    color: var(--primary-blue);
}

.account-info-chevron {
    transition: transform 0.2s ease;
    color: var(--text-secondary);
}

.account-info-chevron.rotated {
    transform: rotate(180deg);
}

.account-info-content {
    padding: 1rem;
    background: white;
    border-top: 1px solid var(--border-light);
}

.section-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid var(--border-light);
}

.section-header i {
    color: var(--primary-blue);
    font-size: 1rem;
}

.status-active {
    color: var(--success-green);
    font-weight: 500;
}

.status-suspended {
    color: var(--warning-orange);
    font-weight: 500;
}

.status-unknown {
    color: var(--text-secondary);
    font-weight: 500;
}

.detail-item.warning {
    background: rgba(245, 158, 11, 0.1);
    border-left: 3px solid var(--warning-orange);
    padding-left: 0.75rem;
    margin: 0.5rem 0;
}

.detail-item.warning .detail-label {
    color: var(--warning-orange);
    font-weight: 600;
}

.detail-item.warning .detail-value {
    color: var(--warning-orange);
    font-weight: 600;
}

/* Card Body */
.card-body {
    padding: 1.5rem;
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.sync-info {
    margin-bottom: 0.5rem;
}

.sync-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-green);
}

.sync-status.pending {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning-orange);
}

.sync-status.error {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error-red);
}

.sync-status.add-status {
    background: rgba(59, 130, 246, 0.1);
    color: var(--primary-blue);
}

.sync-status i {
    font-size: 1rem;
}

.provider-details {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.detail-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-light);
    font-size: 0.875rem;
}

.detail-item:last-child {
    border-bottom: none;
}

.detail-label {
    color: var(--text-secondary);
    font-weight: 500;
}

.detail-value {
    color: var(--text-primary);
    font-weight: 500;
    font-family: monospace;
    font-size: 0.75rem;
}

/* Provider Cost Display - Matching Resource Card Style */
.provider-cost {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-light);
    background: var(--background-light);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.cost-primary {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.cost-amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary-blue);
    line-height: 1;
}

.cost-period {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
    margin-top: 0.25rem;
}

.cost-secondary {
    padding-top: 0.5rem;
    border-top: 1px solid var(--border-light);
    display: flex;
    flex-direction: column;
    align-items: center;
}

.cost-amount-secondary {
    font-size: 0.875rem;
    color: var(--text-secondary);
    font-weight: 500;
    line-height: 1;
}

.cost-period-secondary {
    font-size: 0.75rem;
    color: var(--text-secondary);
    font-weight: 400;
    margin-top: 0.125rem;
}

/* Card Actions */
.card-actions {
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-light);
    background: var(--background-light);
    display: flex;
    gap: 0.5rem;
    justify-content: center;
}

.action-btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border-light);
    background: var(--background-white);
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    color: var(--text-secondary);
    flex: 1;
    justify-content: center;
}

.action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.action-btn.primary {
    background: var(--primary-blue);
    border-color: var(--primary-blue);
    color: white;
}

.action-btn.primary:hover {
    background: #1e40af;
    border-color: #1e40af;
    color: white;
}

.action-btn.secondary {
    color: var(--text-secondary);
}

.action-btn.secondary:hover {
    background: var(--background-light);
    color: var(--text-primary);
    border-color: var(--border-light);
}

.action-btn.danger {
    color: var(--error-red);
}

.action-btn.danger:hover {
    background: rgba(239, 68, 68, 0.1);
    border-color: var(--error-red);
}

.provider-icon.yandex-cloud {
    background: rgba(255, 193, 7, 0.1);
    color: #b45309;
}

.provider-icon.selectel {
    background: rgba(59, 130, 246, 0.1);
    color: #1e40af;
}

.provider-icon.aws {
    background: rgba(255, 153, 0, 0.1);
    color: #ff9900;
}

.provider-icon.azure {
    background: rgba(0, 120, 212, 0.1);
    color: #0078d4;
}

.provider-icon.gcp {
    background: rgba(66, 133, 244, 0.1);
    color: #4285f4;
}

.provider-icon.vk-cloud {
    background: rgba(76, 175, 80, 0.1);
    color: #4caf50;
}

.provider-icon.beget {
    background: rgba(139, 69, 19, 0.1);
    color: #8b4513;
}

.provider-icon.default {
    background: var(--background-light);
    color: var(--text-secondary);
}

.provider-icon.default {
    background: var(--background-light);
    color: var(--text-secondary);
}

.provider-connection {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    font-size: 0.8rem;
    line-height: 1.3;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.status-connected .status-indicator {
    background: var(--success-green);
}

.status-disconnected .status-indicator {
    background: var(--error-red);
}

.status-connected {
    color: var(--success-green);
}

.status-disconnected {
    color: var(--error-red);
}

.provider-details {
    margin-bottom: 0.75rem;
    flex: 1;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.375rem;
    font-size: 0.8rem;
}

.detail-label {
    color: var(--text-secondary);
}

.detail-value {
    color: var(--text-primary);
    font-family: monospace;
    font-size: 0.75rem;
}

.provider-actions {
    display: flex;
    gap: 0.375rem;
    flex-wrap: wrap;
    margin-top: auto;
}

.provider-actions .btn {
    padding: 0.375rem 0.5rem;
    font-size: 0.75rem;
    flex: 1;
    min-width: 0;
    justify-content: center;
}

.provider-yc {
    background: rgba(255, 193, 7, 0.1);
    color: #b45309;
}

.provider-sel {
    background: rgba(59, 130, 246, 0.1);
    color: #1e40af;
}

.provider-beget {
    background: rgba(139, 69, 19, 0.1);
    color: #8b4513;
}

.add-card {
    border: 2px dashed var(--border-light);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 200px;
}

.add-card:hover {
    border-color: var(--primary-blue);
    background: rgba(59, 130, 246, 0.02);
}

.add-icon {
    width: 48px;
    height: 48px;
    background: var(--background-light);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: var(--text-secondary);
    margin-bottom: 0.75rem;
}

.add-card h3 {
    margin: 0 0 0.375rem 0;
    color: var(--text-primary);
    font-size: 1rem;
}

.add-card p {
    margin: 0 0 1rem 0;
    color: var(--text-secondary);
    font-size: 0.8rem;
    line-height: 1.3;
}

.provider-status {
    flex-shrink: 0;
    align-self: flex-start;
}

.status-badge {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.875rem;
    font-weight: 500;
    padding: 0.375rem 0.75rem;
    border-radius: 6px;
    white-space: nowrap;
}

.status-connected {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-green);
}

.status-disconnected {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error-red);
}

.status-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
}

.connection-status {
    margin-bottom: 1.25rem;
}

.sync-status {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    padding: 0.5rem 0.75rem;
    border-radius: 6px;
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-green);
}

.sync-status.pending {
    background: rgba(245, 158, 11, 0.1);
    color: var(--warning-orange);
}

.sync-status.disconnected {
    background: rgba(239, 68, 68, 0.1);
    color: var(--error-red);
}

.sync-status i {
    font-size: 0.875rem;
}

.provider-details {
    margin-bottom: 1.25rem;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 0;
    border-bottom: 1px solid var(--border-light);
    font-size: 0.875rem;
}

.detail-row:last-child {
    border-bottom: none;
}

.detail-label {
    color: var(--text-secondary);
    font-weight: 500;
}

.detail-value {
    color: var(--text-primary);
    font-weight: 500;
    font-family: monospace;
    font-size: 0.75rem;
}

.provider-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: center;
}

.action-button {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border-light);
    background: var(--background-white);
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    color: var(--text-secondary);
}

.action-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.action-primary {
    background: var(--primary-blue);
    border-color: var(--primary-blue);
    color: white;
}

.action-primary:hover {
    background: #1e40af;
    border-color: #1e40af;
    color: white;
}

.action-secondary {
    color: var(--text-secondary);
}

.action-secondary:hover {
    background: var(--background-light);
    color: var(--text-primary);
    border-color: var(--border-light);
}

.action-danger {
    color: var(--error-red);
}

.action-danger:hover {
    background: rgba(239, 68, 68, 0.1);
    border-color: var(--error-red);
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--border-light);
    color: var(--text-secondary);
}

.btn-outline:hover {
    background: var(--background-light);
    color: var(--text-primary);
}

.add-card {
    border: 2px dashed var(--border-light);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 280px;
}

.add-card:hover {
    border-color: var(--primary-blue);
    background: rgba(59, 130, 246, 0.02);
}

.add-icon {
    width: 64px;
    height: 64px;
    background: var(--background-light);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
}

.add-card h3 {
    margin: 0 0 0.5rem 0;
    color: var(--text-primary);
}

.add-card p {
    margin: 0 0 1.5rem 0;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.available-providers {
    background: var(--background-white);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    padding: 1.5rem;
}

.available-providers h3 {
    margin: 0 0 1rem 0;
    color: var(--text-primary);
}

.providers-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.provider-option {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border: 1px solid var(--border-light);
    border-radius: 8px;
    transition: all 0.2s;
}

.provider-option:hover {
    border-color: var(--primary-blue);
    background: rgba(59, 130, 246, 0.02);
}

.provider-option .provider-info {
    flex: 1;
}

.provider-option .provider-name {
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
    display: block;
}

.provider-option .provider-description {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.provider-option .provider-icon {
    width: 40px;
    height: 40px;
    font-size: 1.25rem;
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: var(--background-white);
    margin: 5% auto;
    padding: 0;
    border: none;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s;
}

.modal-close:hover {
    background: var(--background-light);
    color: var(--text-primary);
}

.modal-body {
    padding: 1.5rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-primary);
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    font-size: 0.875rem;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    font-size: 0.875rem;
    background-color: var(--background-white);
    cursor: pointer;
}

.form-check {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.form-check-input {
    width: 16px;
    height: 16px;
    margin: 0;
}

.form-check-label {
    font-size: 0.875rem;
    color: var(--text-primary);
    cursor: pointer;
}

.form-textarea {
    resize: vertical;
    min-height: 80px;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border-light);
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
}

.btn-lg {
    padding: 0.875rem 1.5rem;
    font-size: 1rem;
}

.provider-info-card {
    background: var(--background-light);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.provider-info-card h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
    color: var(--text-primary);
}

.provider-info-card p {
    margin: 0;
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.4;
}

.connection-test {
    background: var(--success-green);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    margin-bottom: 1rem;
    display: none;
}

.connection-test.error {
    background: var(--error-red);
}

/* Password Toggle Styles */
.password-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.password-input-wrapper .form-control {
    padding-right: 3rem;
}

.password-toggle {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 0.25rem;
    transition: color 0.2s ease;
}

.password-toggle:hover {
    color: var(--primary-blue);
}

.password-toggle:focus {
    outline: 2px solid var(--primary-blue);
    outline-offset: 2px;
}

/* Modal Form Grid Layout */
.modal-form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    max-height: 70vh;
    overflow-y: auto;
}

.modal-form-left {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.modal-form-right {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

/* Compact Provider Info */
.provider-info-compact {
    background: var(--background-light);
    border: 1px solid var(--border-light);
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
}

.provider-info-header {
    display: flex;
    align-items: center;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.provider-description-compact {
    margin: 0;
    font-size: 0.8rem;
    color: var(--text-secondary);
    line-height: 1.4;
}

/* Compact Connection Test */
.connection-test-compact {
    padding: 0.375rem;
    border-radius: 6px;
    margin-bottom: 0.125rem;
    font-size: 0.875rem;
}

.connection-test-compact.success {
    background: #d1fae5;
    border: 1px solid #10b981;
    color: #065f46;
}

.connection-test-compact.error {
    background: #fee2e2;
    border: 1px solid #ef4444;
    color: #991b1b;
}

.connection-test-compact.info {
    background: #dbeafe;
    border: 1px solid #3b82f6;
    color: #1e40af;
}

/* Settings Section */
.settings-section {
    background: var(--background-light);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
}

.settings-title {
    margin: 0 0 0.5rem 0;
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--text-primary);
    display: flex;
    align-items: center;
}

/* Compact Textarea */
.form-textarea-compact {
    min-height: 60px;
    resize: vertical;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .modal-form-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .modal-content {
        max-width: 95vw;
        max-height: 95vh;
    }
}

/* Add Card Styling */
.add-card {
    border: 2px dashed var(--border-light);
    background: var(--background-white);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 280px;
}

.add-card:hover {
    border-color: var(--primary-blue);
    background: rgba(59, 130, 246, 0.02);
    transform: translateY(-2px);
}

.add-card-content {
    text-align: center;
    padding: 2rem;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
}

.add-icon {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    background: var(--background-light);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: var(--text-secondary);
    transition: all 0.2s ease;
}

.add-card:hover .add-icon {
    background: var(--primary-blue);
    color: white;
    transform: scale(1.05);
}

.add-card h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
    margin: 0;
}

.add-card p {
    color: var(--text-secondary);
    font-size: 0.875rem;
    margin: 0;
    line-height: 1.4;
}

.add-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: var(--primary-blue);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
}

.add-btn:hover {
    background: #1e40af;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

/* Responsive Design */
@media (max-width: 1200px) {
    .providers-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .providers-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .connection-card {
        min-height: 250px;
    }
    
    .card-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
        padding: 1rem;
    }
    
    .connection-status {
        align-self: flex-start;
    }
    
    .card-actions {
        flex-direction: column;
    }
    
    .action-btn {
        width: 100%;
        justify-content: center;
    }
}
</style>

<!-- Provider Connection Modal -->
<div id="providerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fa-solid fa-cloud" style="color: #1E40AF; margin-right: 0.5rem;"></i>
                Подключение облачного провайдера
            </h3>
            <button class="modal-close" onclick="closeProviderModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="providerForm" method="POST" action="/api/providers/beget/add">
                <input type="hidden" id="selected_provider" name="provider" value="">
                
                <!-- Two-column layout -->
                <div class="modal-form-grid">
                    <!-- Left Column -->
                    <div class="modal-form-left">
                        <!-- Provider Selection -->
                        <div class="form-group">
                            <label class="form-label" for="provider_select">Выберите провайдера *</label>
                            <select class="form-select" id="provider_select" onchange="changeProvider()" required>
                                <option value="">-- Выберите провайдера --</option>
                                <option value="yandex">Yandex Cloud</option>
                                <option value="selectel">Selectel</option>
                                <option value="beget">Beget</option>
                                <option value="aws">Amazon Web Services</option>
                                <option value="azure">Microsoft Azure</option>
                                <option value="gcp">Google Cloud Platform</option>
                                <option value="vk-cloud">VK Cloud</option>
                            </select>
                        </div>

                        
                        <!-- Connection Test (compact) -->
                        <div class="connection-test-compact" id="connectionTest" style="display: none;"></div>
                        
                        <!-- Basic Connection Info -->
                        <div class="form-group">
                            <label class="form-label" for="connection_name">Название подключения *</label>
                            <input type="text" class="form-control" id="connection_name" name="connection_name" 
                                   placeholder="Мой аккаунт" required>
                        </div>
                        
                        <!-- Dynamic provider-specific fields -->
                        <div id="providerFields"></div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="modal-form-right">
                        <!-- Settings Section -->
                        <div class="settings-section">
                            <h5 class="settings-title">
                                <i class="fa-solid fa-gear" style="color: #1E40AF; margin-right: 0.5rem;"></i>
                                Настройки
                            </h5>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="auto_sync" name="auto_sync" checked>
                                    <label class="form-check-label" for="auto_sync">Автоматическая синхронизация</label>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="sync_interval">Интервал синхронизации</label>
                                <select class="form-select" id="sync_interval" name="sync_interval">
                                    <option value="hourly">Каждый час</option>
                                    <option value="daily" selected>Ежедневно</option>
                                    <option value="weekly">Еженедельно</option>
                                    <option value="manual">Только вручную</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="enable_notifications" name="enable_notifications" checked>
                                    <label class="form-check-label" for="enable_notifications">Уведомления о изменениях</label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Description (optional, compact) -->
                        <div class="form-group">
                            <label class="form-label" for="description">Описание (необязательно)</label>
                            <textarea class="form-control form-textarea-compact" id="description" name="description" 
                                      placeholder="Дополнительная информация..."></textarea>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeProviderModal()">Отмена</button>
            <button type="button" class="btn btn-outline-secondary" onclick="testConnection()" style="display: none;" id="testBtn">Тест подключения</button>
            <button type="submit" form="providerForm" class="btn btn-primary btn-lg" style="display: none;" id="connectBtn">Подключить</button>
        </div>
    </div>
</div>

<script>
// Provider configurations
const providers = {
    yandex: {
        name: 'Yandex Cloud',
        description: 'Yandex Cloud — российская облачная платформа, предоставляющая услуги виртуальных машин, баз данных, хранилищ и других облачных сервисов.',
        fields: [
            { name: 'access_key', label: 'Access Key ID *', type: 'text', placeholder: 'AQVN...', required: true },
            { name: 'secret_key', label: 'Secret Access Key *', type: 'password', placeholder: '••••••••', required: true },
            { name: 'organization_id', label: 'Organization ID *', type: 'text', placeholder: 'org-1234567890', required: true },
            { name: 'cloud_id', label: 'Cloud ID *', type: 'text', placeholder: 'b1g1234567890', required: true }
        ]
    },
    selectel: {
        name: 'Selectel',
        description: 'Selectel — российский провайдер облачных услуг, специализирующийся на виртуальных серверах, облачных вычислениях и хостинге.',
        fields: [
            { name: 'api_key', label: 'API Key *', type: 'text', placeholder: 'sk_...', required: true },
            { name: 'project_id', label: 'Project ID *', type: 'text', placeholder: 'proj_1234567890', required: true }
        ]
    },
    beget: {
        name: 'Beget',
        description: 'Beget — российский хостинг-провайдер, предоставляющий услуги веб-хостинга, регистрации доменов и виртуальных серверов.',
        fields: [
            { name: 'username', label: 'Имя пользователя *', type: 'text', placeholder: 'your_beget_username', required: true },
            { name: 'password', label: 'Пароль *', type: 'password', placeholder: '••••••••', required: true }
        ]
    },
    aws: {
        name: 'Amazon Web Services',
        description: 'Amazon Web Services — ведущая облачная платформа, предоставляющая широкий спектр облачных сервисов и решений.',
        fields: [
            { name: 'access_key_id', label: 'Access Key ID *', type: 'text', placeholder: 'AKIA...', required: true },
            { name: 'secret_access_key', label: 'Secret Access Key *', type: 'password', placeholder: '••••••••', required: true },
            { name: 'region', label: 'Region *', type: 'text', placeholder: 'us-east-1', required: true }
        ]
    },
    azure: {
        name: 'Microsoft Azure',
        description: 'Microsoft Azure — облачная платформа Microsoft, предоставляющая услуги для разработки, тестирования, развертывания и управления приложениями.',
        fields: [
            { name: 'client_id', label: 'Client ID *', type: 'text', placeholder: '12345678-1234-1234-1234-123456789012', required: true },
            { name: 'client_secret', label: 'Client Secret *', type: 'password', placeholder: '••••••••', required: true },
            { name: 'tenant_id', label: 'Tenant ID *', type: 'text', placeholder: '12345678-1234-1234-1234-123456789012', required: true },
            { name: 'subscription_id', label: 'Subscription ID *', type: 'text', placeholder: '12345678-1234-1234-1234-123456789012', required: true }
        ]
    },
    gcp: {
        name: 'Google Cloud Platform',
        description: 'Google Cloud Platform — облачная платформа Google, предоставляющая услуги вычислений, хранения данных и машинного обучения.',
        fields: [
            { name: 'service_account_key', label: 'Service Account Key *', type: 'textarea', placeholder: 'JSON ключ сервисного аккаунта', required: true },
            { name: 'project_id', label: 'Project ID *', type: 'text', placeholder: 'my-gcp-project', required: true }
        ]
    },
    'vk-cloud': {
        name: 'VK Cloud',
        description: 'VK Cloud — российская облачная платформа, предоставляющая услуги виртуальных машин, баз данных и других облачных сервисов.',
        fields: [
            { name: 'access_key', label: 'Access Key *', type: 'text', placeholder: 'vk_access_key', required: true },
            { name: 'secret_key', label: 'Secret Key *', type: 'password', placeholder: '••••••••', required: true },
            { name: 'project_id', label: 'Project ID *', type: 'text', placeholder: 'vk_project_id', required: true }
        ]
    }
};

function showProviderModal(selectedProvider = null) {
    document.getElementById('providerModal').style.display = 'block';
    
    // Reset modal to add mode
    resetModalToAddMode();
    
    // If a provider is specified, pre-select it
    if (selectedProvider) {
        const providerSelect = document.getElementById('provider_select');
        providerSelect.value = selectedProvider;
        changeProvider(); // Trigger the change to show provider-specific fields
    }
}

function showProviderModalForEdit(connectionData) {
    document.getElementById('providerModal').style.display = 'block';
    
    // Set modal to edit mode
    setModalToEditMode(connectionData);
    
    // Pre-select provider and fill fields
    const providerSelect = document.getElementById('provider_select');
    providerSelect.value = connectionData.provider;
    changeProvider(); // Trigger the change to show provider-specific fields
    
    // Fill in the existing data
    setTimeout(() => {
        fillEditForm(connectionData);
    }, 100);
}

function resetModalToAddMode() {
    // Reset form fields
    document.getElementById('providerForm').reset();
    
    // Update modal title and button text
    document.querySelector('.modal-title').innerHTML = 
        '<i class="fa-solid fa-cloud" style="color: #1E40AF; margin-right: 0.5rem;"></i>Подключение облачного провайдера';
    
    const connectBtn = document.getElementById('connectBtn');
    connectBtn.innerHTML = 'Подключить';
    connectBtn.style.display = 'none';
    
    const testBtn = document.getElementById('testBtn');
    testBtn.style.display = 'none';
    
    // Re-enable provider dropdown in add mode
    const providerSelect = document.getElementById('provider_select');
    providerSelect.disabled = false;
    providerSelect.style.opacity = '1';
    providerSelect.style.cursor = 'pointer';
    
    // Hide connection test section
    document.getElementById('connectionTest').style.display = 'none';
    
    // Remove hidden edit ID field if it exists
    const existingEditId = document.getElementById('edit_connection_id');
    if (existingEditId) {
        existingEditId.remove();
    }
}

function setModalToEditMode(connectionData) {
    // Update modal title
    document.querySelector('.modal-title').innerHTML = 
        '<i class="fa-solid fa-edit" style="color: #1E40AF; margin-right: 0.5rem;"></i>Редактирование подключения';
    
    // Update button text
    const connectBtn = document.getElementById('connectBtn');
    connectBtn.innerHTML = 'Сохранить изменения';
    connectBtn.style.display = 'none';
    
    // Ensure test button is visible
    const testBtn = document.getElementById('testBtn');
    testBtn.style.display = 'inline-block';
    
    // Disable provider dropdown in edit mode
    const providerSelect = document.getElementById('provider_select');
    providerSelect.disabled = true;
    providerSelect.style.opacity = '0.6';
    providerSelect.style.cursor = 'not-allowed';
    
    // Add hidden field for edit ID
    const form = document.getElementById('providerForm');
    let editIdField = document.getElementById('edit_connection_id');
    if (!editIdField) {
        editIdField = document.createElement('input');
        editIdField.type = 'hidden';
        editIdField.id = 'edit_connection_id';
        editIdField.name = 'edit_connection_id';
        form.appendChild(editIdField);
    }
    editIdField.value = connectionData.id;
}

function fillEditForm(connectionData) {
    // Fill basic fields
    document.getElementById('connection_name').value = connectionData.connection_name || '';
    document.getElementById('description').value = connectionData.description || '';
    
    // Fill provider-specific fields
    const provider = connectionData.provider;
    if (provider === 'beget') {
        const usernameField = document.querySelector('input[name="username"]');
        
        if (usernameField) usernameField.value = connectionData.username || '';
        
        // Fill password for testing purposes
        const passwordField = document.querySelector('input[name="password"]');
        if (passwordField) {
            passwordField.value = connectionData.password || '';
            passwordField.placeholder = 'Введите новый пароль (оставьте пустым, чтобы не менять)';
        }
    }
    
    // Show connection test section
    document.getElementById('connectionTest').style.display = 'block';
    
    // Show buttons
    document.getElementById('testBtn').style.display = 'inline-block';
    document.getElementById('connectBtn').style.display = 'inline-block';
}

function closeProviderModal() {
    document.getElementById('providerModal').style.display = 'none';
    document.getElementById('connectionTest').style.display = 'none';
    document.getElementById('testBtn').style.display = 'none';
    document.getElementById('connectBtn').style.display = 'none';
    // Reset form
    document.getElementById('provider_select').value = '';
    document.getElementById('providerFields').innerHTML = '';
}

function changeProvider() {
    const selectedProvider = document.getElementById('provider_select').value;
    const providerFields = document.getElementById('providerFields');
    const testBtn = document.getElementById('testBtn');
    const connectBtn = document.getElementById('connectBtn');
    const selectedProviderInput = document.getElementById('selected_provider');
    
    if (selectedProvider && providers[selectedProvider]) {
        const provider = providers[selectedProvider];
        
        // Set hidden field
        selectedProviderInput.value = selectedProvider;
        
        // Generate dynamic fields
        providerFields.innerHTML = '';
        provider.fields.forEach(field => {
            const fieldHtml = createFieldHtml(field);
            providerFields.innerHTML += fieldHtml;
        });
        
        // Show buttons
        testBtn.style.display = 'inline-block';
        connectBtn.style.display = 'inline-block';
        
        // Check if we're in edit mode
        const editIdField = document.getElementById('edit_connection_id');
        if (editIdField && editIdField.value) {
            connectBtn.textContent = 'Сохранить изменения';
        } else {
            connectBtn.textContent = `Подключить ${provider.name}`;
        }
        
    } else {
        // Hide everything
        providerFields.innerHTML = '';
        testBtn.style.display = 'none';
        connectBtn.style.display = 'none';
    }
}

function createFieldHtml(field) {
    const required = field.required ? 'required' : '';
    const placeholder = field.placeholder || '';
    const defaultValue = field.default ? `value="${field.default}"` : '';
    
    if (field.type === 'textarea') {
        return `
            <div class="form-group">
                <label class="form-label" for="${field.name}">${field.label}</label>
                <textarea class="form-control form-textarea" id="${field.name}" name="${field.name}" 
                          placeholder="${placeholder}" ${required}>${field.default || ''}</textarea>
            </div>
        `;
    } else if (field.type === 'password') {
        return `
            <div class="form-group">
                <label class="form-label" for="${field.name}">${field.label}</label>
                <div class="password-input-wrapper">
                    <input type="password" class="form-control" id="${field.name}" name="${field.name}" 
                           placeholder="${placeholder}" ${defaultValue} ${required}>
                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('${field.name}')">
                        <i class="fa-solid fa-eye" id="eye-${field.name}"></i>
                    </button>
                </div>
            </div>
        `;
    } else {
        return `
            <div class="form-group">
                <label class="form-label" for="${field.name}">${field.label}</label>
                <input type="${field.type}" class="form-control" id="${field.name}" name="${field.name}" 
                       placeholder="${placeholder}" ${defaultValue} ${required}>
            </div>
        `;
    }
}

function testConnection() {
    const selectedProvider = document.getElementById('provider_select').value;
    const testDiv = document.getElementById('connectionTest');
    
    if (!selectedProvider) {
        showTestResult('Выберите провайдера', 'error');
        return;
    }
    
    // Collect form data
    const formData = {};
    const provider = providers[selectedProvider];
    
    provider.fields.forEach(field => {
        const element = document.getElementById(field.name);
        if (element) {
            formData[field.name] = element.value;
        }
    });
    
    // Validate required fields
    for (const field of provider.fields) {
        if (field.required && !formData[field.name]) {
            showTestResult(`Заполните поле: ${field.label}`, 'error');
            return;
        }
    }
    
    showTestResult('Тестирование подключения...', 'info');
    
    // Test connection based on provider
    fetch(`/api/providers/beget/test`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message with real user info
            let message = '✅ Подключение успешно установлено!';
            
            // Use real account info if available
            if (data.account_info) {
                const account = data.account_info;
                const username = account.customer_login || account.username || 'Unknown';
                const customerId = account.customer_id || '';
                
                if (customerId) {
                    message = `✅ Подключение успешно! Пользователь: ${username} (ID: ${customerId})`;
                } else {
                    message = `✅ Подключение успешно! Пользователь: ${username}`;
                }
            }
            
            showTestResult(message, 'success');
        } else {
            let errorMessage = '❌ ' + (data.error || 'Ошибка подключения');
            
            // Add helpful information for authentication errors
            if (data.error && data.error.includes('Authentication failed')) {
                errorMessage += '<br><br><strong>Возможные причины:</strong><br>• Проверьте правильность имени пользователя и пароля<br>• Убедитесь, что API доступ включен в панели управления Beget<br>• Используйте пароль API, а не пароль от аккаунта';
            }
            
            showTestResult(errorMessage, 'error');
        }
    })
    .catch(error => {
        showTestResult('❌ Ошибка тестирования подключения', 'error');
        console.error('Connection test error:', error);
    });
}

function showTestResult(message, type) {
    const testDiv = document.getElementById('connectionTest');
    testDiv.innerHTML = message;
    testDiv.className = `connection-test-compact ${type}`;
    testDiv.style.display = 'block';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('providerModal');
    if (event.target === modal) {
        closeProviderModal();
    }
}

// Connection management functions
function editConnection(connectionId) {
    // Extract numeric ID from string like "beget-2" -> "2"
    const numericId = connectionId.includes('-') ? connectionId.split('-')[1] : connectionId;
    
    // Show loading state
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i><span>Загрузка...</span>';
    button.disabled = true;
    
    // Fetch connection details
    fetch(`/api/providers/beget/${numericId}/edit`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Open modal in edit mode
                showProviderModalForEdit(data.data);
            } else {
                showFlashMessage('❌ Ошибка загрузки данных: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showFlashMessage('❌ Ошибка загрузки данных', 'error');
            console.error('Edit error:', error);
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

function syncConnection(connectionId) {
    // Extract numeric ID from string like "beget-2" -> "2"
    const numericId = connectionId.includes('-') ? connectionId.split('-')[1] : connectionId;
    
    // Show loading state
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i><span>Синхронизация...</span>';
    button.disabled = true;
    
    // Make sync request
    fetch(`/api/providers/beget/${numericId}/sync`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showFlashMessage('✅ Синхронизация завершена успешно!', 'success');
            // Reload page to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showFlashMessage('❌ Ошибка синхронизации: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showFlashMessage('❌ Ошибка синхронизации', 'error');
        console.error('Sync error:', error);
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function deleteConnection(connectionId) {
    if (confirm('Вы уверены, что хотите удалить это подключение?\n\nЭто действие нельзя отменить.')) {
        // Extract numeric ID from string like "beget-2" -> "2"
        const numericId = connectionId.includes('-') ? connectionId.split('-')[1] : connectionId;
        
        // Show loading state
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        // Make delete request
        fetch(`/api/providers/beget/${numericId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showFlashMessage('✅ Подключение удалено успешно!', 'success');
                // Remove the card from DOM
                const card = button.closest('.provider-card');
                card.style.opacity = '0.5';
                setTimeout(() => {
                    card.remove();
                }, 500);
            } else {
                showFlashMessage('❌ Ошибка удаления: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showFlashMessage('❌ Ошибка удаления', 'error');
            console.error('Delete error:', error);
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

function showFlashMessage(message, type) {
    // Create flash message element
    const flashDiv = document.createElement('div');
    flashDiv.className = `flash-message flash-${type}`;
    flashDiv.innerHTML = `
        <i class="fa-solid fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
        <button class="flash-close" onclick="this.parentElement.remove()">&times;</button>
    `;
    
    // Add to flash messages container
    let container = document.querySelector('.flash-messages');
    if (!container) {
        container = document.createElement('div');
        container.className = 'flash-messages';
        document.body.appendChild(container);
    }
    
    container.appendChild(flashDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (flashDiv.parentElement) {
            flashDiv.remove();
        }
    }, 5000);
}

function togglePasswordVisibility(fieldName) {
    const passwordField = document.getElementById(fieldName);
    const eyeIcon = document.getElementById(`eye-${fieldName}`);
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        eyeIcon.className = 'fa-solid fa-eye-slash';
    } else {
        passwordField.type = 'password';
        eyeIcon.className = 'fa-solid fa-eye';
    }
}

// Toggle account info collapsible section
function toggleAccountInfo(providerId) {
    const content = document.getElementById(`account-info-${providerId}`);
    const chevron = document.getElementById(`chevron-${providerId}`);
    
    if (content.style.display === 'none' || content.style.display === '') {
        content.style.display = 'block';
        chevron.classList.add('rotated');
    } else {
        content.style.display = 'none';
        chevron.classList.remove('rotated');
    }
}
</script>
{% endblock %}
