{% extends "base.html" %}

{% block title %}Подключения облаков - InfraZen FinOps Platform{% endblock %}

{% block page_title %}Управление подключениями к провайдерам{% endblock %}
{% block page_subtitle %}{% endblock %}

{% block header_actions %}
    <div class="header-actions">
        {% if user.role != 'demouser' %}
        <button class="btn btn-secondary" data-complete-sync id="complete-sync-btn"><i class="fa-solid fa-arrows-rotate"></i><span>Обновить все</span></button>
        {% else %}
        <div class="demo-user-notice">
            <i class="fa-solid fa-info-circle"></i>
            <span>Демо-режим: только просмотр</span>
        </div>
        {% endif %}
    </div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/connections.css') }}">
{% endblock %}

{% block content %}

<div class="connections-content">
    <div class="connections-summary">
        <div class="summary-header">
        </div>
        <div class="summary-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fa-solid fa-cloud"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ providers|length }}</span>
                    <span class="stat-label">Всего подключений</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon active">
                    <i class="fa-solid fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-value">{{ providers|selectattr('auto_sync', 'equalto', True)|list|length }}</span>
                    <span class="stat-label">Активных</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon synced">
                    <i class="fa-solid fa-sync"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-value">
                        {% if last_complete_sync and last_complete_sync.sync_status == 'success' %}
                            {{ last_complete_sync.successful_providers or 0 }}
                        {% else %}
                            {{ providers|selectattr('last_sync', 'defined')|selectattr('last_sync', 'ne', None)|list|length }}
                        {% endif %}
                    </span>
                    <span class="stat-label">Синхронизировано</span>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fa-solid fa-clock"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-value">
                        {% if last_complete_sync and last_complete_sync.sync_completed_at %}
                            {{ last_complete_sync.sync_completed_at.strftime('%d.%m %H:%M') }}
                        {% else %}
                            {% set synced_providers = providers|selectattr('last_sync', 'defined')|selectattr('last_sync', 'ne', None)|list %}
                            {% if synced_providers|length > 0 %}
                                {% set latest_sync = synced_providers|first %}
                                {{ latest_sync.last_sync.strftime('%d.%m %H:%M') }}
                            {% else %}
                                Никогда
                            {% endif %}
                        {% endif %}
                    </span>
                    <span class="stat-label">Последняя синхронизация</span>
                    {% if last_complete_sync %}
                    <a href="#" class="stat-link" onclick="showRecoSummary(); return false;" title="Показать сводку рекомендаций">Сводка рекомендаций</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if providers %}
    <div class="providers-grid">
        {% for provider in providers %}
        <article class="connection-card" id="provider-{{ provider.id }}" data-provider-type="{{ provider.provider_type }}">
            <div class="card-header">
                <div class="provider-logo">
                    {% if provider.code == 'yandex' %}
                        <div class="provider-icon yandex-cloud">
                            <img src="{{ url_for('static', filename='provider_logos/yc_logo.png') }}" alt="Yandex Cloud" style="width: 2rem; height: 2rem; object-fit: contain;">
                        </div>
                    {% elif provider.code == 'selectel' %}
                        <div class="provider-icon selectel">
                            <img src="{{ url_for('static', filename='provider_logos/selectel_logo.svg') }}" alt="Selectel" style="width: 2rem; height: 2rem; object-fit: contain;">
                        </div>
                    {% elif provider.code == 'beget' %}
                        <div class="provider-icon beget">
                            <img src="{{ url_for('static', filename='provider_logos/beget_logo.jpeg') }}" alt="Beget" style="width: 2rem; height: 2rem; object-fit: contain;">
                        </div>
                    {% else %}
                        <div class="provider-icon default">
                            <i class="fa-solid fa-cloud"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="provider-info">
                    <div class="provider-badge provider-{{ provider.code }}">{{ provider.code|upper }}</div>
                    <div class="provider-name">{{ provider.connection_name or provider.name }}</div>
                </div>
                <div class="connection-status">
                    {% if provider.status == 'connected' %}
                        <div class="status-badge connected">
                            <span class="status-dot"></span>
                            <span class="status-text">Подключен</span>
                        </div>
                    {% else %}
                        <div class="status-badge disconnected">
                            <span class="status-dot"></span>
                            <span class="status-text">Отключен</span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <div class="card-body">
                <div class="sync-info">
                    {% if provider.status == 'connected' %}
                        {% if provider.last_sync %}
                            {% if provider.sync_error %}
                                {# Partial sync - success with warnings #}
                                <div class="sync-status warning">
                                    <i class="fa-solid fa-exclamation-triangle"></i>
                                    <span>⚠️ Частичная синхронизация {{ provider.last_sync.strftime('%d.%m.%Y в %H:%M') }}</span>
                                </div>
                                <div class="sync-error-message">
                                    <i class="fa-solid fa-info-circle"></i>
                                    <span>{{ provider.sync_error }}</span>
                                </div>
                            {% else %}
                                {# Full success #}
                                <div class="sync-status success">
                                    <i class="fa-solid fa-check-circle"></i>
                                    <span>Синхронизирован {{ provider.last_sync.strftime('%d.%m.%Y в %H:%M') }}</span>
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="sync-status pending">
                                <i class="fa-solid fa-clock"></i>
                                <span>Ожидает синхронизации</span>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="sync-status error">
                            <i class="fa-solid fa-exclamation-circle"></i>
                            <span>Требуется подключение</span>
                        </div>
                    {% endif %}
                </div>

                <div class="provider-details">
                    <div class="detail-item">
                        <span class="detail-label">Добавлен:</span>
                        <span class="detail-value">{{ provider.added_at }}</span>
                    </div>
                    
                    <!-- Account Information (if available) -->
                    {% if provider.provider_metadata %}
                        {% set metadata = provider.provider_metadata|from_json %}
                        {% if metadata.account_info %}
                            {% set account = metadata.account_info %}
                            <div class="account-info-collapsible">
                                <div class="account-info-header" onclick="toggleAccountInfo('{{ provider.id }}')">
                                    <i class="fa-solid fa-user"></i>
                                    <span>Информация об аккаунте</span>
                                    <i class="fa-solid fa-chevron-down account-info-chevron" id="chevron-{{ provider.id }}"></i>
                                </div>
                                <div class="account-info-content" id="account-info-{{ provider.id }}" style="display: none;">
                                
                                {% if account.account_id %}
                                <div class="detail-item">
                                    <span class="detail-label">Аккаунт:</span>
                                    <span class="detail-value">{{ account.account_id }}</span>
                                </div>
                                {% endif %}
                                
                                {% if account.account_status %}
                                <div class="detail-item">
                                    <span class="detail-label">Статус:</span>
                                    <span class="detail-value status-{{ account.account_status|lower }}">
                                        {% if account.account_status == 'active' %}Активен
                                        {% elif account.account_status == 'suspended' %}Приостановлен
                                        {% else %}{{ account.account_status }}{% endif %}
                                    </span>
                                </div>
                                {% endif %}
                                
                                {% if account.balance is defined %}
                                <div class="detail-item">
                                    <span class="detail-label">Баланс:</span>
                                    <span class="detail-value">{{ account.balance|round(2) }} {{ account.currency or 'RUB' }}</span>
                                </div>
                                {% endif %}
                                
                                {% if account.finops_insights %}
                                <div class="detail-item">
                                    <span class="detail-label">Стоимость:</span>
                                    <span class="detail-value">
                                        {{ account.finops_insights.daily_cost|round(2) }} ₽/день
                                        {% if account.finops_insights.monthly_cost %}({{ account.finops_insights.monthly_cost|round(2) }} ₽/мес){% endif %}
                                    </span>
                                </div>
                                {% endif %}
                                
                                {% if account.days_to_block and account.days_to_block < 30 %}
                                <div class="detail-item warning">
                                    <span class="detail-label">⚠️ Блокировка:</span>
                                    <span class="detail-value">{{ account.days_to_block }} дней</span>
                                </div>
                                {% endif %}
                                
                                {% if account.service_limits %}
                                <div class="detail-item">
                                    <span class="detail-label">Лимиты:</span>
                                    <span class="detail-value">
                                        {% if account.service_limits.domains %}
                                            Доменов: {{ account.service_limits.domains.used }}/{{ account.service_limits.domains.limit if account.service_limits.domains.limit < 999999 else '∞' }}
                                        {% endif %}
                                        {% if account.service_limits.sites and account.service_limits.sites.limit > 0 %}
                                            , Сайтов: {{ account.service_limits.sites.used }}/{{ account.service_limits.sites.limit }}
                                        {% endif %}
                                        {% if account.service_limits.mysql and account.service_limits.mysql.limit > 0 %}
                                            , MySQL: {{ account.service_limits.mysql.used }}/{{ account.service_limits.mysql.limit }}
                                        {% endif %}
                                    </span>
                                </div>
                                {% endif %}
                                
                                {% if account.plan_name %}
                                <div class="detail-item">
                                    <span class="detail-label">Тариф:</span>
                                    <span class="detail-value">{{ account.plan_name }}</span>
                                </div>
                                {% endif %}
                                
                                {% if account.server_info %}
                                <div class="detail-item">
                                    <span class="detail-label">Сервер:</span>
                                    <span class="detail-value">{{ account.server_info.name }}</span>
                                </div>
                                {% endif %}
                                
                                {# Yandex-specific account info display #}
                                {% if provider.code == 'yandex' %}
                                    {% if account.organization %}
                                    <div class="detail-item">
                                        <span class="detail-label">Организация:</span>
                                        <span class="detail-value">{{ account.organization.name }}</span>
                                    </div>
                                    {% if account.organization.legal_name and account.organization.legal_name != 'N/A' %}
                                    <div class="detail-item" style="padding-left: 1rem;">
                                        <span class="detail-value" style="font-size: 0.85rem; color: var(--text-secondary);">
                                            {{ account.organization.legal_name }}
                                        </span>
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                    
                                    {% if account.folder %}
                                    <div class="detail-item" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;">
                                        <span class="detail-label">Folder:</span>
                                        <span class="detail-value">{{ account.folder.name }} 
                                            {% if account.folder.status == 'ACTIVE' %}(активен)
                                            {% else %}({{ account.folder.status|lower }}){% endif %}
                                        </span>
                                    </div>
                                    {% endif %}
                                    
                                    {% if account.service_account %}
                                    <div class="detail-item">
                                        <span class="detail-label">Сервис-аккаунт:</span>
                                        <span class="detail-value">{{ account.service_account.name }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    <div class="detail-item" style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #e5e7eb;">
                                        <span class="detail-label">Ресурсов:</span>
                                        <span class="detail-value">{{ provider.last_snapshot_resources or 0 }}</span>
                                    </div>
                                    
                                    <div class="detail-item">
                                        <a href="https://console.cloud.yandex.ru/billing" target="_blank" style="color: var(--primary-blue); text-decoration: none; font-size: 0.85rem;">
                                            <i class="fa-solid fa-external-link-alt"></i> Баланс и расходы →
                                        </a>
                                    </div>
                                {% endif %}
                                
                                {# Selectel-specific account info display #}
                                {% if provider.code == 'selectel' %}
                                    {% if account.account_id or account.account_name %}
                                    <div class="detail-item">
                                        <span class="detail-label">Аккаунт:</span>
                                        <span class="detail-value">{{ account.account_name or account.account_id }} 
                                            {% if account.enabled and not account.locked %}(активен)
                                            {% elif account.locked %}(заблокирован)
                                            {% else %}(неактивен){% endif %}
                                        </span>
                                    </div>
                                    {% endif %}
                                    
                                    {% if account.service_user %}
                                    <div class="detail-item">
                                        <span class="detail-label">Сервисный пользователь:</span>
                                        <span class="detail-value">{{ account.service_user.name }}</span>
                                    </div>
                                    {% endif %}
                                    
                                    {% if account.projects and account.projects.total_count > 0 %}
                                    <div class="detail-item">
                                        <span class="detail-label">Проекты:</span>
                                        <span class="detail-value">{{ account.projects.total_count }} активных</span>
                                    </div>
                                    {% for project in account.projects.projects %}
                                    <div class="detail-item" style="padding-left: 1rem;">
                                        <span class="detail-value" style="font-size: 0.85rem;">
                                            • {{ project.name }}
                                        </span>
                                    </div>
                                    {% endfor %}
                                    {% endif %}
                                    
                                    <div class="detail-item" style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">
                                        <span class="detail-label">Billing:</span>
                                        <span class="detail-value">{{ provider.total_daily_cost|round(1) }} ₽/день</span>
                                    </div>
                                    
                                    <div class="detail-item">
                                        <span class="detail-label">Прогноз месяц:</span>
                                        <span class="detail-value">{{ (provider.total_daily_cost * 30)|round(1) }} ₽/месяц</span>
                                    </div>
                                    
                                    <div class="detail-item">
                                        <span class="detail-label">Ресурсов:</span>
                                        <span class="detail-value">{{ provider.last_snapshot_resources or 0 }}</span>
                                    </div>
                                    
                                    <div class="detail-item">
                                        <a href="https://my.selectel.ru/vpc/cost?groupType=project" target="_blank" style="color: var(--primary-blue); text-decoration: none; font-size: 0.85rem;">
                                            <i class="fa-solid fa-external-link-alt"></i> Баланс и расходы →
                                        </a>
                                    </div>
                                {% endif %}
                                
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}
                    
                    {% if provider.details %}
                        {% if provider.details.organization_id %}
                        <div class="detail-item">
                            <span class="detail-label">Организация:</span>
                            <span class="detail-value">{{ provider.details.organization_id }}</span>
                        </div>
                        {% endif %}
                        {% if provider.details.cloud_id %}
                        <div class="detail-item">
                            <span class="detail-label">Облако:</span>
                            <span class="detail-value">{{ provider.details.cloud_id }}</span>
                        </div>
                        {% endif %}
                        {% if provider.details.project_id %}
                        <div class="detail-item">
                            <span class="detail-label">Проект:</span>
                            <span class="detail-value">{{ provider.details.project_id }}</span>
                        </div>
                        {% endif %}
                        {% if provider.details.regions %}
                        <div class="detail-item">
                            <span class="detail-label">Регионы:</span>
                            <span class="detail-value">{{ provider.details.regions|join(', ') }}</span>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
                
                <!-- Provider Cost Display -->
                <div class="provider-cost">
                    <div class="cost-primary">
                        <div class="cost-amount">{{ "%.1f"|format(provider.total_monthly_cost or 0) }} ₽</div>
                        <div class="cost-period">в месяц</div>
                    </div>
                    <div class="cost-secondary">
                        <div class="cost-amount-secondary">{{ "%.1f"|format(provider.total_daily_cost or 0) }} ₽</div>
                        <div class="cost-period-secondary">в день</div>
                        <div class="resource-count">{{ provider.last_snapshot_resources or 0 }} ресурсов</div>
                    </div>
                </div>
            </div>

            {% if user.role != 'demouser' %}
            <div class="card-actions">
                <button class="action-btn secondary" title="Настройки" onclick="editConnection('{{ provider.id }}')">
                    <i class="fa-solid fa-gear"></i>
                    <span>Настройки</span>
                </button>
                <button class="action-btn primary" title="Синхронизировать" onclick="syncConnection('{{ provider.id }}', '{{ provider.provider_type }}')">
                    <i class="fa-solid fa-sync"></i>
                    <span>Синхронизировать</span>
                </button>
                <button class="action-btn danger" title="Удалить" onclick="deleteConnection('{{ provider.id }}', '{{ provider.provider_type }}')">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
            {% endif %}
        </article>
        {% endfor %}

        {% if user.role != 'demouser' %}
        <article class="connection-card add-card" id="add-provider-card">
            <div class="add-card-content">
                <div class="add-icon">
                    <i class="fa-solid fa-plus"></i>
                </div>
                <h3>Добавить провайдера</h3>
                <p>Настроить подключение нового облачного провайдера</p>
                <button class="add-btn" onclick="showProviderModal()">
                    <i class="fa-solid fa-cog"></i>
                    <span>Настроить подключение</span>
                </button>
            </div>
        </article>
        {% endif %}
    </div>

    {% if enabled_providers %}
    <div class="available-providers">
        <h3>Доступные провайдеры</h3>
        <div class="providers-list">
            {% for provider in enabled_providers %}
            <div class="provider-option">
                <div class="provider-logo">
                    {% if provider.logo_url %}
                        <img src="{{ provider.logo_url }}" alt="{{ provider.display_name }}" style="width: 2rem; height: 2rem; object-fit: contain;">
                    {% else %}
                        <div class="provider-icon {{ provider.provider_type }}">
                            {% if provider.provider_type == 'aws' %}
                                <i class="fa-brands fa-aws"></i>
                            {% elif provider.provider_type == 'azure' %}
                                <i class="fa-brands fa-microsoft"></i>
                            {% elif provider.provider_type == 'gcp' %}
                                <i class="fa-brands fa-google"></i>
                            {% elif provider.provider_type == 'beget' %}
                                <img src="{{ url_for('static', filename='provider_logos/beget_logo.jpeg') }}" alt="Beget" style="width: 2rem; height: 2rem; object-fit: contain;">
                            {% elif provider.provider_type == 'selectel' %}
                                <img src="{{ url_for('static', filename='provider_logos/selectel_logo.svg') }}" alt="Selectel" style="width: 2rem; height: 2rem; object-fit: contain;">
                            {% elif provider.provider_type == 'yandex' %}
                                <img src="{{ url_for('static', filename='provider_logos/yc_logo.png') }}" alt="Yandex Cloud" style="width: 2rem; height: 2rem; object-fit: contain;">
                            {% elif provider.provider_type == 'vk-cloud' %}
                                <i class="fa-solid fa-cloud"></i>
                            {% else %}
                                <i class="fa-solid fa-cloud"></i>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
                <div class="provider-info">
                    <span class="provider-name">{{ provider.display_name }}</span>
                    <span class="provider-description">{{ provider.description or 'Облачный провайдер' }}</span>
                </div>
                {% if not is_demo_user %}
                <button class="btn btn-outline btn-sm" onclick="showProviderModal('{{ provider.provider_type }}')">Добавить</button>
                {% else %}
                <button class="btn btn-outline btn-sm" disabled title="Войдите в систему для создания подключений">Добавить</button>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon"><i class="fa-solid fa-cloud"></i></div>
        <div class="empty-state-title">Нет подключений</div>
        <div class="empty-state-text">Добавьте облачных провайдеров для начала работы</div>
        <button class="btn btn-primary" onclick="showProviderModal()">Добавить первого провайдера</button>
    </div>
    {% endif %}
</div>


<!-- Provider Connection Modal -->
<div id="providerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fa-solid fa-cloud" style="color: #1E40AF; margin-right: 0.5rem;"></i>
                Подключение облачного провайдера
            </h3>
            <button class="modal-close" onclick="closeProviderModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="providerForm" method="POST" action="">
                <input type="hidden" id="selected_provider" name="provider" value="">
                
                <!-- Two-column layout -->
                <div class="modal-form-grid">
                    <!-- Left Column -->
                    <div class="modal-form-left">
                        <!-- Provider Selection -->
                        <div class="form-group">
                            <label class="form-label" for="provider_select">Выберите провайдера *</label>
                            <select class="form-select" id="provider_select" onchange="changeProvider()" required>
                                <option value="">-- Выберите провайдера --</option>
                                {% for provider in enabled_providers %}
                                <option value="{{ provider.provider_type }}">{{ provider.display_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        
                        <!-- Connection Test (compact) -->
                        <div class="connection-test-compact" id="connectionTest" style="display: none;"></div>
                        
                        <!-- Basic Connection Info -->
                        <div class="form-group">
                            <label class="form-label" for="connection_name">Название подключения *</label>
                            <input type="text" class="form-control" id="connection_name" name="connection_name" 
                                   placeholder="Мой аккаунт" required>
                        </div>
                        
                        <!-- Dynamic provider-specific fields -->
                        <div id="providerFields"></div>
                    </div>
                    
                    <!-- Right Column -->
                    <div class="modal-form-right">
                        <!-- Settings Section -->
                        <div class="settings-section">
                            <h5 class="settings-title">
                                <i class="fa-solid fa-gear" style="color: #1E40AF; margin-right: 0.5rem;"></i>
                                Настройки
                            </h5>
                            
                            <div class="form-group">
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="auto_sync" name="auto_sync" checked>
                                    <label class="form-check-label" for="auto_sync">Автоматическая синхронизация</label>
                                </div>
                                <small class="form-text text-muted">Включать провайдер в автоматическую синхронизацию</small>
                            </div>
                        </div>
                        
                        <!-- Description (optional, compact) -->
                        <div class="form-group">
                            <label class="form-label" for="description">Описание (необязательно)</label>
                            <textarea class="form-control form-textarea-compact" id="description" name="description" 
                                      placeholder="Дополнительная информация..."></textarea>
                        </div>
                        
                        <!-- Instructions Button -->
                        <div class="form-group" style="margin-top: 1rem;">
                            <button type="button" class="btn btn-outline-primary" onclick="openInstructions()" style="width: 100%;">
                                <i class="fa-solid fa-book-open"></i> Инструкции по подключению
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeProviderModal()">Отмена</button>
            <button type="button" class="btn btn-outline-secondary" onclick="testConnection()" style="display: none;" id="testBtn">Тест подключения</button>
            <button type="submit" form="providerForm" class="btn btn-primary btn-lg" style="display: none;" id="connectBtn">Подключить</button>
        </div>
    </div>
</div>

<!-- Recommendations Summary Modal -->
<div id="recoSummaryModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fa-solid fa-lightbulb" style="color: #1E40AF; margin-right: 0.5rem;"></i>
                Сводка рекомендаций
            </h3>
            <button class="modal-close" onclick="closeRecoSummary()">&times;</button>
        </div>
        <div class="modal-body" id="recoSummaryBody">
            <div style="color: var(--text-secondary);"><i class="fa-solid fa-spinner fa-spin"></i> Загрузка сводки...</div>
        </div>
    </div>
</div>

<!-- External JavaScript -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script src="{{ url_for('static', filename='js/connections.js') }}"></script>
{% endblock %}
