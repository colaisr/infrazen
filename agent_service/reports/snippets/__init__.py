"""Persona snippet library for report narratives."""

from __future__ import annotations

from typing import Any, Dict


DEFAULT_ROLE_KEY = "cfo"


SNIPPET_LIBRARY: Dict[str, Dict[str, Any]] = {
    "cfo": {
        "persona": "Финансовый директор",
        "tone": "Сдержанный, уверенный, ориентированный на цифры и влияние на P&L.",
        "focus_areas": [
            "Текущие облачные расходы и их вклад в бюджет.",
            "Доступная экономия и инициативы, требующие решения.",
            "Концентрация расходов и связанные риски."
        ],
        "opening_templates": [
            "Оперативный снимок расходов: {monthly_spend} ₽/мес, доступная экономия {savings} ₽.",
            "Инфраструктура сегодня стоит {monthly_spend} ₽/мес; экономический потенциал {savings} ₽."
        ],
        "insight_prompts": [
            "Выдели ключевые драйверы текущих расходов и влияние на бюджет.",
            "Покажи, как активные инициативы экономии улучшают P&L.",
            "Определи риски концентрации затрат или операционные зависимости."
        ],
        "risk_templates": [
            "Высокая концентрация расходов у одного провайдера требует контроля договоров.",
            "Незавершенные инициативы экономии могут задержать выполнение бюджета."
        ],
        "next_steps": [
            "Согласовать приоритет внедрения рекомендаций с экономией более 300 тыс. ₽/мес.",
            "Проверить соответствие расходов бюджетным лимитам и обновить прогноз.",
            "Попросить FinOps команду подготовить сценарий сокращения расходов на 10%."
        ],
    },
    "cto": {
        "persona": "Технический директор / CIO",
        "tone": "Технологически ориентированный, прагматичный, акцент на стабильность и эффективность.",
        "focus_areas": [
            "Состояние текущих нагрузок и использование ресурсов.",
            "Приоритетные оптимизационные инициативы без риска для сервисов.",
            "Концентрация расходов по провайдерам и сервисам."
        ],
        "opening_templates": [
            "Оперативное состояние инфраструктуры: {monthly_spend} ₽/мес, окно оптимизации {savings} ₽.",
            "На текущий момент нагрузка стоит {monthly_spend} ₽/мес; основные провайдеры {top_provider_share}."
        ],
        "insight_prompts": [
            "Опиши сервисы и кластеры, где есть потенциал оптимизации без ущерба SLA.",
            "Укажи технические долги: неиспользуемые ресурсы, устаревшие конфигурации.",
            "Подчеркни концентрацию расходов, требующую контроля архитектуры."
        ],
        "risk_templates": [
            "Концентрация нагрузки на одном провайдере усиливает зависимость от поставщика.",
            "Высокая доля неиспользуемых ресурсов увеличивает операционные затраты без пользы."
        ],
        "next_steps": [
            "Запустить аудит конфигураций для топ-3 сервисов по расходам.",
            "Спланировать миграцию неиспользуемых VM в более компактные типы.",
            "Настроить автоматическое выключение и парковку idle ресурсов."
        ],
    },
    "product": {
        "persona": "Product / Business Owner",
        "tone": "Продуктово-ориентированный, акцент на юнит-экономику и влияние на клиента.",
        "focus_areas": [
            "Текущая себестоимость инфраструктуры продукта.",
            "Экономия, способная улучшить маржинальность и цену предложения.",
            "Компоненты с наибольшим вкладом в стоимость сервиса."
        ],
        "opening_templates": [
            "Снимок unit-экономики: {monthly_spend} ₽/мес, потенциал маржинальности {savings} ₽.",
            "Продуктовые сервисы сейчас стоят {monthly_spend} ₽/мес; ключевые статьи расходов {top_service_share}."
        ],
        "insight_prompts": [
            "Выдели расходы, связанные с ключевыми продуктами или сегментами клиентов.",
            "Покажи, как рекомендации повышают маржинальность/ARPU.",
            "Определи сервисы, где следует удерживать контроль стоимости."
        ],
        "risk_templates": [
            "Высокая стоимость отдельного сервиса снижает маржинальность продуктов.",
            "Неиспользуемые ресурсы добавляют расходы без влияния на клиента."
        ],
        "next_steps": [
            "Провести ревизию тарифов с учетом новых расходов.",
            "Согласовать с инженерами оптимизацию ресурсов с низкой загрузкой.",
            "Подготовить story для roadmap, чтобы укрепить FinOps-практики в продукте."
        ],
    },
    "finops": {
        "persona": "FinOps Lead",
        "tone": "Операционно-аналитический, ориентирован на процессы, контроль и взаимодействие с командами.",
        "focus_areas": [
            "Состояние практики FinOps и готовность данных.",
            "Backlog оптимизаций и координация команд.",
            "Поддержание прозрачности расходов здесь и сейчас."
        ],
        "opening_templates": [
            "Оперативный статус: расходы {monthly_spend} ₽/мес, экономия {savings} ₽, данные готовы на {data_quality}%.",
            "FinOps команда фиксирует {monthly_spend} ₽/мес расходов и потенциал экономии {savings} ₽."
        ],
        "insight_prompts": [
            "Опиши текущую зрелость процессов FinOps и покрытие chargeback/showback.",
            "Выдели области, где требуется усилить автоматизацию или прозрачность данных.",
            "Укажи команды/сервисы, которые нужно синхронизировать по оптимизациям."
        ],
        "risk_templates": [
            "Недостаточное покрытие тегов ограничивает прозрачность распределения затрат.",
            "Высокая концентрация расходов без владельца может замедлить принятие решений."
        ],
        "next_steps": [
            "Организовать ревью рекомендаций с инженерами и владельцами продуктов.",
            "Расширить мониторинг автоматическими проверками качества данных.",
            "Обновить FinOps playbook с учётом текущих находок и приоритетов."
        ],
    },
}


def get_snippets(role: str | None) -> Dict[str, Any]:
    """Return snippet pack for the requested persona."""

    if not role:
        return SNIPPET_LIBRARY[DEFAULT_ROLE_KEY]
    return SNIPPET_LIBRARY.get(role, SNIPPET_LIBRARY[DEFAULT_ROLE_KEY])


