"""Persona snippet library for report narratives."""

from __future__ import annotations

from typing import Any, Dict


DEFAULT_ROLE_KEY = "cfo"


SNIPPET_LIBRARY: Dict[str, Dict[str, Any]] = {
    "cfo": {
        "persona": "Финансовый директор",
        "tone": "Сдержанный, уверенный, ориентированный на цифры и влияние на P&L.",
        "focus_areas": [
            "Верхнеуровневые расходы и динамика vs план/прогноз.",
            "Потенциал экономии и окупаемость инициатив.",
            "Риски перерасхода, бюджетные отклонения и влияние на маржинальность."
        ],
        "opening_templates": [
            "Облачные расходы за период составили {monthly_spend} ₽, изменение к прошлому периоду {change_percent}%.",
            "Общая стоимость владения облаком стабилизировалась около {monthly_spend} ₽/мес; потенциал экономии — {savings} ₽."
        ],
        "insight_prompts": [
            "Выдели 2–3 ключевых драйвера расходов или отклонений, укажи влияние на бюджет.",
            "Сопоставь экономию от активных рекомендаций с целями финансового плана.",
            "Подчеркни аномалии, которые могут повлиять на cash-flow или run rate."
        ],
        "risk_templates": [
            "Рост расходов на {service} требует пересмотра лимита на Q{quarter}.",
            "Регулярные всплески по {provider} увеличивают прогнозный burn-rate."
        ],
        "next_steps": [
            "Согласовать приоритет внедрения рекомендаций с экономией более 300 тыс. ₽/мес.",
            "Проверить соответствие расходов бюджетным лимитам и обновить прогноз.",
            "Попросить FinOps команду подготовить сценарий сокращения расходов на 10%."
        ],
    },
    "cto": {
        "persona": "Технический директор / CIO",
        "tone": "Технологически ориентированный, прагматичный, акцент на стабильность и эффективность.",
        "focus_areas": [
            "Оптимизация ресурсов без риска для доступности и производительности.",
            "Портфель инициатив по модернизации и автоматизации.",
            "Аномалии, влияющие на надежность и SLO."
        ],
        "opening_templates": [
            "Текущая инфраструктурная нагрузка обходится в {monthly_spend} ₽/мес с изменением {change_percent}% за период.",
            "Основные сервисы потребляют {top_service_cost} ₽, что указывает на приоритетные площадки для оптимизации."
        ],
        "insight_prompts": [
            "Опиши топовые сервисы/кластеры, где есть потенциал оптимизации без риска деградации.",
            "Укажи технические долги (например, устаревшие инстансы, неиспользуемые ресурсы).",
            "Отметь аномалии, которые могут сигнализировать о неэффективных конфигурациях."
        ],
        "risk_templates": [
            "Скачок расходов по {service} совпадает с пиком нагрузки — стоит проверить авто-масштабирование.",
            "Высокая доля {provider} увеличивает риск vendor lock-in, стоит рассмотреть резервирование."
        ],
        "next_steps": [
            "Запустить аудит конфигураций для топ-3 сервисов по расходам.",
            "Спланировать миграцию неиспользуемых VM в более компактные типы.",
            "Настроить автоматические оповещения по всплескам >15% к среднесуточному уровню."
        ],
    },
    "product": {
        "persona": "Product / Business Owner",
        "tone": "Продуктово-ориентированный, акцент на юнит-экономику и влияние на клиента.",
        "focus_areas": [
            "Расходы по продуктовым компонентам и их вклад в себестоимость.",
            "Экономия, влияющая на маржу продукта или цену предложения.",
            "Связь изменений расходов с функциональными релизами."
        ],
        "opening_templates": [
            "Стоимость инфраструктуры продукта удерживается на уровне {monthly_spend} ₽/мес; изменение за период {change_percent}%.",
            "Основные продуктовые сервисы формируют {top_service_share}% расходов; потенциал оптимизации {savings} ₽."
        ],
        "insight_prompts": [
            "Выдели расходы, напрямую связанные с ключевыми продуктами или клиентскими сегментами.",
            "Опиши, как рекомендации могут улучшить маржинальность/ARPU.",
            "Свяжи расходы с бизнес-индикаторами: MAU, оплатившие клиенты, фичи."
        ],
        "risk_templates": [
            "Рост расходов на {service} может снизить маржинальность тарифа {plan}.",
            "Пополнение неиспользуемых ресурсов в сегменте {segment} сигнализирует о возможности чистки."
        ],
        "next_steps": [
            "Провести ревизию тарифов с учетом новых расходов.",
            "Согласовать с инженерами оптимизацию ресурсов с низкой загрузкой.",
            "Подготовить story для roadmap, чтобы укрепить FinOps-практики в продукте."
        ],
    },
    "finops": {
        "persona": "FinOps Lead",
        "tone": "Операционно-аналитический, ориентирован на процессы, контроль и взаимодействие с командами.",
        "focus_areas": [
            "Зрелость FinOps практик, покрытие chargeback/showback.",
            "Статус внедрения рекомендаций и backlog оптимизаций.",
            "Качество данных и автоматизация мониторинга."
        ],
        "opening_templates": [
            "Команда удерживает расходы на уровне {monthly_spend} ₽/мес, потенциал экономии {savings} ₽.",
            "За период выявлено {anomalies_count} аномалий, при этом инициативы закрывают {closed_recs}% от плана."
        ],
        "insight_prompts": [
            "Оцени выполнение FinOps процессов: регулярность отчетности, внедрение FinOps loop.",
            "Укажи области, где требуется усилить автоматизацию или прозрачность данных.",
            "Подсвети команды/сервисы, требующие синхронизации по оптимизациям."
        ],
        "risk_templates": [
            "Низкое покрытие chargeback по {provider} усложняет соблюдение политики затрат.",
            "Повторяющиеся всплески без инцидентов могут указывать на ручные процессы закупки."
        ],
        "next_steps": [
            "Организовать ревью рекомендаций с инженерами и владельцами продуктов.",
            "Расширить мониторинг аномалий на дополнительные метрики (CPU, трафик).",
            "Обновить FinOps playbook с учётом новых находок за период."
        ],
    },
}


def get_snippets(role: str | None) -> Dict[str, Any]:
    """Return snippet pack for the requested persona."""

    if not role:
        return SNIPPET_LIBRARY[DEFAULT_ROLE_KEY]
    return SNIPPET_LIBRARY.get(role, SNIPPET_LIBRARY[DEFAULT_ROLE_KEY])


