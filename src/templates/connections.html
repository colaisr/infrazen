{% extends "base.html" %}

{% block title %}Подключения облаков - InfraZen FinOps Platform{% endblock %}

{% block page_title %}Подключения облаков{% endblock %}
{% block page_subtitle %}Управление подключениями к облачным провайдерам{% endblock %}

{% block header_actions %}
    <div class="header-actions">
        <button class="btn btn-secondary"><i class="fa-solid fa-arrows-rotate"></i><span>Обновить все</span></button>
        <button class="btn btn-primary" onclick="showProviderModal()"><i class="fa-solid fa-plus"></i><span>Добавить провайдера</span></button>
    </div>
{% endblock %}

{% block content %}
<div class="connections-content">
    <div class="connections-summary">
        <div class="summary-stats">
            <div class="stat-item">
                <span class="stat-label">Всего подключений</span>
                <span class="stat-value">{{ providers|length }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Активных</span>
                <span class="stat-value">{{ providers|selectattr('status', 'equalto', 'connected')|list|length }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Синхронизировано</span>
                <span class="stat-value">{{ providers|selectattr('status', 'equalto', 'connected')|list|length }}</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Последняя синхронизация</span>
                <span class="stat-value">Только что</span>
            </div>
        </div>
    </div>

    {% if providers %}
    <div class="providers-grid">
        {% for provider in providers %}
        <article class="provider-card">
            <header class="provider-header">
                <div class="provider-logo">
                    {% if provider.code == 'yc' %}
                        <div class="provider-icon yandex-cloud">
                            <i class="fa-solid fa-cloud"></i>
                        </div>
                    {% elif provider.code == 'sel' %}
                        <div class="provider-icon selectel">
                            <i class="fa-solid fa-server"></i>
                        </div>
                    {% else %}
                        <div class="provider-icon default">
                            <i class="fa-solid fa-cloud"></i>
                        </div>
                    {% endif %}
                </div>
                <div class="provider-info">
                    <span class="provider-badge provider-{{ provider.code }}">{{ provider.code|upper }}</span>
                    <span class="provider-name">{{ provider.connection_name or provider.name }}</span>
                </div>
            </header>
            
            <div class="provider-connection {% if provider.status == 'connected' %}status-connected{% else %}status-disconnected{% endif %}">
                <span class="status-indicator"></span>
                {% if provider.status == 'connected' %}
                    Подключен • 
                    {% if provider.last_sync %}
                        Синхронизирован {{ provider.last_sync.strftime('%d.%m.%Y в %H:%M') }}
                    {% else %}
                        Ожидает синхронизации
                    {% endif %}
                {% else %}
                    Отключен
                {% endif %}
            </div>
            
            <div class="provider-details">
                <div class="detail-row">
                    <span class="detail-label">Добавлен:</span>
                    <span class="detail-value">{{ provider.added_at }}</span>
                </div>
                {% if provider.details %}
                    {% if provider.details.organization_id %}
                    <div class="detail-row">
                        <span class="detail-label">Организация:</span>
                        <span class="detail-value">{{ provider.details.organization_id }}</span>
                    </div>
                    {% endif %}
                    {% if provider.details.cloud_id %}
                    <div class="detail-row">
                        <span class="detail-label">Облако:</span>
                        <span class="detail-value">{{ provider.details.cloud_id }}</span>
                    </div>
                    {% endif %}
                    {% if provider.details.project_id %}
                    <div class="detail-row">
                        <span class="detail-label">Проект:</span>
                        <span class="detail-value">{{ provider.details.project_id }}</span>
                    </div>
                    {% endif %}
                    {% if provider.details.regions %}
                    <div class="detail-row">
                        <span class="detail-label">Регионы:</span>
                        <span class="detail-value">{{ provider.details.regions|join(', ') }}</span>
                    </div>
                    {% endif %}
                {% endif %}
            </div>
            
            <div class="provider-actions">
                <button class="btn btn-secondary btn-sm" title="Настройки" onclick="editConnection('{{ provider.id }}')">
                    <i class="fa-solid fa-gear"></i>
                    <span>Настройки</span>
                </button>
                <button class="btn btn-primary btn-sm" title="Синхронизировать" onclick="syncConnection('{{ provider.id }}')">
                    <i class="fa-solid fa-sync"></i>
                    <span>Синхронизировать</span>
                </button>
                <button class="btn btn-danger btn-sm" title="Удалить" onclick="deleteConnection('{{ provider.id }}')">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
        </article>
        {% endfor %}

        <article class="provider-card add-card" id="add-provider-card">
            <div class="add-icon"><i class="fa-solid fa-plus"></i></div>
            <h3>Добавить провайдера</h3>
            <p>Настроить подключение нового облачного провайдера</p>
            <button class="btn btn-primary btn-sm" onclick="showProviderModal()">Настроить подключение</button>
        </article>
    </div>

    <div class="available-providers">
        <h3>Доступные провайдеры</h3>
        <div class="providers-list">
            <div class="provider-option">
                <div class="provider-logo">
                    <div class="provider-icon aws">
                        <i class="fa-brands fa-aws"></i>
                    </div>
                </div>
                <div class="provider-info">
                    <span class="provider-name">Amazon Web Services</span>
                    <span class="provider-description">AWS API Integration</span>
                </div>
                {% if not is_demo_user %}
                <button class="btn btn-outline btn-sm" onclick="showProviderModal('aws')">Добавить</button>
                {% else %}
                <button class="btn btn-outline btn-sm" disabled title="Войдите в систему для создания подключений">Добавить</button>
                {% endif %}
            </div>
            <div class="provider-option">
                <div class="provider-logo">
                    <div class="provider-icon azure">
                        <i class="fa-brands fa-microsoft"></i>
                    </div>
                </div>
                <div class="provider-info">
                    <span class="provider-name">Microsoft Azure</span>
                    <span class="provider-description">Azure Resource Manager</span>
                </div>
                {% if not is_demo_user %}
                <button class="btn btn-outline btn-sm" onclick="showProviderModal('azure')">Добавить</button>
                {% else %}
                <button class="btn btn-outline btn-sm" disabled title="Войдите в систему для создания подключений">Добавить</button>
                {% endif %}
            </div>
            <div class="provider-option">
                <div class="provider-logo">
                    <div class="provider-icon gcp">
                        <i class="fa-brands fa-google"></i>
                    </div>
                </div>
                <div class="provider-info">
                    <span class="provider-name">Google Cloud Platform</span>
                    <span class="provider-description">GCP API Integration</span>
                </div>
                {% if not is_demo_user %}
                <button class="btn btn-outline btn-sm" onclick="showProviderModal('gcp')">Добавить</button>
                {% else %}
                <button class="btn btn-outline btn-sm" disabled title="Войдите в систему для создания подключений">Добавить</button>
                {% endif %}
            </div>
            <div class="provider-option">
                <div class="provider-logo">
                    <div class="provider-icon vk-cloud">
                        <i class="fa-solid fa-cloud"></i>
                    </div>
                </div>
                <div class="provider-info">
                    <span class="provider-name">VK Cloud</span>
                    <span class="provider-description">VK Cloud API</span>
                </div>
                {% if not is_demo_user %}
                <button class="btn btn-outline btn-sm" onclick="showProviderModal('vk-cloud')">Добавить</button>
                {% else %}
                <button class="btn btn-outline btn-sm" disabled title="Войдите в систему для создания подключений">Добавить</button>
                {% endif %}
            </div>
            <div class="provider-option">
                <div class="provider-logo">
                    <div class="provider-icon beget">
                        <i class="fa-solid fa-server"></i>
                    </div>
                </div>
                <div class="provider-info">
                    <span class="provider-name">Beget</span>
                    <span class="provider-description">Хостинг и домены</span>
                </div>
                {% if not is_demo_user %}
                <button class="btn btn-outline btn-sm" onclick="showProviderModal('beget')">Добавить</button>
                {% else %}
                <button class="btn btn-outline btn-sm" disabled title="Войдите в систему для создания подключений">Добавить</button>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-state-icon"><i class="fa-solid fa-cloud"></i></div>
        <div class="empty-state-title">Нет подключений</div>
        <div class="empty-state-text">Добавьте облачных провайдеров для начала работы</div>
        <button class="btn btn-primary">Добавить первого провайдера</button>
    </div>
    {% endif %}
</div>

<style>
.connections-content {
    padding: 0;
}

.connections-summary {
    background: var(--background-white);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.summary-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.stat-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.stat-label {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.stat-value {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
}

.providers-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.provider-card {
    background: var(--background-white);
    border: 1px solid var(--border-light);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.2s;
}

.provider-card:hover {
    border-color: var(--primary-blue);
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
}

.provider-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.provider-logo {
    flex-shrink: 0;
}

.provider-icon {
    width: 48px;
    height: 48px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.provider-icon.yandex-cloud {
    background: rgba(255, 193, 7, 0.1);
    color: #b45309;
}

.provider-icon.selectel {
    background: rgba(59, 130, 246, 0.1);
    color: #1e40af;
}

.provider-icon.aws {
    background: rgba(255, 153, 0, 0.1);
    color: #ff9900;
}

.provider-icon.azure {
    background: rgba(0, 120, 212, 0.1);
    color: #0078d4;
}

.provider-icon.gcp {
    background: rgba(66, 133, 244, 0.1);
    color: #4285f4;
}

.provider-icon.vk-cloud {
    background: rgba(76, 175, 80, 0.1);
    color: #4caf50;
}

.provider-icon.beget {
    background: rgba(139, 69, 19, 0.1);
    color: #8b4513;
}

.provider-icon.default {
    background: var(--background-light);
    color: var(--text-secondary);
}

.provider-info {
    flex: 1;
    min-width: 0;
}

.provider-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 500;
    text-transform: uppercase;
    margin-bottom: 0.25rem;
    display: inline-block;
}

.provider-yc {
    background: rgba(255, 193, 7, 0.1);
    color: #b45309;
}

.provider-sel {
    background: rgba(59, 130, 246, 0.1);
    color: #1e40af;
}

.provider-name {
    font-weight: 600;
    color: var(--text-primary);
    font-size: 1.125rem;
}

.provider-connection {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-size: 0.875rem;
}

.status-indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
}

.status-connected .status-indicator {
    background: var(--success-green);
}

.status-disconnected .status-indicator {
    background: var(--error-red);
}

.status-connected {
    color: var(--success-green);
}

.status-disconnected {
    color: var(--error-red);
}

.provider-details {
    margin-bottom: 1rem;
}

.detail-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
}

.detail-label {
    color: var(--text-secondary);
}

.detail-value {
    color: var(--text-primary);
    font-family: monospace;
    font-size: 0.75rem;
}

.provider-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.875rem;
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--border-light);
    color: var(--text-secondary);
}

.btn-outline:hover {
    background: var(--background-light);
    color: var(--text-primary);
}

.add-card {
    border: 2px dashed var(--border-light);
    text-align: center;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 280px;
}

.add-card:hover {
    border-color: var(--primary-blue);
    background: rgba(59, 130, 246, 0.02);
}

.add-icon {
    width: 64px;
    height: 64px;
    background: var(--background-light);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
}

.add-card h3 {
    margin: 0 0 0.5rem 0;
    color: var(--text-primary);
}

.add-card p {
    margin: 0 0 1.5rem 0;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.available-providers {
    background: var(--background-white);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    padding: 1.5rem;
}

.available-providers h3 {
    margin: 0 0 1rem 0;
    color: var(--text-primary);
}

.providers-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.provider-option {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border: 1px solid var(--border-light);
    border-radius: 8px;
    transition: all 0.2s;
}

.provider-option:hover {
    border-color: var(--primary-blue);
    background: rgba(59, 130, 246, 0.02);
}

.provider-option .provider-info {
    flex: 1;
}

.provider-option .provider-name {
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 0.25rem;
    display: block;
}

.provider-option .provider-description {
    font-size: 0.875rem;
    color: var(--text-secondary);
}

.provider-option .provider-icon {
    width: 40px;
    height: 40px;
    font-size: 1.25rem;
}

/* Modal styles */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
    background-color: var(--background-white);
    margin: 5% auto;
    padding: 0;
    border: none;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-light);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    margin: 0;
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--text-primary);
}

.modal-close {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s;
}

.modal-close:hover {
    background: var(--background-light);
    color: var(--text-primary);
}

.modal-body {
    padding: 1.5rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: var(--text-primary);
}

.form-control {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    font-size: 0.875rem;
    transition: border-color 0.2s;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--border-light);
    border-radius: 6px;
    font-size: 0.875rem;
    background-color: var(--background-white);
    cursor: pointer;
}

.form-check {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.form-check-input {
    width: 16px;
    height: 16px;
    margin: 0;
}

.form-check-label {
    font-size: 0.875rem;
    color: var(--text-primary);
    cursor: pointer;
}

.form-textarea {
    resize: vertical;
    min-height: 80px;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border-light);
    display: flex;
    gap: 0.75rem;
    justify-content: flex-end;
}

.btn-lg {
    padding: 0.875rem 1.5rem;
    font-size: 1rem;
}

.provider-info-card {
    background: var(--background-light);
    border: 1px solid var(--border-light);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.provider-info-card h4 {
    margin: 0 0 0.5rem 0;
    font-size: 1rem;
    color: var(--text-primary);
}

.provider-info-card p {
    margin: 0;
    font-size: 0.875rem;
    color: var(--text-secondary);
    line-height: 1.4;
}

.connection-test {
    background: var(--success-green);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    font-size: 0.875rem;
    margin-bottom: 1rem;
    display: none;
}

.connection-test.error {
    background: var(--error-red);
}

/* Password Toggle Styles */
.password-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
}

.password-input-wrapper .form-control {
    padding-right: 3rem;
}

.password-toggle {
    position: absolute;
    right: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 0.25rem;
    transition: color 0.2s ease;
}

.password-toggle:hover {
    color: var(--primary-blue);
}

.password-toggle:focus {
    outline: 2px solid var(--primary-blue);
    outline-offset: 2px;
}
</style>

<!-- Provider Connection Modal -->
<div id="providerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fa-solid fa-cloud" style="color: #1E40AF; margin-right: 0.5rem;"></i>
                Подключение облачного провайдера
            </h3>
            <button class="modal-close" onclick="closeProviderModal()">&times;</button>
        </div>
        <div class="modal-body">
            <!-- Provider Selection -->
            <div class="form-group">
                <label class="form-label" for="provider_select">Выберите провайдера *</label>
                <select class="form-select" id="provider_select" onchange="changeProvider()" required>
                    <option value="">-- Выберите провайдера --</option>
                    <option value="yandex">Yandex Cloud</option>
                    <option value="selectel">Selectel</option>
                    <option value="beget">Beget</option>
                    <option value="aws">Amazon Web Services</option>
                    <option value="azure">Microsoft Azure</option>
                    <option value="gcp">Google Cloud Platform</option>
                    <option value="vk-cloud">VK Cloud</option>
                </select>
            </div>

            <div class="provider-info-card" id="providerInfo" style="display: none;">
                <h4>Информация о провайдере</h4>
                <p id="providerDescription"></p>
            </div>
            
            <div class="connection-test" id="connectionTest" style="display: none;"></div>
            
            <form id="providerForm" method="POST" action="/connections/add">
                <input type="hidden" id="selected_provider" name="provider" value="">
                
                <!-- Common fields -->
                <div class="form-group">
                    <label class="form-label" for="connection_name">Название подключения *</label>
                    <input type="text" class="form-control" id="connection_name" name="connection_name" 
                           placeholder="Мой аккаунт" required>
                </div>
                
                <!-- Dynamic provider-specific fields -->
                <div id="providerFields"></div>
                
                <!-- Common settings -->
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="auto_sync" name="auto_sync" checked>
                        <label class="form-check-label" for="auto_sync">Автоматическая синхронизация</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="sync_interval">Интервал синхронизации</label>
                    <select class="form-select" id="sync_interval" name="sync_interval">
                        <option value="hourly">Каждый час</option>
                        <option value="daily" selected>Ежедневно</option>
                        <option value="weekly">Еженедельно</option>
                        <option value="manual">Только вручную</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="enable_notifications" name="enable_notifications" checked>
                        <label class="form-check-label" for="enable_notifications">Уведомления о изменениях</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="description">Описание</label>
                    <textarea class="form-control form-textarea" id="description" name="description" 
                              placeholder="Дополнительная информация о подключении..."></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeProviderModal()">Отмена</button>
            <button type="button" class="btn btn-outline-secondary" onclick="testConnection()" style="display: none;" id="testBtn">Тест подключения</button>
            <button type="submit" form="providerForm" class="btn btn-primary btn-lg" style="display: none;" id="connectBtn">Подключить</button>
        </div>
    </div>
</div>

<script>
// Provider configurations
const providers = {
    yandex: {
        name: 'Yandex Cloud',
        description: 'Yandex Cloud — российская облачная платформа, предоставляющая услуги виртуальных машин, баз данных, хранилищ и других облачных сервисов.',
        fields: [
            { name: 'access_key', label: 'Access Key ID *', type: 'text', placeholder: 'AQVN...', required: true },
            { name: 'secret_key', label: 'Secret Access Key *', type: 'password', placeholder: '••••••••', required: true },
            { name: 'organization_id', label: 'Organization ID *', type: 'text', placeholder: 'org-1234567890', required: true },
            { name: 'cloud_id', label: 'Cloud ID *', type: 'text', placeholder: 'b1g1234567890', required: true }
        ]
    },
    selectel: {
        name: 'Selectel',
        description: 'Selectel — российский провайдер облачных услуг, специализирующийся на виртуальных серверах, облачных вычислениях и хостинге.',
        fields: [
            { name: 'api_key', label: 'API Key *', type: 'text', placeholder: 'sk_...', required: true },
            { name: 'project_id', label: 'Project ID *', type: 'text', placeholder: 'proj_1234567890', required: true }
        ]
    },
    beget: {
        name: 'Beget',
        description: 'Beget — российский хостинг-провайдер, предоставляющий услуги веб-хостинга, регистрации доменов и виртуальных серверов.',
        fields: [
            { name: 'username', label: 'Имя пользователя *', type: 'text', placeholder: 'your_beget_username', required: true },
            { name: 'password', label: 'Пароль *', type: 'password', placeholder: '••••••••', required: true },
            { name: 'api_url', label: 'API URL', type: 'url', placeholder: 'https://api.beget.com', required: false, default: 'https://api.beget.com' }
        ]
    },
    aws: {
        name: 'Amazon Web Services',
        description: 'Amazon Web Services — ведущая облачная платформа, предоставляющая широкий спектр облачных сервисов и решений.',
        fields: [
            { name: 'access_key_id', label: 'Access Key ID *', type: 'text', placeholder: 'AKIA...', required: true },
            { name: 'secret_access_key', label: 'Secret Access Key *', type: 'password', placeholder: '••••••••', required: true },
            { name: 'region', label: 'Region *', type: 'text', placeholder: 'us-east-1', required: true }
        ]
    },
    azure: {
        name: 'Microsoft Azure',
        description: 'Microsoft Azure — облачная платформа Microsoft, предоставляющая услуги для разработки, тестирования, развертывания и управления приложениями.',
        fields: [
            { name: 'client_id', label: 'Client ID *', type: 'text', placeholder: '12345678-1234-1234-1234-123456789012', required: true },
            { name: 'client_secret', label: 'Client Secret *', type: 'password', placeholder: '••••••••', required: true },
            { name: 'tenant_id', label: 'Tenant ID *', type: 'text', placeholder: '12345678-1234-1234-1234-123456789012', required: true },
            { name: 'subscription_id', label: 'Subscription ID *', type: 'text', placeholder: '12345678-1234-1234-1234-123456789012', required: true }
        ]
    },
    gcp: {
        name: 'Google Cloud Platform',
        description: 'Google Cloud Platform — облачная платформа Google, предоставляющая услуги вычислений, хранения данных и машинного обучения.',
        fields: [
            { name: 'service_account_key', label: 'Service Account Key *', type: 'textarea', placeholder: 'JSON ключ сервисного аккаунта', required: true },
            { name: 'project_id', label: 'Project ID *', type: 'text', placeholder: 'my-gcp-project', required: true }
        ]
    },
    'vk-cloud': {
        name: 'VK Cloud',
        description: 'VK Cloud — российская облачная платформа, предоставляющая услуги виртуальных машин, баз данных и других облачных сервисов.',
        fields: [
            { name: 'access_key', label: 'Access Key *', type: 'text', placeholder: 'vk_access_key', required: true },
            { name: 'secret_key', label: 'Secret Key *', type: 'password', placeholder: '••••••••', required: true },
            { name: 'project_id', label: 'Project ID *', type: 'text', placeholder: 'vk_project_id', required: true }
        ]
    }
};

function showProviderModal(selectedProvider = null) {
    document.getElementById('providerModal').style.display = 'block';
    
    // Reset modal to add mode
    resetModalToAddMode();
    
    // If a provider is specified, pre-select it
    if (selectedProvider) {
        const providerSelect = document.getElementById('provider_select');
        providerSelect.value = selectedProvider;
        changeProvider(); // Trigger the change to show provider-specific fields
    }
}

function showProviderModalForEdit(connectionData) {
    document.getElementById('providerModal').style.display = 'block';
    
    // Set modal to edit mode
    setModalToEditMode(connectionData);
    
    // Pre-select provider and fill fields
    const providerSelect = document.getElementById('provider_select');
    providerSelect.value = connectionData.provider;
    changeProvider(); // Trigger the change to show provider-specific fields
    
    // Fill in the existing data
    setTimeout(() => {
        fillEditForm(connectionData);
    }, 100);
}

function resetModalToAddMode() {
    // Reset form fields
    document.getElementById('providerForm').reset();
    
    // Update modal title and button text
    document.querySelector('.modal-title').innerHTML = 
        '<i class="fa-solid fa-cloud" style="color: #1E40AF; margin-right: 0.5rem;"></i>Подключение облачного провайдера';
    
    const connectBtn = document.getElementById('connectBtn');
    connectBtn.innerHTML = 'Подключить';
    connectBtn.style.display = 'none';
    
    const testBtn = document.getElementById('testBtn');
    testBtn.style.display = 'none';
    
    // Hide provider info and connection test sections
    document.getElementById('providerInfo').style.display = 'none';
    document.getElementById('connectionTest').style.display = 'none';
    
    // Remove hidden edit ID field if it exists
    const existingEditId = document.getElementById('edit_connection_id');
    if (existingEditId) {
        existingEditId.remove();
    }
}

function setModalToEditMode(connectionData) {
    // Update modal title
    document.querySelector('.modal-title').innerHTML = 
        '<i class="fa-solid fa-edit" style="color: #1E40AF; margin-right: 0.5rem;"></i>Редактирование подключения';
    
    // Update button text
    const connectBtn = document.getElementById('connectBtn');
    connectBtn.innerHTML = 'Сохранить изменения';
    connectBtn.style.display = 'none';
    
    // Ensure test button is visible
    const testBtn = document.getElementById('testBtn');
    testBtn.style.display = 'inline-block';
    
    // Add hidden field for edit ID
    const form = document.getElementById('providerForm');
    let editIdField = document.getElementById('edit_connection_id');
    if (!editIdField) {
        editIdField = document.createElement('input');
        editIdField.type = 'hidden';
        editIdField.id = 'edit_connection_id';
        editIdField.name = 'edit_connection_id';
        form.appendChild(editIdField);
    }
    editIdField.value = connectionData.id;
}

function fillEditForm(connectionData) {
    // Fill basic fields
    document.getElementById('connection_name').value = connectionData.connection_name || '';
    document.getElementById('description').value = connectionData.description || '';
    
    // Fill provider-specific fields
    const provider = connectionData.provider;
    if (provider === 'beget') {
        const usernameField = document.querySelector('input[name="username"]');
        const apiUrlField = document.querySelector('input[name="api_url"]');
        
        if (usernameField) usernameField.value = connectionData.username || '';
        if (apiUrlField) apiUrlField.value = connectionData.api_url || 'https://api.beget.com';
        
        // Fill password for testing purposes
        const passwordField = document.querySelector('input[name="password"]');
        if (passwordField) {
            passwordField.value = connectionData.password || '';
            passwordField.placeholder = 'Введите новый пароль (оставьте пустым, чтобы не менять)';
        }
    }
    
    // Show provider info and connection test sections
    document.getElementById('providerInfo').style.display = 'block';
    document.getElementById('connectionTest').style.display = 'block';
    
    // Show buttons
    document.getElementById('testBtn').style.display = 'inline-block';
    document.getElementById('connectBtn').style.display = 'inline-block';
}

function closeProviderModal() {
    document.getElementById('providerModal').style.display = 'none';
    document.getElementById('connectionTest').style.display = 'none';
    document.getElementById('providerInfo').style.display = 'none';
    document.getElementById('testBtn').style.display = 'none';
    document.getElementById('connectBtn').style.display = 'none';
    // Reset form
    document.getElementById('provider_select').value = '';
    document.getElementById('providerFields').innerHTML = '';
}

function changeProvider() {
    const selectedProvider = document.getElementById('provider_select').value;
    const providerInfo = document.getElementById('providerInfo');
    const providerDescription = document.getElementById('providerDescription');
    const providerFields = document.getElementById('providerFields');
    const testBtn = document.getElementById('testBtn');
    const connectBtn = document.getElementById('connectBtn');
    const selectedProviderInput = document.getElementById('selected_provider');
    
    if (selectedProvider && providers[selectedProvider]) {
        const provider = providers[selectedProvider];
        
        // Show provider info
        providerDescription.textContent = provider.description;
        providerInfo.style.display = 'block';
        
        // Set hidden field
        selectedProviderInput.value = selectedProvider;
        
        // Generate dynamic fields
        providerFields.innerHTML = '';
        provider.fields.forEach(field => {
            const fieldHtml = createFieldHtml(field);
            providerFields.innerHTML += fieldHtml;
        });
        
        // Show buttons
        testBtn.style.display = 'inline-block';
        connectBtn.style.display = 'inline-block';
        
        // Check if we're in edit mode
        const editIdField = document.getElementById('edit_connection_id');
        if (editIdField && editIdField.value) {
            connectBtn.textContent = 'Сохранить изменения';
        } else {
            connectBtn.textContent = `Подключить ${provider.name}`;
        }
        
    } else {
        // Hide everything
        providerInfo.style.display = 'none';
        providerFields.innerHTML = '';
        testBtn.style.display = 'none';
        connectBtn.style.display = 'none';
    }
}

function createFieldHtml(field) {
    const required = field.required ? 'required' : '';
    const placeholder = field.placeholder || '';
    const defaultValue = field.default ? `value="${field.default}"` : '';
    
    if (field.type === 'textarea') {
        return `
            <div class="form-group">
                <label class="form-label" for="${field.name}">${field.label}</label>
                <textarea class="form-control form-textarea" id="${field.name}" name="${field.name}" 
                          placeholder="${placeholder}" ${required}>${field.default || ''}</textarea>
            </div>
        `;
    } else if (field.type === 'password') {
        return `
            <div class="form-group">
                <label class="form-label" for="${field.name}">${field.label}</label>
                <div class="password-input-wrapper">
                    <input type="password" class="form-control" id="${field.name}" name="${field.name}" 
                           placeholder="${placeholder}" ${defaultValue} ${required}>
                    <button type="button" class="password-toggle" onclick="togglePasswordVisibility('${field.name}')">
                        <i class="fa-solid fa-eye" id="eye-${field.name}"></i>
                    </button>
                </div>
            </div>
        `;
    } else {
        return `
            <div class="form-group">
                <label class="form-label" for="${field.name}">${field.label}</label>
                <input type="${field.type}" class="form-control" id="${field.name}" name="${field.name}" 
                       placeholder="${placeholder}" ${defaultValue} ${required}>
            </div>
        `;
    }
}

function testConnection() {
    const selectedProvider = document.getElementById('provider_select').value;
    const testDiv = document.getElementById('connectionTest');
    
    if (!selectedProvider) {
        showTestResult('Выберите провайдера', 'error');
        return;
    }
    
    // Collect form data
    const formData = {};
    const provider = providers[selectedProvider];
    
    provider.fields.forEach(field => {
        const element = document.getElementById(field.name);
        if (element) {
            formData[field.name] = element.value;
        }
    });
    
    // Validate required fields
    for (const field of provider.fields) {
        if (field.required && !formData[field.name]) {
            showTestResult(`Заполните поле: ${field.label}`, 'error');
            return;
        }
    }
    
    showTestResult('Тестирование подключения...', 'info');
    
    // Test connection based on provider
    fetch(`/api/connections/test`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            provider: selectedProvider,
            credentials: formData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message with real user info
            let message = '✅ Подключение успешно установлено!';
            
            // Use real account info if available
            if (data.account_info) {
                const account = data.account_info;
                const username = account.customer_login || account.username || 'Unknown';
                const customerId = account.customer_id || '';
                
                if (customerId) {
                    message = `✅ Подключение успешно! Пользователь: ${username} (ID: ${customerId})`;
                } else {
                    message = `✅ Подключение успешно! Пользователь: ${username}`;
                }
            }
            
            showTestResult(message, 'success');
        } else {
            let errorMessage = '❌ ' + (data.error || 'Ошибка подключения');
            
            // Add helpful information for authentication errors
            if (data.error && data.error.includes('Authentication failed')) {
                errorMessage += '<br><br><strong>Возможные причины:</strong><br>• Проверьте правильность имени пользователя и пароля<br>• Убедитесь, что API доступ включен в панели управления Beget<br>• Используйте пароль API, а не пароль от аккаунта';
            }
            
            showTestResult(errorMessage, 'error');
        }
    })
    .catch(error => {
        showTestResult('❌ Ошибка тестирования подключения', 'error');
        console.error('Connection test error:', error);
    });
}

function showTestResult(message, type) {
    const testDiv = document.getElementById('connectionTest');
    testDiv.textContent = message;
    testDiv.className = 'connection-test';
    if (type === 'success') {
        testDiv.style.background = 'var(--success-green)';
    } else if (type === 'error') {
        testDiv.style.background = 'var(--error-red)';
    } else {
        testDiv.style.background = 'var(--warning-orange)';
    }
    testDiv.style.display = 'block';
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('providerModal');
    if (event.target === modal) {
        closeProviderModal();
    }
}

// Connection management functions
function editConnection(connectionId) {
    // Extract numeric ID from string like "beget-2" -> "2"
    const numericId = connectionId.includes('-') ? connectionId.split('-')[1] : connectionId;
    
    // Show loading state
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i><span>Загрузка...</span>';
    button.disabled = true;
    
    // Fetch connection details
    fetch(`/api/connections/${numericId}/edit`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Open modal in edit mode
                showProviderModalForEdit(data.data);
            } else {
                showFlashMessage('❌ Ошибка загрузки данных: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showFlashMessage('❌ Ошибка загрузки данных', 'error');
            console.error('Edit error:', error);
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
}

function syncConnection(connectionId) {
    // Extract numeric ID from string like "beget-2" -> "2"
    const numericId = connectionId.includes('-') ? connectionId.split('-')[1] : connectionId;
    
    // Show loading state
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i><span>Синхронизация...</span>';
    button.disabled = true;
    
    // Make sync request
    fetch(`/api/connections/${numericId}/sync`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showFlashMessage('✅ Синхронизация завершена успешно!', 'success');
            // Reload page to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showFlashMessage('❌ Ошибка синхронизации: ' + data.error, 'error');
        }
    })
    .catch(error => {
        showFlashMessage('❌ Ошибка синхронизации', 'error');
        console.error('Sync error:', error);
    })
    .finally(() => {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

function deleteConnection(connectionId) {
    if (confirm('Вы уверены, что хотите удалить это подключение?\n\nЭто действие нельзя отменить.')) {
        // Extract numeric ID from string like "beget-2" -> "2"
        const numericId = connectionId.includes('-') ? connectionId.split('-')[1] : connectionId;
        
        // Show loading state
        const button = event.target.closest('button');
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        // Make delete request
        fetch(`/api/connections/${numericId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showFlashMessage('✅ Подключение удалено успешно!', 'success');
                // Remove the card from DOM
                const card = button.closest('.provider-card');
                card.style.opacity = '0.5';
                setTimeout(() => {
                    card.remove();
                }, 500);
            } else {
                showFlashMessage('❌ Ошибка удаления: ' + data.error, 'error');
            }
        })
        .catch(error => {
            showFlashMessage('❌ Ошибка удаления', 'error');
            console.error('Delete error:', error);
        })
        .finally(() => {
            // Restore button state
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

function showFlashMessage(message, type) {
    // Create flash message element
    const flashDiv = document.createElement('div');
    flashDiv.className = `flash-message flash-${type}`;
    flashDiv.innerHTML = `
        <i class="fa-solid fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
        <button class="flash-close" onclick="this.parentElement.remove()">&times;</button>
    `;
    
    // Add to flash messages container
    let container = document.querySelector('.flash-messages');
    if (!container) {
        container = document.createElement('div');
        container.className = 'flash-messages';
        document.body.appendChild(container);
    }
    
    container.appendChild(flashDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (flashDiv.parentElement) {
            flashDiv.remove();
        }
    }, 5000);
}

function togglePasswordVisibility(fieldName) {
    const passwordField = document.getElementById(fieldName);
    const eyeIcon = document.getElementById(`eye-${fieldName}`);
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        eyeIcon.className = 'fa-solid fa-eye-slash';
    } else {
        passwordField.type = 'password';
        eyeIcon.className = 'fa-solid fa-eye';
    }
}
</script>
{% endblock %}
